---
title: '批量创建设备'
api: 'POST /manufacturing-create-devices'
---

## 接���说明

工厂批量创建IoT设备，生成AWS IoT Thing、证书和激活码。支持创建网关设备和子设备。仅管理员可访问。

## 请求参数

<ParamField body="device_type" type="string" required>
  设备类型
  - `gateway`: 网关设备
  - `vibration_sensor`: 震动检测传感器
  - `smart_trap`: 智能捕鼠器
  - `temp_humidity_sensor`: 温湿度传感器
  - `pir_sensor`: 红外人体传感器
</ParamField>

<ParamField body="model" type="string" required>
  设备型号，例如:
  - 网关: `RT-Gateway-Pro`
  - 捕鼠器: `SmartTrap-v2`
  - 传感器: `VibSensor-v1`
</ParamField>

<ParamField body="count" type="number" required>
  批量创建数量，范围: 1-100
</ParamField>

<ParamField body="prefix" type="string">
  设备名称前缀，默认使用型号。

  例如:
  - `GATEWAY` 生成 `GATEWAY:001`, `GATEWAY:002`...
  - `TRAP` 生成 `TRAP:001`, `TRAP:002`...
  - `SENSOR` 生成 `SENSOR:001`, `SENSOR:002`...
</ParamField>

<ParamField body="batch_name" type="string">
  批次名称，用于标识这批设备
</ParamField>

<ParamField body="gateway_thing_name" type="string">
  父网关Thing名称（仅子设备需要）

  创建子设备时必须指定其所属的网关，例如: `GATEWAY:001`
</ParamField>

## 响应数据

<ResponseField name="batch_id" type="string">
  批次ID，格式: `batch_{timestamp}`
</ResponseField>

<ResponseField name="model" type="string">
  设备型号
</ResponseField>

<ResponseField name="created_count" type="number">
  成功创建的设备数量
</ResponseField>

<ResponseField name="devices" type="array">
  设备列表，包含以下字段：

  <Expandable title="Device 对象">
    <ResponseField name="thing_name" type="string">
      AWS IoT Thing名称，例如: `GATEWAY:001`, `TRAP:001`
    </ResponseField>

    <ResponseField name="device_type" type="string">
      设备类型: `gateway` | `vibration_sensor` | `smart_trap` | `temp_humidity_sensor` | `pir_sensor`
    </ResponseField>

    <ResponseField name="activation_code" type="string">
      激活码，格式: `{MODEL}-{8位HEX}`，例如: `GATEWAY-A3F2B1C9`
    </ResponseField>

    <ResponseField name="gateway_thing_name" type="string">
      父网关Thing名称（仅子设备有此字段）
    </ResponseField>

    <ResponseField name="certificate_pem" type="string">
      设备证书（PEM格式）
    </ResponseField>

    <ResponseField name="private_key" type="string">
      设备私钥（PEM格式）⚠️ **仅此次返回，不会再次提供**
    </ResponseField>

    <ResponseField name="iot_endpoint" type="string">
      AWS IoT Core端点地址
    </ResponseField>

    <ResponseField name="certificate_id" type="string">
      AWS证书ID
    </ResponseField>

    <ResponseField name="certificate_arn" type="string">
      AWS证书ARN
    </ResponseField>
  </Expandable>
</ResponseField>

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | 缺少或无效的认证Token |
| `PERMISSION_DENIED` | 403 | 非管理员用户无权访问 |
| `INVALID_PARAMETERS` | 400 | 参数验证失败（count超出范围等） |
| `INVALID_DEVICE_TYPE` | 400 | 无效的设备类型 |
| `GATEWAY_NOT_FOUND` | 404 | 创建子设备时，指定的网关不存在 |
| `AWS_IOT_ERROR` | 500 | AWS IoT服务调用失败 |
| `DATABASE_ERROR` | 500 | 数据库操作失败 |

<RequestExample>
```bash cURL - 创建网关设备
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "gateway",
    "model": "RT-Gateway-Pro",
    "count": 10,
    "prefix": "GATEWAY",
    "batch_name": "Gateway Production Batch 2024-Q1"
  }'
```

```bash cURL - 创建智能捕鼠器
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "smart_trap",
    "model": "SmartTrap-v2",
    "count": 50,
    "prefix": "TRAP",
    "gateway_thing_name": "GATEWAY:001",
    "batch_name": "Smart Trap Batch 2024-Q1"
  }'
```

```bash cURL - 创建震动传感器
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "vibration_sensor",
    "model": "VibSensor-v1",
    "count": 30,
    "prefix": "VIBSENSOR",
    "gateway_thing_name": "GATEWAY:001",
    "batch_name": "Vibration Sensor Batch 2024-Q1"
  }'
```

```javascript Node.js
// 创建网关设备
const gatewayResponse = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_type: 'gateway',
      model: 'RT-Gateway-Pro',
      count: 10,
      prefix: 'GATEWAY',
      batch_name: 'Gateway Production Batch 2024-Q1'
    })
  }
);

const gatewayData = await gatewayResponse.json();
console.log(`Created ${gatewayData.created_count} gateways in batch ${gatewayData.batch_id}`);

// 创建子设备（智能捕鼠器）
const trapResponse = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_type: 'smart_trap',
      model: 'SmartTrap-v2',
      count: 50,
      prefix: 'TRAP',
      gateway_thing_name: 'GATEWAY:001',
      batch_name: 'Smart Trap Batch 2024-Q1'
    })
  }
);

const trapData = await trapResponse.json();
console.log(`Created ${trapData.created_count} smart traps`);
```

```python Python
import requests

# 创建网关设备
gateway_response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
    headers={
        'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
        'Content-Type': 'application/json'
    },
    json={
        'device_type': 'gateway',
        'model': 'RT-Gateway-Pro',
        'count': 10,
        'prefix': 'GATEWAY',
        'batch_name': 'Gateway Production Batch 2024-Q1'
    }
)

gateway_data = gateway_response.json()
print(f"Created {gateway_data['created_count']} gateways")

# 创建子设备（温湿度传感器）
sensor_response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
    headers={
        'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
        'Content-Type': 'application/json'
    },
    json={
        'device_type': 'temp_humidity_sensor',
        'model': 'TempHum-v1',
        'count': 30,
        'prefix': 'TEMPSENSOR',
        'gateway_thing_name': 'GATEWAY:001',
        'batch_name': 'Temp Sensor Batch 2024-Q1'
    }
)

sensor_data = sensor_response.json()
print(f"Created {sensor_data['created_count']} temperature sensors")
```
</RequestExample>

<ResponseExample>
```json 成功响应 - 创建网关设备
{
  "batch_id": "batch_1702900000",
  "model": "RT-Gateway-Pro",
  "device_type": "gateway",
  "created_count": 10,
  "devices": [
    {
      "thing_name": "GATEWAY:001",
      "device_type": "gateway",
      "activation_code": "GATEWAY-A3F2B1C9",
      "certificate_pem": "-----BEGIN CERTIFICATE-----\nMIIBxTCCAW...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEII...\n-----END EC PRIVATE KEY-----",
      "iot_endpoint": "a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com",
      "certificate_id": "abc123def456ghi789...",
      "certificate_arn": "arn:aws:iot:ap-southeast-1:123456789012:cert/abc123..."
    }
  ]
}
```

```json 成功响应 - 创建子设备（智能捕鼠器）
{
  "batch_id": "batch_1702900001",
  "model": "SmartTrap-v2",
  "device_type": "smart_trap",
  "created_count": 50,
  "devices": [
    {
      "thing_name": "TRAP:001",
      "device_type": "smart_trap",
      "gateway_thing_name": "GATEWAY:001",
      "activation_code": "TRAP-B5D3E2F1",
      "certificate_pem": "-----BEGIN CERTIFICATE-----\nMIIBxTCCAW...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEII...\n-----END EC PRIVATE KEY-----",
      "iot_endpoint": "a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com",
      "certificate_id": "def456ghi789jkl012...",
      "certificate_arn": "arn:aws:iot:ap-southeast-1:123456789012:cert/def456..."
    }
  ]
}
```

```json 错误响应 - 权限不足
{
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "Admin role required for device manufacturing",
    "statusCode": 403
  }
}
```

```json 错误响应 - 无效设备类型
{
  "error": {
    "code": "INVALID_DEVICE_TYPE",
    "message": "device_type must be one of: gateway, vibration_sensor, smart_trap, temp_humidity_sensor, pir_sensor",
    "statusCode": 400
  }
}
```

```json 错误响应 - 网关不存在
{
  "error": {
    "code": "GATEWAY_NOT_FOUND",
    "message": "Gateway GATEWAY:001 not found. Child devices must be created after gateway.",
    "statusCode": 404
  }
}
```

```json 错误响应 - 参数验证失败
{
  "error": {
    "code": "INVALID_PARAMETERS",
    "message": "count must be between 1 and 100",
    "statusCode": 400
  }
}
```

```json 错误响应 - AWS IoT错误
{
  "error": {
    "code": "AWS_IOT_ERROR",
    "message": "Failed to create IoT Thing: ThingAlreadyExists",
    "statusCode": 500
  }
}
```
</ResponseExample>

## 使用说明

### 权限要求
- 调用者必须拥有 **Admin** 角色
- 需要有效的 Supabase JWT Token

### 设备类型说明

系统支持以下设备类型：

| 设备类型 | device_type | 说明 | 是否需要网关 |
|---------|-------------|------|-------------|
| **网关设备** | `gateway` | 中心网关，管理子设备 | - |
| **震动检测传感器** | `vibration_sensor` | 检测震动和移动 | ✅ 需要 |
| **智能捕鼠器** | `smart_trap` | 智能捕鼠装置 | ✅ 需要 |
| **温湿度传感器** | `temp_humidity_sensor` | 监测环境温湿度 | ✅ 需要 |
| **红外人体传感器** | `pir_sensor` | 人体红外感应 | ✅ 需要 |

### 创建顺序要求

<Warning>
**重要**: 必须先创建网关设备，再创建子设备。子设备创建时必须指定 `gateway_thing_name` 参数。
</Warning>

推荐的创建流程：

<Steps>
  <Step title="1. 创建网关设备">
    先创建一批网关设备，记录生成的Thing名称（如 `GATEWAY:001`）
  </Step>

  <Step title="2. 创建子设备">
    为每个网关创建对应的子设备，指定 `gateway_thing_name` 参数
  </Step>

  <Step title="3. 烧录证书">
    将每个设备的证书和私钥烧录到对应硬件中
  </Step>

  <Step title="4. 打印激活码">
    为每个设备生成二维码标签
  </Step>
</Steps>

### 重要提示

<Warning>
**私钥安全**: `private_key` 字段仅在此接口响应中返回一次，系统不会存储。请务必安全保存并烧录到设备中。
</Warning>

<Note>
**激活码格式**: 激活码格式为 `{MODEL}-{8位HEX}`，例如 `GATEWAY-A3F2B1C9`。用户后续通过此码绑定设备。
</Note>

<Note>
**设备关联**: 子设备通过 `gateway_thing_name` 字段与网关关联。用户绑定子设备时，需要先绑定其所属的网关。
</Note>

### 操作流程

1. **验证管理员权限** - 检查JWT Token中的用户角色
2. **验证设备类型** - 检查device_type是否有效
3. **验证网关存在性** - 如果是子设备，检查指定的网关是否存在
4. **创建AWS IoT Thing** - 为每个设备创建Thing对象
5. **生成ECC P-256证书** - 使用CSR方式生成证书和私钥
6. **附加IoT Policy** - 将设备策略附加到证书
7. **生成激活码** - 创建唯一的激活码
8. **存储设备记录** - 保存到 `devices` 表，包含device_type和gateway_thing_name
9. **存储激活码** - 保存到 `device_activation_codes` 表
10. **返回凭证** - 一次性返回所有设备凭证

### 设备状态

创建后的设备状态为 `registered`，等待用户通过激活码绑定后变为 `pending`。

### 批次管理

每次调用会创建一个批次记录，可通过 `/manufacturing-batches` 接口查询批次信息。
