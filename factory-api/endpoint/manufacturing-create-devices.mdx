---
title: '批量创建设备'
api: 'POST /manufacturing-create-devices'
---

## 接口说明

工厂批量创建IoT设备，生成AWS IoT Thing、证书和激活码。支持创建网关设备和子设备。

<Note>
**工厂生产阶段**：网关和子设备**独立创建**，不需要预先关联。
**用户使用阶段**：用户绑定设备后，将子设备关联到网关使用。
</Note>

仅管理员可访问。

## 请求参数

<ParamField body="device_type" type="string" required>
  设备类型
  - `gateway`: 网关设备
  - `vibration_sensor`: 震动检测传感器
  - `smart_trap`: 智能捕鼠器
  - `temp_humidity_sensor`: 温湿度传感器
  - `pir_sensor`: 红外人体传感器
</ParamField>

<ParamField body="model" type="string" required>
  设备型号，例如:
  - 网关: `RT-Gateway-Pro`
  - 捕鼠器: `SmartTrap-v2`
  - 传感器: `VibSensor-v1`
</ParamField>

<ParamField body="count" type="number" required>
  批量创建数量，范围: 1-100
</ParamField>

<ParamField body="prefix" type="string">
  设备名称前缀，默认使用型号。

  例如:
  - `IoT-Gateway` 生成 `IoT-Gateway-000001`, `IoT-Gateway-000002`...
  - `IoT-Trap` 生成 `IoT-Trap-000001`, `IoT-Trap-000002`...
  - `IoT-Sensor` 生成 `IoT-Sensor-000001`, `IoT-Sensor-000002`...

  **自动编号规则**:
  - 系统会自动查询该型号（model）下已有设备的最大编号
  - 新设备从最大编号+1开始递增
  - 例如：型号 `RT-Gateway-Pro` 已有 000001-000010，下次创建自动从 000011 开始
</ParamField>

<ParamField body="batch_name" type="string">
  批次名称，用于标识这批设备
</ParamField>

## 响应数据

<ResponseField name="batch_id" type="string">
  批次ID，格式: `batch_{timestamp}`
</ResponseField>

<ResponseField name="model" type="string">
  设备型号
</ResponseField>

<ResponseField name="created_count" type="number">
  成功创建的设备数量
</ResponseField>

<ResponseField name="devices" type="array">
  设备列表，包含以下字段：

  <Expandable title="Device 对象">
    <ResponseField name="thing_name" type="string">
      AWS IoT Thing名称，格式: `{prefix}-{6位数字编号}`

      例如: `IoT-Gateway-000001`, `IoT-Trap-000100`
    </ResponseField>

    <ResponseField name="device_type" type="string">
      设备类型: `gateway` | `vibration_sensor` | `smart_trap` | `temp_humidity_sensor` | `pir_sensor`
    </ResponseField>

    <ResponseField name="activation_code" type="string">
      激活码，格式: `{MODEL}-{8位HEX}`，例如: `GATEWAY-A3F2B1C9`
    </ResponseField>

    <ResponseField name="certificate_pem" type="string">
      设备证书（PEM格式）
    </ResponseField>

    <ResponseField name="private_key" type="string">
      设备私钥（PEM格式）⚠️ **仅此次返回，不会再次提供**
    </ResponseField>

    <ResponseField name="iot_endpoint" type="string">
      AWS IoT Core端点地址
    </ResponseField>

    <ResponseField name="certificate_id" type="string">
      AWS证书ID
    </ResponseField>

    <ResponseField name="certificate_arn" type="string">
      AWS证书ARN
    </ResponseField>
  </Expandable>
</ResponseField>

## 凭证分发与下载

<Warning>
**私钥安全警告**: `private_key` 字段仅在此接口响应中返回一次，系统不会存储到数据库。如果在创建时未保存私钥，将无法找回，需要重新创建设备。
</Warning>

### 可重复下载的凭证

| 凭证类型 | 存储位置 | 说明 |
|---------|---------|------|
| 激活码 | `device_activation_codes` 表 | 可通过 `/manufacturing-activation-codes` 接口导出 |
| 设备证书（公钥） | `devices.metadata.certificatePem` | 存储在设备元数据中，可查询 |
| IoT 端点 | `devices.metadata.iotEndpoint` | AWS IoT Core 端点地址 |
| 根证书 | 固定内容 | Amazon Root CA 1 公开证书，随时可获取 |

### 不可重复下载的凭证

| 凭证类型 | 原因 | 影响 |
|---------|------|------|
| **私钥** | 不存储到数据库 | 仅在创建时返回一次，丢失后需重新创建设备 |

### 凭证分发方式

1. **API 响应**（创建时）
   - 在批次创建完成后，响应中包含所有设备的完整凭证
   - 必须立即保存私钥，后续无法找回

2. **ZIP 文件下载**（推荐）
   - 管理后台会自动将证书打包成 ZIP 文件
   - 文件结构：`IoT-Gateway-000001.private.key`、`IoT-Gateway-000001.cert.pem`、`AmazonRootCA1.pem`

3. **激活码导出**
   - 通过 `/manufacturing-activation-codes` 接口导出
   - 支持 JSON 或 CSV 格式
   - 可按 batch_id、model、is_used 状态过滤

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | 缺少或无效的认证Token |
| `PERMISSION_DENIED` | 403 | 非管理员用户无权访问 |
| `INVALID_PARAMETERS` | 400 | 参数验证失败（count超出范围等） |
| `INVALID_DEVICE_TYPE` | 400 | 无效的设备类型 |
| `AWS_IOT_ERROR` | 500 | AWS IoT服务调用失败 |
| `DATABASE_ERROR` | 500 | 数据库操作失败 |

<RequestExample>
```bash cURL - 创建网关设备
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "gateway",
    "model": "RT-Gateway-Pro",
    "count": 10,
    "prefix": "IoT-Gateway",
    "batch_name": "Gateway Production Batch 2024-Q1"
  }'
```

```bash cURL - 创建智能捕鼠器
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "smart_trap",
    "model": "SmartTrap-v2",
    "count": 50,
    "prefix": "IoT-Trap",
    "batch_name": "Smart Trap Batch 2024-Q1"
  }'
```

```bash cURL - 创建震动传感器
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "device_type": "vibration_sensor",
    "model": "VibSensor-v1",
    "count": 30,
    "prefix": "IoT-VibSensor",
    "batch_name": "Vibration Sensor Batch 2024-Q1"
  }'
```

```javascript Node.js
// 创建网关设备
const gatewayResponse = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_type: 'gateway',
      model: 'RT-Gateway-Pro',
      count: 10,
      prefix: 'IoT-Gateway',
      batch_name: 'Gateway Production Batch 2024-Q1'
    })
  }
);

const gatewayData = await gatewayResponse.json();
console.log(`Created ${gatewayData.created_count} gateways in batch ${gatewayData.batch_id}`);
// 设备名称: 系统自动从该型号的最大编号+1开始，例如 IoT-Gateway-000001 ~ IoT-Gateway-000010

// 创建子设备（智能捕鼠器）- 独立创建，不需要关联网关
const trapResponse = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_type: 'smart_trap',
      model: 'SmartTrap-v2',
      count: 50,
      prefix: 'IoT-Trap',
      batch_name: 'Smart Trap Batch 2024-Q1'
    })
  }
);

const trapData = await trapResponse.json();
console.log(`Created ${trapData.created_count} smart traps`);
// 设备名称: 系统自动编号，例如 IoT-Trap-000001 ~ IoT-Trap-000050
```

```python Python
import requests

# 创建网关设备
gateway_response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
    headers={
        'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
        'Content-Type': 'application/json'
    },
    json={
        'device_type': 'gateway',
        'model': 'RT-Gateway-Pro',
        'count': 10,
        'prefix': 'IoT-Gateway',
        'batch_name': 'Gateway Production Batch 2024-Q1'
    }
)

gateway_data = gateway_response.json()
print(f"Created {gateway_data['created_count']} gateways")
# 设备名称: 系统自动编号，例如 IoT-Gateway-000001 ~ IoT-Gateway-000010

# 创建子设备（温湿度传感器）- 独立创建
sensor_response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
    headers={
        'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
        'Content-Type': 'application/json'
    },
    json={
        'device_type': 'temp_humidity_sensor',
        'model': 'TempHum-v1',
        'count': 30,
        'prefix': 'IoT-TempSensor',
        'batch_name': 'Temp Sensor Batch 2024-Q1'
    }
)

sensor_data = sensor_response.json()
print(f"Created {sensor_data['created_count']} temperature sensors")
# 设备名称: 系统自动编号，例如 IoT-TempSensor-000001 ~ IoT-TempSensor-000030
```
</RequestExample>

<ResponseExample>
```json 成功响应 - 创建网关设备
{
  "batch_id": "batch_1702900000",
  "model": "RT-Gateway-Pro",
  "device_type": "gateway",
  "created_count": 10,
  "devices": [
    {
      "thing_name": "IoT-Gateway-000001",
      "device_type": "gateway",
      "activation_code": "GATEWAY-A3F2B1C9",
      "certificate_pem": "-----BEGIN CERTIFICATE-----\nMIIBxTCCAW...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEII...\n-----END EC PRIVATE KEY-----",
      "iot_endpoint": "a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com",
      "certificate_id": "abc123def456ghi789...",
      "certificate_arn": "arn:aws:iot:ap-southeast-1:123456789012:cert/abc123..."
    },
    {
      "thing_name": "IoT-Gateway-000002",
      "device_type": "gateway",
      "activation_code": "GATEWAY-B4E3F2D1",
      "certificate_pem": "-----BEGIN CERTIFICATE-----\nMIIBxTCCAW...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEII...\n-----END EC PRIVATE KEY-----",
      "iot_endpoint": "a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com",
      "certificate_id": "def456ghi789jkl012...",
      "certificate_arn": "arn:aws:iot:ap-southeast-1:123456789012:cert/def456..."
    }
  ]
}
```

```json 成功响应 - 创建子设备（智能捕鼠器）
{
  "batch_id": "batch_1702900001",
  "model": "SmartTrap-v2",
  "device_type": "smart_trap",
  "created_count": 50,
  "devices": [
    {
      "thing_name": "IoT-Trap-000001",
      "device_type": "smart_trap",
      "activation_code": "TRAP-B5D3E2F1",
      "certificate_pem": "",
      "private_key": "",
      "iot_endpoint": "",
      "certificate_id": "",
      "certificate_arn": ""
    },
    {
      "thing_name": "IoT-Trap-000002",
      "device_type": "smart_trap",
      "activation_code": "TRAP-C6E4F3D2",
      "certificate_pem": "",
      "private_key": "",
      "iot_endpoint": "",
      "certificate_id": "",
      "certificate_arn": ""
    }
  ]
}
```

<Note>
**子设备响应说明**：子设备不需要 AWS IoT 凭证（通过网关连接），因此证书相关字段返回空字符串。
</Note>


```json 错误响应 - 权限不足
{
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "Admin role required for device manufacturing",
    "statusCode": 403
  }
}
```

```json 错误响应 - 无效设备类型
{
  "error": {
    "code": "INVALID_DEVICE_TYPE",
    "message": "device_type must be one of: gateway, vibration_sensor, smart_trap, temp_humidity_sensor, pir_sensor",
    "statusCode": 400
  }
}
```

```json 错误响应 - 参数验证失败
{
  "error": {
    "code": "INVALID_PARAMETERS",
    "message": "count must be between 1 and 100",
    "statusCode": 400
  }
}
```

```json 错误响应 - AWS IoT错误
{
  "error": {
    "code": "AWS_IOT_ERROR",
    "message": "Failed to create IoT Thing: ThingAlreadyExists",
    "statusCode": 500
  }
}
```
</ResponseExample>

## 使用说明

### 权限要求
- 调用者必须拥有 **Admin** 角色
- 需要有效的 Supabase JWT Token

### 设备类型说明

系统支持以下设备类型：

| 设备类型 | device_type | 说明 | 连接方式 | 批次限制 |
|---------|-------------|------|---------|---------|
| **网关设备** | `gateway` | 中心网关，管理子设备 | WiFi/4G | 1-100 台 |
| **震动检测传感器** | `vibration_sensor` | 检测震动和移动 | 通过网关 | 见子设备接口 |
| **智能捕鼠器** | `smart_trap` | 智能捕鼠装置 | 通过网关 | 见子设备接口 |
| **温湿度传感器** | `temp_humidity_sensor` | 监测环境温湿度 | 通过网关 | 见子设备接口 |
| **红外人体传感器** | `pir_sensor` | 人体红外感应 | 通过网关 | 见子设备接口 |

<Note>
**重要区别**：
- **网关设备**：使用本接口创建，生成完整的 AWS IoT 凭证（Thing、证书、私钥）
- **子设备**：使用 `/manufacturing-create-child-devices` 接口创建，仅生成激活码和序列号，批次限制 1-1000 台
- 子设备通过网关连接云端，不需要独立的 AWS IoT 证书
</Note>

### 网关设备生产流程

<Steps>
  <Step title="1. 创建批次">
    调用本接口创建网关设备批次（1-100 台）
  </Step>

  <Step title="2. 立即保存私钥">
    从 API 响应中提取所有设备的 `private_key`，私钥仅返回一次
  </Step>

  <Step title="3. 下载证书包">
    管理后台自动生成 ZIP 文件，包含所有设备的证书和私钥
  </Step>

  <Step title="4. 烧录凭证">
    将证书和私钥烧录到对应的硬件设备中
  </Step>

  <Step title="5. 打印激活码">
    为每个设备生成二维码标签贴在包装上
  </Step>

  <Step title="6. 灵活出货">
    网关设备可以单独出货，也可以与子设备套装出货
  </Step>
</Steps>

<Note>
**灵活性优势**：
- 工厂可以独立生产各类设备，无需配对
- 仓库管理更灵活，可按需组合发货
- 用户可以自由选择购买网关+子设备的组合
</Note>

### 用户使用流程

用户购买设备后的使用流程：

<Steps>
  <Step title="1. 绑定网关">
    用户通过激活码绑定网关设备
  </Step>

  <Step title="2. 绑定子设备">
    用户通过激活码绑定子设备
  </Step>

  <Step title="3. 关联到网关">
    用户在App中将子设备关联到网关（参见User API文档）
  </Step>

  <Step title="4. 正常使用">
    子设备通过网关连接云端，开始正常工作
  </Step>
</Steps>

### 重要提示

<Warning>
**私钥安全**: `private_key` 字段仅在此接口响应中返回一次，系统不会存储到数据库。如果在创建时未保存私钥，将无法找回，需要重新创建设备。
</Warning>

<Warning>
**私钥丢失后果**：
- 私钥丢失后无法找回
- 需要在 AWS IoT 中吊销旧证书
- 需要重新创建设备并生成新的证书和私钥
- 需要更换设备上的凭证
</Warning>

<Note>
**激活码格式**: 激活码格式为 `{MODEL}-{8位HEX}`，例如 `GATEWAY-A3F2B1C9`。用户后续通过此码绑定设备。激活码使用后 `is_used` 会标记为 `true`，无法再次使用。
</Note>

<Note>
**网关设备特性**:
- 本接口仅用于创建网关设备，生成完整的 AWS IoT 凭证
- 网关设备拥有独立的 AWS IoT Thing、证书和私钥
- 批次限制：1-100 台设备
</Note>

### 操作流程

1. **验证管理员权限** - 检查JWT Token中的用户角色
2. **验证设备类型** - 检查device_type是否有效
3. **创建AWS IoT Thing** - 为每个设备创建Thing对象
4. **生成ECC P-256证书** - 使用CSR方式生成证书和私钥
5. **附加IoT Policy** - 将设备策略附加到证书
6. **生成激活码** - 创建唯一的激活码
7. **存储设备记录** - 保存到 `devices` 表，记录device_type
8. **存储激活码** - 保存到 `device_activation_codes` 表
9. **返回凭证** - 一次性返回所有设备凭证

### 设备状态

创建后的设备状态为 `registered`，等待用户通过激活码绑定后变为 `pending`。

### 批次管理

每次调用会创建一个批次记录，可通过 `/manufacturing-batches` 接口查询批次信息。
