---
title: '批量创建设备'
api: 'POST /manufacturing-create-devices'
---

## 接口说明

工厂批量创建IoT设备，生成AWS IoT Thing、证书和激活码。仅管理员可访问。

## 请求参数

<ParamField body="model" type="string" required>
  设备型号，例如: `RT-Pro-4G`
</ParamField>

<ParamField body="count" type="number" required>
  批量创建数量，范围: 1-100
</ParamField>

<ParamField body="prefix" type="string">
  设备名称前缀，默认使用型号。例如: `RT4G` 生成 `RT4G:001`, `RT4G:002`...
</ParamField>

<ParamField body="batch_name" type="string">
  批次名称，用于标识这批设备
</ParamField>

## 响应数据

<ResponseField name="batch_id" type="string">
  批次ID，格式: `batch_{timestamp}`
</ResponseField>

<ResponseField name="model" type="string">
  设备型号
</ResponseField>

<ResponseField name="created_count" type="number">
  成功创建的设备数量
</ResponseField>

<ResponseField name="devices" type="array">
  设备列表，包含以下字段：

  <Expandable title="Device 对象">
    <ResponseField name="thing_name" type="string">
      AWS IoT Thing名称，例如: `RT4G:001`
    </ResponseField>

    <ResponseField name="activation_code" type="string">
      激活码，格式: `{MODEL}-{8位HEX}`，例如: `RT4G-A3F2B1C9`
    </ResponseField>

    <ResponseField name="certificate_pem" type="string">
      设备证书（PEM格式）
    </ResponseField>

    <ResponseField name="private_key" type="string">
      设备私钥（PEM格式）⚠️ **仅此次返回，不会再次提供**
    </ResponseField>

    <ResponseField name="iot_endpoint" type="string">
      AWS IoT Core端点地址
    </ResponseField>

    <ResponseField name="certificate_id" type="string">
      AWS证书ID
    </ResponseField>

    <ResponseField name="certificate_arn" type="string">
      AWS证书ARN
    </ResponseField>
  </Expandable>
</ResponseField>

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | 缺少或无效的认证Token |
| `PERMISSION_DENIED` | 403 | 非管理员用户无权访问 |
| `INVALID_PARAMETERS` | 400 | 参数验证失败（count超出范围等） |
| `AWS_IOT_ERROR` | 500 | AWS IoT服务调用失败 |
| `DATABASE_ERROR` | 500 | 数据库操作失败 |

<RequestExample>
```bash cURL
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "RT-Pro-4G",
    "count": 10,
    "prefix": "RT4G",
    "batch_name": "Production Batch 2024-Q1"
  }'
```

```javascript Node.js
const response = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'RT-Pro-4G',
      count: 10,
      prefix: 'RT4G',
      batch_name: 'Production Batch 2024-Q1'
    })
  }
);

const data = await response.json();
console.log(`Created ${data.created_count} devices in batch ${data.batch_id}`);
```

```python Python
import requests

response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-create-devices',
    headers={
        'Authorization': 'Bearer YOUR_ADMIN_TOKEN',
        'Content-Type': 'application/json'
    },
    json={
        'model': 'RT-Pro-4G',
        'count': 10,
        'prefix': 'RT4G',
        'batch_name': 'Production Batch 2024-Q1'
    }
)

data = response.json()
print(f"Created {data['created_count']} devices in batch {data['batch_id']}")
```
</RequestExample>

<ResponseExample>
```json 成功响应
{
  "batch_id": "batch_1702900000",
  "model": "RT-Pro-4G",
  "created_count": 10,
  "devices": [
    {
      "thing_name": "RT4G:001",
      "activation_code": "RT4G-A3F2B1C9",
      "certificate_pem": "-----BEGIN CERTIFICATE-----\nMIIBxTCCAW...\n-----END CERTIFICATE-----",
      "private_key": "-----BEGIN EC PRIVATE KEY-----\nMHcCAQEEII...\n-----END EC PRIVATE KEY-----",
      "iot_endpoint": "a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com",
      "certificate_id": "abc123def456ghi789...",
      "certificate_arn": "arn:aws:iot:ap-southeast-1:123456789012:cert/abc123..."
    }
  ]
}
```

```json 错误响应 - 权限不足
{
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "Admin role required for device manufacturing",
    "statusCode": 403
  }
}
```

```json 错误响应 - 参数验证失败
{
  "error": {
    "code": "INVALID_PARAMETERS",
    "message": "count must be between 1 and 100",
    "statusCode": 400
  }
}
```

```json 错误响应 - AWS IoT错误
{
  "error": {
    "code": "AWS_IOT_ERROR",
    "message": "Failed to create IoT Thing: ThingAlreadyExists",
    "statusCode": 500
  }
}
```
</ResponseExample>

## 使用说明

### 权限要求
- 调用者必须拥有 **Admin** 角色
- 需要有效的 Supabase JWT Token

### 重要提示

<Warning>
**私钥安全**: `private_key` 字段仅在此接口响应中返回一次，系统不会存储。请务必安全保存并烧录到设备中。
</Warning>

<Note>
**激活码格式**: 激活码格式为 `{MODEL}-{8位HEX}`，例如 `RT4G-A3F2B1C9`。用户后续通过此码绑定设备。
</Note>

### 操作流程

1. **验证管理员权限** - 检查JWT Token中的用户角色
2. **创建AWS IoT Thing** - 为每个设备创建Thing对象
3. **生成ECC P-256证书** - 使用CSR方式生成证书和私钥
4. **附加IoT Policy** - 将设备策略附加到证书
5. **生成激活码** - 创建唯一的激活码
6. **存储设备记录** - 保存到 `devices` 表
7. **存储激活码** - 保存到 `device_activation_codes` 表
8. **返回凭证** - 一次性返回所有设备凭证

### 设备状态

创建后的设备状态为 `registered`，等待用户通过激活码绑定后变为 `pending`。

### 批次管理

每次调用会创建一个批次记录，可通过 `/manufacturing-batches` 接口查询批次信息。
