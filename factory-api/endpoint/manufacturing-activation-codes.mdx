---
title: '导出激活码'
api: 'GET /manufacturing-activation-codes'
---

## 接口说明

导出设备激活码，支持CSV和JSON格式。仅管理员可访问。

## 查询参数

<ParamField query="batch_id" type="string">
  按批次ID筛选
</ParamField>

<ParamField query="model" type="string">
  按设备型号筛选
</ParamField>

<ParamField query="is_used" type="boolean">
  筛选已使用/未使用的激活码
  - `true`: 仅返回已使用的激活码
  - `false`: 仅返回未使用的激活码
  - 不传: 返回全部
</ParamField>

<ParamField query="format" type="string" default="json">
  导出格式
  - `json`: JSON格式
  - `csv`: CSV文件下载
</ParamField>

<ParamField query="limit" type="number" default="1000">
  最大返回数量，范围: 1-10000
</ParamField>

## 响应数据

### JSON格式

<ResponseField name="codes" type="array">
  激活码列表

  <Expandable title="ActivationCode 对象">
    <ResponseField name="code" type="string">
      激活码，例如: `RT4G-A3F2B1C9`
    </ResponseField>

    <ResponseField name="device_id" type="string">
      关联的设备ID (UUID)
    </ResponseField>

    <ResponseField name="thing_name" type="string">
      设备Thing名称
    </ResponseField>

    <ResponseField name="model" type="string">
      设备型号
    </ResponseField>

    <ResponseField name="batch_id" type="string">
      所属批次ID
    </ResponseField>

    <ResponseField name="is_used" type="boolean">
      是否已使用
    </ResponseField>

    <ResponseField name="used_at" type="string">
      使用时间 (ISO 8601)，未使用时为null
    </ResponseField>

    <ResponseField name="used_by" type="string">
      使用者用户ID，未使用时为null
    </ResponseField>

    <ResponseField name="created_at" type="string">
      创建时间 (ISO 8601)
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="total" type="number">
  符合条件的总数量
</ResponseField>

### CSV格式

CSV文件包含以下列：
- `code`: 激活码
- `thing_name`: 设备名称
- `model`: 设备型号
- `batch_id`: 批次ID
- `is_used`: 是否已使用
- `used_at`: 使用时间
- `created_at`: 创建时间

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | 缺少或无效的认证Token |
| `PERMISSION_DENIED` | 403 | 非管理员用户无权访问 |
| `INVALID_PARAMETERS` | 400 | 参数验证失败 |
| `DATABASE_ERROR` | 500 | 数据库查询失败 |

<RequestExample>
```bash cURL - JSON格式
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes?batch_id=batch_1702900000&format=json' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
```

```bash cURL - CSV下载
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes?batch_id=batch_1702900000&format=csv' \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -o activation_codes.csv
```

```javascript Node.js
// JSON格式
const response = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes?batch_id=batch_1702900000&format=json',
  {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN'
    }
  }
);

const data = await response.json();
console.log(`Total codes: ${data.total}`);

// CSV下载
const csvResponse = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes?format=csv',
  {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer YOUR_ADMIN_TOKEN'
    }
  }
);

const blob = await csvResponse.blob();
// 保存CSV文件
```

```python Python
import requests

# JSON格式
response = requests.get(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes',
    headers={'Authorization': 'Bearer YOUR_ADMIN_TOKEN'},
    params={
        'batch_id': 'batch_1702900000',
        'format': 'json'
    }
)

data = response.json()
print(f"Total codes: {data['total']}")

# CSV下载
csv_response = requests.get(
    'https://your-supabase-project.supabase.co/functions/v1/manufacturing-activation-codes',
    headers={'Authorization': 'Bearer YOUR_ADMIN_TOKEN'},
    params={'format': 'csv'}
)

with open('activation_codes.csv', 'wb') as f:
    f.write(csv_response.content)
```
</RequestExample>

<ResponseExample>
```json 成功响应 - JSON格式
{
  "codes": [
    {
      "code": "RT4G-A3F2B1C9",
      "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "thing_name": "RT4G:001",
      "model": "RT-Pro-4G",
      "batch_id": "batch_1702900000",
      "is_used": false,
      "used_at": null,
      "used_by": null,
      "created_at": "2024-12-18T10:00:00Z"
    },
    {
      "code": "RT4G-B5D3E2F1",
      "device_id": "a1b2c3d4-5e6f-7g8h-9i0j-k1l2m3n4o5p6",
      "thing_name": "RT4G:002",
      "model": "RT-Pro-4G",
      "batch_id": "batch_1702900000",
      "is_used": true,
      "used_at": "2024-12-19T08:30:00Z",
      "used_by": "user_abc123",
      "created_at": "2024-12-18T10:00:01Z"
    }
  ],
  "total": 100
}
```

```csv 成功响应 - CSV格式
code,thing_name,model,batch_id,is_used,used_at,created_at
RT4G-A3F2B1C9,RT4G:001,RT-Pro-4G,batch_1702900000,false,,2024-12-18T10:00:00Z
RT4G-B5D3E2F1,RT4G:002,RT-Pro-4G,batch_1702900000,true,2024-12-19T08:30:00Z,2024-12-18T10:00:01Z
```

```json 错误响应 - 权限不足
{
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "Admin role required",
    "statusCode": 403
  }
}
```
</ResponseExample>

## 使用说明

### 权限要求
- 调用者必须拥有 **Admin** 角色

### 使用场景

<Tabs>
  <Tab title="批量打印二维码">
    导出未使用的激活码，生成二维码标签贴在设备包装上
    ```bash
    curl -X GET \
      'https://your-project.supabase.co/functions/v1/manufacturing-activation-codes?is_used=false&format=csv' \
      -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
      -o unused_codes.csv
    ```
  </Tab>

  <Tab title="审计已使用激活码">
    查看哪些激活码已被用户使用
    ```bash
    curl -X GET \
      'https://your-project.supabase.co/functions/v1/manufacturing-activation-codes?is_used=true&format=json' \
      -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
    ```
  </Tab>

  <Tab title="按批次导出">
    导出特定批次的所有激活码
    ```bash
    curl -X GET \
      'https://your-project.supabase.co/functions/v1/manufacturing-activation-codes?batch_id=batch_1702900000&format=csv' \
      -H "Authorization: Bearer YOUR_ADMIN_TOKEN"
    ```
  </Tab>
</Tabs>

### CSV文件格式

CSV文件使用UTF-8编码，包含表头，适合在Excel或Google Sheets中打开。

<Note>
**激活码唯一性**: 每个激活码只能使用一次，使用后 `is_used` 字段变为 `true`，不可重复使用。
</Note>

<Warning>
**数据安全**: 激活码是设备绑定的唯一凭证，请妥善保管导出的文件，避免泄露。
</Warning>
