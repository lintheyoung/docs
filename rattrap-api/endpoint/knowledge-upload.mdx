---
title: '上传知识库文件'
openapi: 'POST /knowledge-upload'
---

<RequestExample>
```bash cURL
curl https://lrsppxarhxvxcflougbp.supabase.co/functions/v1/knowledge-upload \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vbHJzcHB4YXJoeHZ4Y2Zsb3VnYnAuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -F "file=@mouse_knowledge.txt" \
  -F "title=老鼠基础知识" \
  -F "category=rodent_knowledge" \
  -F 'tags=["老鼠习性","防治方法"]' \
  -F "visibility=private" \
  -F "language=zh" \
  -F "source_url=https://example.com/mouse-guide" \
  -F "access_level=internal"
```

```javascript Node.js
const formData = new FormData();
formData.append('file', fileBlob, 'product_guide.pdf');
formData.append('title', 'RatTrap Pro 用户手册');
formData.append('category', 'trap_usage');
formData.append('tags', JSON.stringify(['安装', '使用指南', '维护']));
formData.append('visibility', 'private');
formData.append('language', 'zh');
formData.append('source_url', 'https://rattrap.com/docs/guide');
formData.append('access_level', 'public');

const response = await fetch(
  "https://lrsppxarhxvxcflougbp.supabase.co/functions/v1/knowledge-upload",
  {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${accessToken}`,
    },
    body: formData
  }
);

const knowledgeEntry = await response.json();
console.log(`知识已上传: ${knowledgeEntry.id}`);
```
</RequestExample>

<ResponseExample>
```json 成功响应 - 文本文件
{
  "id": "kb_1a2b3c4d5e6f7g8h",
  "tenant_id": "tenant_abc123",
  "title": "老鼠基础知识",
  "content": "老鼠是常见的城市害虫，分为家鼠和田鼠两大类...",
  "content_type": "document",
  "source_file_name": "mouse_knowledge.txt",
  "source_file_type": "txt",
  "source_url": "https://example.com/mouse-guide",
  "access_level": "internal",
  "category": "rodent_knowledge",
  "tags": ["老鼠习性", "防治方法"],
  "language": "zh",
  "visibility": "private",
  "is_active": true,
  "usage_count": 0,
  "created_by": "user_123",
  "created_at": "2025-12-08T10:30:00Z",
  "updated_at": "2025-12-08T10:30:00Z"
}
```

```json 成功响应 - 图片文件
{
  "id": "kb_9z8y7x6w5v4u3t2s",
  "tenant_id": "tenant_abc123",
  "title": "充电口位置示意图",
  "content": "图片展示了 RatTrap Pro 捕鼠器底部的 USB-C 充电口位置，位于电源开关旁边...",
  "content_type": "image",
  "source_file_name": "charging_port.jpg",
  "source_file_type": "jpg",
  "image_url": "https://storage.rattrap.ai/knowledge/kb_9z8y7x6w5v4u3t2s.jpg",
  "source_url": "https://rattrap.com/manual/charging",
  "access_level": "public",
  "category": "trap_usage",
  "tags": ["充电", "使用说明"],
  "language": "zh",
  "visibility": "public",
  "is_active": true,
  "usage_count": 0,
  "created_by": "user_123",
  "created_at": "2025-12-08T10:35:00Z",
  "updated_at": "2025-12-08T10:35:00Z"
}
```

```json 错误响应 - 未授权
{
  "error": {
    "type": "authentication_error",
    "code": "UNAUTHORIZED",
    "message": "Invalid or missing authentication token",
    "doc_url": "https://docs.rattrap.ai/errors#unauthorized"
  }
}
```

```json 错误响应 - 权限不足
{
  "error": {
    "type": "permission_error",
    "code": "FORBIDDEN",
    "message": "Unauthorized. Admin role required.",
    "doc_url": "https://docs.rattrap.ai/errors#forbidden"
  }
}
```

```json 错误响应 - 缺少文件
{
  "error": {
    "type": "invalid_request_error",
    "code": "MISSING_REQUIRED_FIELD",
    "message": "No file provided",
    "param": "file",
    "doc_url": "https://docs.rattrap.ai/errors#missing_required_field"
  }
}
```

```json 错误响应 - 不支持的文件格式
{
  "error": {
    "type": "invalid_request_error",
    "code": "UNSUPPORTED_FORMAT",
    "message": "Unsupported file type: gif",
    "param": "file",
    "doc_url": "https://docs.rattrap.ai/errors#unsupported_format"
  }
}
```
</ResponseExample>

## 使用说明

管理员可以通过此接口上传知识库文件，用于 RAG 知识问答系统。系统支持多种文件格式，并自动处理：

<CardGroup cols={3}>
  <Card title="内容提取" icon="file-text">
    自动提取文本、图片描述或文档内容
  </Card>
  <Card title="向量嵌入" icon="brain">
    使用 OpenAI 生成向量嵌入供语义检索
  </Card>
  <Card title="多语言" icon="globe">
    支持多语言知识库和翻译版本
  </Card>
</CardGroup>

<Info>
**��限要求**：此接口仅限 **管理员（admin）** 或 **所有者（owner）** 角色使用。
</Info>

## 请求参数

### 必填字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `file` | File | 要上传的文件（支持 .txt, .jpg, .png, .webp, .pdf, .docx） |

### 可选字段

| 字段 | 类型 | 默认值 | 说明 |
|------|------|-------|------|
| `title` | string | 文件名 | 知识标题 |
| `category` | string | `"general"` | 知识分类：`rodent_knowledge` / `trap_usage` / `faq` / `general` |
| `tags` | string (JSON数组) | `"[]"` | 标签数组，例如 `["老鼠习性","防治"]` |
| `visibility` | string | `"private"` | 隐私级别：`private`（租户私有）/ `public`（全局共享） |
| `language` | string | `"en"` | 语言代码（ISO 639-1），例如 `en`, `zh`, `ja`, `es` |
| `source_url` | string | - | 原始来源 URL，用于引用追溯 |
| `source_title` | string | - | 来源标题，显示在引用中 |
| `source_author` | string | - | 作者或来源机构 |
| `access_level` | string | `"public"` | 访问权限：`public`（直接访问）/ `internal`（需登录）/ `private`（仅内部） |
| `applicable_countries` | string (JSON数组) | `"[]"` | 适用国家列表（ISO 3166-1），例如 `["US","CA"]` |
| `excluded_countries` | string (JSON数组) | `"[]"` | 排除国家列表（优先级高于 `applicable_countries`） |

<Warning>
**Content-Type**：请求必须使用 `multipart/form-data` 格式，因为需要上传文件。
</Warning>

## 典型使用流程

<Steps>
  <Step title="准备文件和元数据">
    选择要上传的知识文件（文本、图片、文档），准备标题、分类、标签等元数据。
  </Step>
  <Step title="构造 FormData 请求">
    创建 FormData 对象，添加 `file` 和其他可选字段。`tags` 等数组字段需要 JSON 序列化。
  </Step>
  <Step title="发送 POST 请求">
    调用 `POST /v1/knowledge-upload`，携带管理员 Bearer Token。
  </Step>
  <Step title="后端自动处理">
    系统自动提取文件内容、生成向量嵌入、保存到数据库。
  </Step>
  <Step title="知识立即可用">
    上传成功后，知识条目立即可以在 RAG 问答中被检索和引用。
  </Step>
</Steps>

## 后端处理流程

### 1. 权限验证

后端首先验证用户身份和角色：
- 检查 Bearer Token 是否有效
- 查询用户的角色（`user_tenant_roles` 表）
- 确认角色为 `admin` 或 `owner`
- 如果不符合条件，返回 `403 FORBIDDEN`

### 2. 文件内容提取

根据文件类型进行不同处理：

**文本文件（.txt, .md）**：
- 直接读取文件内容作为知识文本

**图片文件（.jpg, .png, .webp）**：
- 将图片上传到 Supabase Storage
- 使用 LLM 视觉 API（例如 GPT-4 Vision）分析图片
- 生成详细的文本描述（用于语义检索）
- 保存图片公开 URL 到 `image_url` 字段
- 设置 `content_type = 'image'`

**文档文件（.pdf, .docx）**（即将支持）：
- 使用文档解析库提取文本内容
- 保留文档结构和格式信息

### 3. 向量嵌入生成

使用 OpenAI `text-embedding-3-small` 模型生成向量：
```typescript
const embedding = await generateEmbedding(content);
// embedding: number[] (1536 维向量)
```

向量将存储在 `knowledge_base.embedding` 字段，用于后续的语义相似度检索。

### 4. 数据库存储

将知识条目插入 `knowledge_base` 表：
- `tenant_id`：如果 `visibility='private'` 则设置为当前租户 ID，否则为 `null`
- `content`：提取的文本内容或图片描述
- `embedding`：生成的 1536 维向量
- `is_active`：默认 `true`，知识立即可用
- `created_by`：当前用户 ID

## 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 知识库条目 ID，格式：`kb_xxx` |
| `tenant_id` | string | 租户 ID（private 模式）或 `null`（public 模式） |
| `title` | string | 知识标题 |
| `content` | string | 提取的文本内容或图片描述 |
| `content_type` | string | 内容类型：`document` / `image` / `text` / `qa` |
| `source_file_name` | string | 原始文件名 |
| `source_file_type` | string | 文件类型：`txt` / `jpg` / `png` / `pdf` / `docx` |
| `image_url` | string | 图片公开 URL（仅图片类型） |
| `source_url` | string | 原始来源 URL |
| `source_title` | string | 来源标题 |
| `access_level` | string | 访问权限级别 |
| `category` | string | 知识分类 |
| `tags` | string[] | 标签数组 |
| `language` | string | 语言代码 |
| `visibility` | string | 隐私级别 |
| `is_active` | boolean | 是否启用 |
| `usage_count` | integer | 使用次数 |
| `created_by` | string | 创建者用户 ID |
| `created_at` | string | 创建时间（ISO 8601） |
| `updated_at` | string | 更新时间（ISO 8601） |

<Info>
**向量字段**：`embedding` 字段（1536 维向量）不会在响应中返回，因为它仅用于后端检索。
</Info>

## 支持的文件格式

### 当前支持

<CardGroup cols={2}>
  <Card title="文本文件" icon="file-lines">
    `.txt`, `.md`

    直接读取文本内容
  </Card>
  <Card title="图片文件" icon="image">
    `.jpg`, `.jpeg`, `.png`, `.webp`

    使用 LLM 视觉 API 分析并生成描述
  </Card>
</CardGroup>

### 即将支持

<CardGroup cols={2}>
  <Card title="PDF 文档" icon="file-pdf">
    `.pdf`

    提取文本和表格内容
  </Card>
  <Card title="Word 文档" icon="file-word">
    `.docx`, `.doc`

    提取文本和格式信息
  </Card>
</CardGroup>

<Warning>
**文件大小限制**：建议单个文件不超过 **10MB**。超大文件可能导致处理超时。
</Warning>

## category 参数说明

| 值 | 说明 | 使用场景 |
|---|---|---|
| `rodent_knowledge` | 老鼠相关知识 | 老鼠习性、种类识别、防治方法 |
| `trap_usage` | 捕鼠器使用 | 安装指南、布放技巧、维护方法 |
| `faq` | 常见问题 | 用户常见问题解答 |
| `general` | 通用知识 | 其他类型的知识内容 |

## visibility 参数说明

| 值 | 说明 | 检索范围 |
|---|---|---|
| `private` | 租户私有 | 仅当前租户的用户可以检索到 |
| `public` | 全局共享 | 所有租户的用户都可以检索到 |

<Info>
**默认值**：如果未指定 `visibility`，默认为 `private`（租户私有）。
</Info>

## access_level 参数说明

用于控制 `source_url` 的访问权限（引用追溯功能）：

| 值 | 说明 | 链接处理方式 |
|---|---|---|
| `public` | 公开访问 | AI 回答中直接展示原始 URL，用户可直接点击 |
| `internal` | 内部访问 | 通过权限网关 `/functions/v1/kb-redirect` 代理访问，需要登录验证 |
| `private` | 私有内容 | 知识可用于生成回答，但不在引用中暴露 URL |

<Warning>
**安全提示**：`internal` 和 `private` 级别的知识不会直接暴露 `source_url`，避免未授权访问内部文档。
</Warning>

## 图片处理特殊说明

当上传图片文件时，系统会进行特殊处理：

<Steps>
  <Step title="上传到 Supabase Storage">
    图片会被上传到 `knowledge-assets` bucket，生成公开 URL。
  </Step>
  <Step title="LLM 视觉分析">
    使用 GPT-4 Vision 或 Claude Sonnet (multimodal) 分析图片内容。

    Prompt 示例：
    > "请详细描述这张图片中关于老鼠、捕鼠器或害虫防治的信息。提取所有文字和关键内容。"
  </Step>
  <Step title="生成文本描述">
    LLM 返回详细的文本描述，例如：

    > "图片展示了 RatTrap Pro 捕鼠器底部的 USB-C 充电口位置，位于电源开关旁边，标有充电图标..."
  </Step>
  <Step title="向量嵌入">
    将文本描述转换为向量嵌入，存入数据库用于语义检索。
  </Step>
  <Step title="RAG 检索使用">
    用户提问时，系统通过向量相似度匹配图片描述，返回图片 URL。
  </Step>
</Steps>

<Info>
**使用场景**：用户问"充电口在哪里？"，系统检索到图片描述匹配度高，通过 Crisp API 发送图片 URL 给用户。
</Info>

## 多语言支持

知识库支持多语言版本：

1. **主语言版本**：上传时指定 `language` 参数（例如 `"zh"`），存储在 `knowledge_base` 表
2. **翻译版本**：使用单独的接口 `POST /knowledge-translation-upload` 添加其他语言版本
3. **语言检索**：RAG 系统自动识别用户语言，优先返回对应语言的知识
4. **语言回退**：如果用户语言无对应知识，回退到默认语言（英语）

**支持的语言代码**（ISO 639-1）：
- `en`：英语
- `zh`：简体中文
- `ja`：日语
- `es`：西班牙语
- `de`：德语
- `fr`：法语

## 错误码

| HTTP 状态码 | 错误代码 | 说明 |
|-----------|---------|------|
| 401 | `UNAUTHORIZED` | 未提供有效的认证 Token |
| 403 | `FORBIDDEN` | 当前用户不是管理员，无权上传知识 |
| 400 | `MISSING_REQUIRED_FIELD` | 缺少必填字段（`file`） |
| 400 | `UNSUPPORTED_FORMAT` | 不支持的文件格式 |
| 400 | `VALIDATION_ERROR` | 参数验证失败（例如无效的 JSON 数组） |
| 413 | `FILE_TOO_LARGE` | 文件大小超过限制（> 10MB） |
| 500 | `INTERNAL_ERROR` | 服务器内部错误（文件提取、向量生成、数据库错误） |

## 使用注意事项

<Warning>
**权限要求**：
- 只有 **admin** 和 **owner** 角色可以上传知识
- 普通用户会收到 `403 FORBIDDEN` 错误
</Warning>

<Info>
**文件处理时间**：
- 文本文件：通常 < 2 秒
- 图片文件：2-5 秒（包含 LLM 视觉分析时间）
- PDF/Word 文档：5-10 秒（取决于文档大小和复杂度）
</Info>

<Info>
**向量嵌入成本**：
- 使用 OpenAI `text-embedding-3-small` 模型
- 成本：$0.02 / 1M tokens
- 1000 字中文 ≈ 2000 tokens ≈ $0.00004
</Info>

<Warning>
**Content-Type 设置**：
- 必须使用 `multipart/form-data`
- 不要手动设置 `Content-Type` header（浏览器/库会自动添加 boundary）
</Warning>

## 常见问题

<AccordionGroup>
  <Accordion title="如何为知识添加翻译版本？">
    使用单独的接口 `POST /knowledge-translation-upload`，提供 `knowledge_id` 和新语言的内容。详见翻译上传接口文档。
  </Accordion>

  <Accordion title="上传的知识什么时候可以被检索到？">
    上传成功后立即可用。`is_active` 字段默认为 `true`，知识条目会立即出现在 RAG 检索结果中。
  </Accordion>

  <Accordion title="如何临时禁用某个知识条目？">
    可以通过知识管理接口（`PATCH /knowledge-base/{id}`）将 `is_active` 设置为 `false`。禁用后不会出现在检索结果中。
  </Accordion>

  <Accordion title="图片文件的描述是如何生成的？">
    系统使用 LLM 视觉 API（GPT-4 Vision 或 Claude Sonnet）分析图片，生成详细的文本描述。这个描述会被转换为向量嵌入，用于语义检索。
  </Accordion>

  <Accordion title="PDF 和 Word 文档什么时候支持？">
    PDF 和 Word 文档解析功能正在开发中，预计在下个版本发布。目前上传这些格式会返回 `UNSUPPORTED_FORMAT` 错误。
  </Accordion>

  <Accordion title="如何删除已上传的知识？">
    使用知识删除接口 `DELETE /knowledge-base/{id}`。删除后，该知识的所有翻译版本也会被级联删除。
  </Accordion>

  <Accordion title="visibility 和 access_level 有什么区别？">
    - `visibility`：控制 **检索范围**（哪些租户的用户可以检索到这个知识）
    - `access_level`：控制 **引用链接的访问权限**（用户点击 source_url 时的权限验证）

    例如：`visibility='public'` + `access_level='internal'` 表示所有用户都能检索到这个知识，但点击引用链接时需要登录验证。
  </Accordion>
</AccordionGroup>

## 相关资源

- **RAG 知识问答系统**：[/rag-qa](/rattrap-api/endpoint/rag-qa) - 查询知识库并生成回答
- **Crisp Message Hook**：[/crisp-message-hook](/rattrap-api/endpoint/crisp-message-hook) - 接收 Crisp webhook 触发 RAG 问答
- **技术方案文档**：`RAG_KNOWLEDGE_BASE_DESIGN.md` - 完整的 RAG 系统设计文档
