---
title: '获取诱饵推荐'
openapi: 'POST /bait-recommendations'
---

<RequestExample>
```bash cURL - 标准推荐
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/bait-recommendations \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "standard",
    "rodent_target": "rat",
    "trap_type": "snap_trap",
    "user_location": {
      "country": "TW",
      "city": "Taipei"
    },
    "preferences": {
      "avoid_perishable": true,
      "has_children_or_pets": true
    },
    "limit": 3
  }'
```

```bash cURL - 从冰箱识别
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/bait-recommendations \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "from_fridge",
    "rodent_target": "rat",
    "trap_type": "snap_trap",
    "media_asset_id": "ma_1PkAbC23xyz",
    "user_location": {
      "country": "TW",
      "city": "Kaohsiung"
    },
    "limit": 3
  }'
```
</RequestExample>

<ResponseExample>
```json 标准推荐响应
{
  "object": "bait_recommendation_result",
  "mode": "standard",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "user_location": {
    "country": "TW",
    "city": "Taipei"
  },
  "preferences": {
    "avoid_perishable": true,
    "has_children_or_pets": true
  },
  "primary_bait": {
    "object": "bait_option",
    "id": "bait_peanut_butter",
    "bait_type": "peanut_butter",
    "label": "花生酱",
    "description": "高油脂、高香味，对大褐家鼠吸引力强，且粘性好，不易被叼走。",
    "for_rodent": "rat",
    "recommended_for_trap_types": ["snap_trap", "cage_trap"],
    "suitability_score": 0.96,
    "recommended_interval_hours": 72,
    "spoilage_risk": "medium",
    "safety_notes": "若家中有花生过敏者，请避免在暴露区域使用。",
    "usage_tips": "只需米粒大小的一点，涂在踏板前缘内侧，让老鼠必须逗留啃咬。",
    "source": "ideal"
  },
  "alternative_baits": [
    {
      "object": "bait_option",
      "id": "bait_nuts_mixed",
      "bait_type": "nuts",
      "label": "混合坚果",
      "description": "对大鼠和小鼠都具有吸引力，耐放，适合忙碌家庭。",
      "for_rodent": "both",
      "recommended_for_trap_types": ["snap_trap", "cage_trap"],
      "suitability_score": 0.88,
      "recommended_interval_hours": 168,
      "spoilage_risk": "low",
      "safety_notes": "注意坚果碎片不要撒得太散，避免老鼠吃到却不触发陷阱。",
      "usage_tips": "可用一小块坚果压在踏板边缘，或用牙签扎住以防被轻易拖走。",
      "source": "user_available"
    }
  ],
  "fridge_analysis": null,
  "created": 1764038800
}
```

```json 从冰箱识别响应
{
  "object": "bait_recommendation_result",
  "mode": "from_fridge",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "user_location": {
    "country": "TW",
    "city": "Kaohsiung"
  },
  "primary_bait": {
    "object": "bait_option",
    "id": "bait_bacon",
    "bait_type": "bacon",
    "label": "香肠 / 培根类肉制品",
    "description": "高蛋白、高油脂，对肉食偏好的沟鼠吸引力极强。",
    "for_rodent": "rat",
    "recommended_for_trap_types": ["snap_trap", "cage_trap"],
    "suitability_score": 0.95,
    "recommended_interval_hours": 24,
    "spoilage_risk": "high",
    "safety_notes": "避免在高温环境放置超过 24 小时，以免腐败产生异味和卫生风险。",
    "usage_tips": "切成小块并用细绳或牙签固定在踏板上，防止被整块拖走。",
    "source": "from_fridge"
  },
  "alternative_baits": [],
  "fridge_analysis": {
    "identified_foods": [
      "香肠",
      "培根",
      "奶酪",
      "吐司面包",
      "鸡蛋",
      "牛奶"
    ],
    "suitable_for_bait": [
      "香肠",
      "培根",
      "奶酪"
    ],
    "not_recommended": [
      "吐司面包（容易发霉）",
      "鸡蛋（易碎且不吸引老鼠）",
      "牛奶（液体不适合）"
    ]
  },
  "created": 1764038900
}
```

```json 错误 - 缺少必填字段
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "Missing required field: media_asset_id is required when mode=from_fridge",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```

```json 错误 - 无效枚举值
{
  "error": {
    "type": "invalid_request_error",
    "code": "INVALID_RODENT_TARGET",
    "message": "Invalid rodent_target. Must be one of: rat, mouse, unknown",
    "param": "rodent_target",
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```

```json 错误 - LLM 服务失败
{
  "error": {
    "type": "api_error",
    "code": "LLM_SERVICE_ERROR",
    "message": "Failed to generate bait recommendations. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```

```json 错误 - 冰箱照片无法识别
{
  "error": {
    "type": "invalid_request_error",
    "code": "FRIDGE_RECOGNITION_FAILED",
    "message": "Unable to identify suitable food items from the provided image. Please provide a clearer photo of your fridge or food storage.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```

```json 错误 - Media Asset 不存在
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_NOT_FOUND",
    "message": "The specified media_asset_id does not exist or does not belong to the current user",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```

```json 错误 - LLM 余额不足
{
  "error": {
    "type": "api_error",
    "code": "LLM_QUOTA_EXCEEDED",
    "message": "LLM service quota exceeded. Please contact support or try again later.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/bait-recommendations"
  }
}
```
</ResponseExample>

## 使用说明

这个接口不再是固定推荐"花生酱"，而是基于多种因素**动态推荐诱饵**：

<Tabs>
  <Tab title="标准推荐 (BAIT_CHECK)">
    当 `mode = "standard"` 时：
    - 基于 rodent + trap + location + 偏好推荐
    - 返回主推荐 + 候选列表
    - 用户可以点击「我家有这个」或「帮我找替代」
  </Tab>
  <Tab title="从冰箱识别 (BAIT_CAM)">
    当 `mode = "from_fridge"` 时：
    - AI 分析用户拍摄的冰箱/储物柜照片
    - 从中筛选最适合做诱饵的现有食物
    - 返回识别结果和推荐
  </Tab>
</Tabs>

---

## 图片上传流程（from_fridge 模式）

当使用 `mode = "from_fridge"` 时，需要先上传冰箱照片：

<Steps>
  <Step title="创建媒体资源">
    调用 `POST /media-assets` 创建媒体资源并获取 `upload_url`

    ```javascript
    const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        purpose: "check",  // 使用 check 类型（诱饵推荐属于检查场景）
        content_type: "image/jpeg",
        metadata: {
          usage: "bait_recommendation"
        }
      })
    });
    const mediaAsset = await res.json();
    ```
  </Step>

  <Step title="上传图片到预签名 URL">
    使用返回的 `upload_url` 上传图片

    ```javascript
    await fetch(mediaAsset.upload_url, {
      method: "PUT",
      headers: { "Content-Type": "image/jpeg" },
      body: imageBlob
    });
    ```
  </Step>

  <Step title="调用诱饵推荐接口">
    使用 `media_asset_id` 调用本接口

    ```javascript
    const baitRes = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/bait-recommendations", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        mode: "from_fridge",
        rodent_target: "rat",
        trap_type: "snap_trap",
        media_asset_id: mediaAsset.id,  // 使用上传的图片 ID
        limit: 3
      })
    });
    ```
  </Step>
</Steps>

<Note>
**关于图片上传的重要说明**

1. **必须先创建 media asset**：不能直接传 media_asset_id，必须先通过 `POST /media-assets` 接口创建资源
2. **预签名 URL 有效期**：upload_url 有 15 分钟有效期，需要在创建后及时上传
3. **认证要求**：media asset 和用户绑定，只能使用自己上传的图片
</Note>

---

## 必填字段说明

<Warning>
**不同模式的必填字段要求**

### standard 模式
- ✅ `mode` = "standard"
- ✅ `rodent_target` (rat / mouse / unknown)
- ✅ `trap_type` (snap_trap / glue_board / cage_trap / electronic_trap / other)

### from_fridge 模式
- ✅ `mode` = "from_fridge"
- ✅ `rodent_target`
- ✅ `trap_type`
- ✅ `media_asset_id` **（from_fridge 模式时必填）**

缺少必填字段会返回 `400 VALIDATION_ERROR`
</Warning>

## 诱饵类型说明

| 类型 | 说明 | 腐败风险 | 推荐检查间隔 |
|------|------|----------|--------------|
| `peanut_butter` | 花生酱 | 中 | 72小时 |
| `bacon` | 培根/肉类 | 高 | 24小时 |
| `cheese` | 奶酪 | 高 | 24小时 |
| `nuts` | 坚果 | 低 | 168小时 |
| `chocolate` | 巧克力 | 低 | 168小时 |
| `grain` | 谷物 | 低 | 168小时 |

## bait_option 字段详解

<ResponseField name="primary_bait.suitability_score" type="number">
  0–1 之间的适配度评分
</ResponseField>

<ResponseField name="primary_bait.recommended_interval_hours" type="integer">
  推荐的检查/更换间隔（小时）
</ResponseField>

<ResponseField name="primary_bait.spoilage_risk" type="string">
  腐败/变质风险：`low` / `medium` / `high`
</ResponseField>

<ResponseField name="primary_bait.usage_tips" type="string">
  使用技巧，如"涂抹少量在触发踏板背面"
</ResponseField>

<ResponseField name="primary_bait.source" type="string">
  推荐来源：`ideal`（理想推荐）/ `from_fridge`（冰箱识别）/ `user_available`（用户已有）
</ResponseField>

## 用户偏好参数

<ParamField body="preferences.avoid_smelly_bait" type="boolean">
  不喜欢异味太重的诱饵
</ParamField>

<ParamField body="preferences.avoid_perishable" type="boolean">
  不想用容易腐烂的肉类
</ParamField>

<ParamField body="preferences.has_children_or_pets" type="boolean">
  有小孩或宠物 → 避免散落小块
</ParamField>

<ParamField body="preferences.easy_to_clean" type="boolean">
  偏好不太黏、清理方便的诱饵
</ParamField>

---

## 错误响应

| 场景 | HTTP 状态码 | Error Code | 说明 |
|-----|------------|------------|------|
| LLM 服务失败 | 503 | `LLM_SERVICE_ERROR` | AI 推荐服务暂时不可用，请稍后重试 |
| LLM 余额不足 | 503 | `LLM_QUOTA_EXCEEDED` | AI 服务配额已用尽，请联系技术支持 |
| 冰箱照片无法识别 | 400 | `FRIDGE_RECOGNITION_FAILED` | 无法从照片中识别适合的食物，建议重新拍摄更清晰的照片 |
| Media Asset 不存在 | 404 | `MEDIA_NOT_FOUND` | 照片不存在或不属于当前用户 |
| 缺少必填字段 | 400 | `VALIDATION_ERROR` | 请求参数不完整 |
| 无效枚举值 | 400 | `INVALID_RODENT_TARGET` 等 | 参数值不在允许的枚举范围内 |
| 请求超时 | 504 | `REQUEST_TIMEOUT` | AI 处理超时，请简化请求或稍后重试 |
| 未授权访问 | 401 | `UNAUTHORIZED` | 缺少或无效的 Authorization header |

<Warning>
**前端错误处理建议：**
- `LLM_SERVICE_ERROR` / `LLM_QUOTA_EXCEEDED` / `REQUEST_TIMEOUT`: 显示"服务繁忙，请稍后重试"，提供重试按钮
- `FRIDGE_RECOGNITION_FAILED`: 提示用户"照片不清晰，请重新拍摄冰箱照片"，返回拍照界面
- `MEDIA_NOT_FOUND`: 提示用户重新上传照片
- `VALIDATION_ERROR`: 根据 `param` 字段高亮对应的输入框
- `UNAUTHORIZED`: 引导用户重新登录
</Warning>

---

## AI 推荐逻辑说明

<Note>
**本接口使用 LLM（大语言模型）生成推荐**

### 推荐考虑因素
1. **目标鼠种** (rodent_target)：rat / mouse 有不同的食物偏好
2. **陷阱类型** (trap_type)：不同陷阱适合不同诱饵形态（液体、固体、粘性等）
3. **地理位置** (user_location)：考虑当地气候和食物可获得性
4. **用户偏好** (preferences)：避免异味、腐败风险、清洁难度等
5. **冰箱内容** (from_fridge 模式)：从用户现有食材中推荐

### 推荐质量
- 每个诱饵都有 `suitability_score`（0-1 适配度评分）
- 考虑 `spoilage_risk`（腐败风险）和 `recommended_interval_hours`（检查间隔）
- 提供详细的 `usage_tips`（使用技巧）和 `safety_notes`（安全提示）

### 性能说明
- 标准推荐通常在 2-5 秒内返回
- 冰箱识别（含图片分析）可能需要 5-10 秒
- 超过 30 秒会返回 `REQUEST_TIMEOUT` 错误
</Note>

---

## 测试资源

### 冰箱照片示例

用于测试 `from_fridge` 模式的示例图片：

<Frame>
  <img src="/images/fridge.jpg" alt="测试用冰箱照片" />
</Frame>

**使用方法**：
1. 下载此图片到本地
2. 通过 `POST /media-assets` 接口上传（`purpose: "check"`）
3. 使用返回的 `media_asset_id` 调用本接口

**测试脚本示例**：
```python
# 1. 创建媒体资源
response = requests.post(
    f"{BASE_URL}/media-assets",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={"purpose": "check", "content_type": "image/jpeg", "metadata": {"usage": "bait_recommendation"}}
)
media_id = response.json()['id']
upload_url = response.json()['upload_url']

# 2. 上传图片
with open('fridge.jpg', 'rb') as f:
    requests.put(upload_url, headers={"Content-Type": "image/jpeg"}, data=f)

# 3. 调用诱饵推荐接口
response = requests.post(
    f"{BASE_URL}/bait-recommendations",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={
        "mode": "from_fridge",
        "rodent_target": "rat",
        "trap_type": "snap_trap",
        "media_asset_id": media_id
    }
)
```