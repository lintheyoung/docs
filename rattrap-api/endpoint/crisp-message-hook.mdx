---
title: "Crisp Message Hook"
openapi: "POST /crisp-message-hook"
---

## 概述

此 Edge Function 用于接收 Crisp 客服系统发送的 webhook 事件，处理用户消息、会话更新等事件。

## Webhook 配置

在 Crisp 后台配置 webhook URL：

```
https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/crisp-message-hook
```

### 安全验证

请求会包含 `X-Crisp-Signature` header，后端必须验证此签名：

```typescript
const signature = request.headers.get('X-Crisp-Signature');
const secret = Deno.env.get('CRISP_WEBHOOK_SECRET');
const body = await request.text();

const expectedSignature = crypto
  .createHmac('sha256', secret)
  .update(body)
  .digest('hex');

if (signature !== expectedSignature) {
  return new Response('Invalid signature', { status: 401 });
}
```

## 支持的事件类型

### message:send
用户在聊天窗口发送消息时触发

### message:received
客服回复用户消息时触发

### session:set_email
用户设置邮箱时触发

### session:set_data
会话自定义数据更新时触发

## 请求示例

```json
{
  "website_id": "7ea85f39-a49f-4017-934c-010ed9c9db4d",
  "event": "message:send",
  "timestamp": 1733565668,
  "data": {
    "website_id": "7ea85f39-a49f-4017-934c-010ed9c9db4d",
    "session_id": "session_xxx",
    "message": {
      "type": "text",
      "content": "用户发送的消息内容",
      "from": "user",
      "origin": "chat",
      "timestamp": 1733565668
    },
    "user": {
      "nickname": "访客",
      "email": "user@example.com"
    }
  }
}
```
