---
title: 'è·å–æ•é¼ å™¨æ¨è'
openapi: 'POST /trap-recommendations'
---

<RequestExample>
```bash cURL - è¯†åˆ«ç°æœ‰å·¥å…·
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-recommendations \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "existing_trap",
    "rodent_target": "rat",
    "media_asset_id": "ma_1PpTqQx2YwZv9kLb",
    "user_location": {
      "country": "TW",
      "city": "Taipei",
      "environment": "apartment"
    },
    "preferences": {
      "avoid_killing": false,
      "has_children_or_pets": true,
      "budget_level": "medium"
    },
    "limit": 3
  }'
```

```bash cURL - æ— å·¥å…·æ¨èè´­ä¹°
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-recommendations \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "no_trap",
    "rodent_target": "mouse",
    "user_location": {
      "country": "TW",
      "city": "Taichung"
    },
    "preferences": {
      "avoid_killing": true,
      "budget_level": "high"
    },
    "limit": 5
  }'
```
</RequestExample>

<ResponseExample>
```json è¯†åˆ«ç°æœ‰å·¥å…· - é€‚åˆä½¿ç”¨
{
  "object": "trap_recommendation_result",
  "mode": "existing_trap",
  "rodent_target": "rat",
  "user_location": {
    "country": "TW",
    "city": "Taipei",
    "environment": "apartment"
  },
  "preferences": {
    "avoid_killing": false,
    "has_children_or_pets": true,
    "budget_level": "medium"
  },
  "existing_trap": {
    "object": "existing_trap_analysis",
    "media_asset_id": "ma_1PpTqQx2YwZv9kLb",
    "detected_type": "snap_trap",
    "is_suitable": true,
    "suitability_score": 0.92,
    "notes": "è¯†åˆ«ä¸ºå¤§å·å¼¹ç°§è€é¼ å¤¹ï¼Œå¯¹æˆå¹´çš„å¤§è¤å®¶é¼ æ•ˆæœè‰¯å¥½ã€‚è¯·æ³¨æ„æ”¾ç½®ä½ç½®ï¼Œé¿å…å„¿ç«¥å’Œå® ç‰©æ¥è§¦ã€‚"
  },
  "recommended_traps": [
    {
      "object": "trap_product",
      "id": "trp_snap_heavy_01",
      "trap_type": "snap_trap",
      "label": "å¤§å·å¼ºåŠ›å¼¹ç°§å¤¹",
      "description": "é€‚åˆå¨æˆ¿å’Œè½¦åº“ï¼Œå¯¹å¤§é¼ å‡»æ€ç‡é«˜ï¼Œæˆæœ¬ä½ã€‚",
      "for_rodent": "rat",
      "suitability_score": 0.95,
      "safety_level": "medium",
      "maintenance_level": "low",
      "price_band": "low",
      "recommended_reason": "ä¸æ‚¨ç°æœ‰å·¥å…·ç±»å‹ä¸€è‡´ï¼Œæ–¹ä¾¿ä¸€æ¬¡è´­ä¹°å¤šåªå¤‡ç”¨ã€‚"
    }
  ],
  "created": 1764038500
}
```

```json æ— å·¥å…· - è´­ä¹°æ¨è
{
  "object": "trap_recommendation_result",
  "mode": "no_trap",
  "rodent_target": "mouse",
  "user_location": {
    "country": "TW",
    "city": "Taichung"
  },
  "preferences": {
    "avoid_killing": true,
    "budget_level": "high"
  },
  "existing_trap": null,
  "recommended_traps": [
    {
      "object": "trap_product",
      "id": "trp_cage_humane_01",
      "trap_type": "cage_trap",
      "label": "äººé“æ•é¼ ç¬¼",
      "description": "ä¸ä¼¤å®³è€é¼ ï¼Œé€‚åˆå®¤å†…ä½¿ç”¨ã€‚éœ€è¦å°†æ•è·çš„è€é¼ å¸¦ç¦»ä½å®…åŒºæ”¾ç”Ÿã€‚",
      "for_rodent": "mouse",
      "suitability_score": 0.91,
      "safety_level": "high",
      "maintenance_level": "medium",
      "price_band": "medium",
      "recommended_reason": "ç¬¦åˆæ‚¨\"ä¸æ€ç”Ÿ\"çš„åå¥½ï¼Œå¹¶ä¸”é€‚åˆå°æ¹¾å¸¸è§çš„å°å®¶é¼ ã€‚",
      "purchase_hints": {
        "search_keywords": "æ•é¼ ç¬¼ äººé“ å°å·",
        "preferred_platforms": ["online_marketplace"],
        "estimated_price_range": "NT$300â€“600"
      }
    }
  ],
  "created": 1764038600
}
```

```json é”™è¯¯ - LLM æœåŠ¡å¤±è´¥
{
  "error": {
    "type": "api_error",
    "code": "LLM_SERVICE_ERROR",
    "message": "Failed to generate recommendations. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - å›¾ç‰‡æ— æ³•è¯†åˆ«
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_RECOGNITION_FAILED",
    "message": "Unable to identify trap from the provided image. Please provide a clearer photo.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - Media Asset ä¸å­˜åœ¨
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_NOT_FOUND",
    "message": "Media asset not found or does not belong to this user",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - ç¼ºå°‘å¿…å¡«å­—æ®µ
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "Missing required field: media_asset_id is required when mode=existing_trap",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - æ— æ•ˆæšä¸¾å€¼
{
  "error": {
    "type": "invalid_request_error",
    "code": "INVALID_RODENT_TARGET",
    "message": "Invalid rodent_target. Must be one of: rat, mouse",
    "param": "rodent_target",
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - æ— æ³•æ¨èï¼ˆrodent_target=unknownï¼‰
{
  "error": {
    "type": "invalid_request_error",
    "code": "UNKNOWN_RODENT_NOT_SUPPORTED",
    "message": "Cannot provide recommendations when rodent_target is 'unknown'. Please identify the rodent type first (rat or mouse) before requesting recommendations.",
    "param": "rodent_target",
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - è¯·æ±‚è¶…æ—¶
{
  "error": {
    "type": "api_error",
    "code": "REQUEST_TIMEOUT",
    "message": "The recommendation generation took too long. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```

```json é”™è¯¯ - LLM ä½™é¢ä¸è¶³
{
  "error": {
    "type": "api_error",
    "code": "LLM_QUOTA_EXCEEDED",
    "message": "LLM service quota exceeded. Please contact support or try again later.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/trap-recommendations"
  }
}
```
</ResponseExample>

## ä½¿ç”¨è¯´æ˜

è¿™æ˜¯æ•´ä¸ª"å·¥å…·ç­–ç•¥é˜¶æ®µ"çš„æ ¸å¿ƒæ¥å£ï¼Œæ ¹æ®ç”¨æˆ·æƒ…å†µæä¾›æ™ºèƒ½æ¨èï¼š

<Tabs>
  <Tab title="è¯†åˆ«ç°æœ‰å·¥å…·">
    å½“ `mode = "existing_trap"` æ—¶ï¼š
    - è¯†åˆ«ç”¨æˆ·ç°æœ‰å·¥å…·çš„ç±»å‹
    - è¯„ä¼°æ˜¯å¦é€‚åˆå½“å‰ rodent
    - å¦‚ä¸é€‚åˆï¼ŒåŒæ—¶ç»™å‡ºè´­ä¹°å»ºè®®åˆ—è¡¨

    **å¿…å¡«å­—æ®µï¼š** `mode`ã€`rodent_target`ã€`media_asset_id`
  </Tab>
  <Tab title="æ¨èè´­ä¹°">
    å½“ `mode = "no_trap"` æ—¶ï¼š
    - åªåŸºäº rodent + åœ°åŒº + åå¥½æ¨èè´­ä¹°æ–¹æ¡ˆ
    - è¿”å›é€‚åˆçš„ trap åˆ—è¡¨åŠè´­ä¹°æç¤º

    **å¿…å¡«å­—æ®µï¼š** `mode`ã€`rodent_target`
  </Tab>
</Tabs>

<Warning>
**é‡è¦ï¼šrodent_target å¿…é¡»æ˜ç¡®**

- `rodent_target` åªæ¥å— `"rat"` æˆ– `"mouse"`
- **ä¸æ”¯æŒ `"unknown"`**ï¼šå½“è€é¼ ç§ç±»æœªçŸ¥æ—¶ï¼ŒLLM æ— æ³•åšå‡ºæœ‰æ•ˆçš„æ¨è
- å¦‚æœä¼ å…¥ `"unknown"`ï¼ŒAPI ä¼šè¿”å› `400 UNKNOWN_RODENT_NOT_SUPPORTED` é”™è¯¯
- **å»ºè®®æµç¨‹**ï¼šå…ˆä½¿ç”¨è¯†åˆ«æ¥å£ï¼ˆå¦‚æ‹ç…§ä¸Šä¼ ï¼‰ç¡®å®šè€é¼ ç§ç±»ï¼Œå†è°ƒç”¨æ¨èæ¥å£
</Warning>

## ç”¨æˆ·åå¥½å‚æ•°

<ParamField body="preferences.avoid_killing" type="boolean">
  `true` è¡¨ç¤ºå¸Œæœ›äººé“æ•æ‰ï¼Œä¸æ€ç”Ÿ
</ParamField>

<ParamField body="preferences.has_children_or_pets" type="boolean">
  å®¶ä¸­æœ‰å°å­©/å® ç‰© â†’ é¿å…æš´éœ²å¼å¼¹ç°§å¤¹
</ParamField>

<ParamField body="preferences.budget_level" type="string">
  é¢„ç®—æ¡£ä½ï¼š`low` / `medium` / `high`
</ParamField>

<ParamField body="preferences.noise_sensitive" type="boolean">
  å¯¹å’”å“’å£°ã€ç”µå‡»å£°æ•æ„Ÿ
</ParamField>

<ParamField body="preferences.maintenance_tolerance" type="string">
  èƒ½æ¥å—çš„ç»´æŠ¤é¢‘ç‡ï¼š`low` / `medium` / `high`
</ParamField>

## é™·é˜±ç±»å‹è¯´æ˜

### `snap_trap` - å¼¹ç°§æ•é¼ å¤¹
ä¼ ç»Ÿæœºæ¢°å¼æ•é¼ å™¨ï¼Œé€šè¿‡å¼ºåŠ›å¼¹ç°§ç¬é—´å‡»æ€ã€‚æ˜¯æœ€ç»å…¸ã€æœ€ç»æµçš„æ•é¼ æ–¹å¼ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… å‡»æ€æ•ˆç‡é«˜ï¼Œä¸€å‡»è‡´å‘½
- âœ… æˆæœ¬æä½ï¼Œå¯é‡å¤ä½¿ç”¨
- âœ… ä¸éœ€è¦ç”µæºæˆ–åŒ–å­¦å“
- âš ï¸ éœ€è¦æ­£ç¡®è®¾ç½®è¯±é¥µå’Œä½ç½®
- âš ï¸ å¯¹å„¿ç«¥å’Œå® ç‰©æœ‰æ½œåœ¨å±é™©
- âš ï¸ æ¸…ç†å°¸ä½“å¯èƒ½ä¸é€‚åˆæ‰€æœ‰ç”¨æˆ·

**é€‚ç”¨åœºæ™¯ï¼š** å¨æˆ¿ã€ä»“åº“ã€è½¦åº“ç­‰å°é—­ç©ºé—´ï¼›é¢„ç®—æœ‰é™çš„ç”¨æˆ·ï¼›ä¸ä»‹æ„æ¥è§¦é¼ å°¸çš„ç”¨æˆ·

---

### `glue_board` - ç²˜é¼ æ¿
è¡¨é¢æ¶‚æœ‰å¼ºåŠ›ç²˜èƒ¶çš„å¹³æ¿ï¼Œè€é¼ è¸©ä¸Šåæ— æ³•è„±èº«ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… ä½¿ç”¨æç®€å•ï¼Œå±•å¼€å³å¯
- âœ… ä»·æ ¼ä¾¿å®œï¼Œä¸€æ¬¡æ€§ä½¿ç”¨
- âœ… å¯åŒæ—¶æ•è·å¤šåªå°é¼ 
- âœ… æ— éœ€è®¾ç½®æœºå…³ï¼Œä¸ä¼šè¯¯ä¼¤
- âš ï¸ è€é¼ ä¼šé•¿æ—¶é—´æŒ£æ‰ï¼Œä¸å¤Ÿäººé“
- âš ï¸ ç²˜æ€§ä¼šæ²¾æŸ“ç°å°˜å½±å“æ•ˆæœ
- âš ï¸ å¤§è€é¼ å¯èƒ½æŒ£è„±é€ƒèµ°

**é€‚ç”¨åœºæ™¯ï¼š** å…¬å¯“èµ°å»Šã€å‚¨è—å®¤ã€åŠå…¬å®¤ï¼›å°å®¶é¼ é—®é¢˜ï¼›å¸Œæœ›é¿å…æœºæ¢°è£…ç½®çš„ç”¨æˆ·

---

### `cage_trap` - æ•é¼ ç¬¼/æ´»æ‰ç¬¼
å•å‘é—¨è®¾è®¡çš„é‡‘å±ç¬¼ï¼Œè€é¼ è¿›å…¥åæ— æ³•é€€å‡ºï¼Œä½†ä¸ä¼šå—ä¼¤ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… å®Œå…¨äººé“ï¼Œä¸æ€ç”Ÿ
- âœ… å¯é‡å¤ä½¿ç”¨ï¼Œç¯ä¿
- âœ… å¯¹å„¿ç«¥å’Œå® ç‰©å®‰å…¨
- âœ… é€‚åˆæ•è·åæ”¾ç”Ÿæˆ–é€å…»
- âš ï¸ éœ€è¦å®šæœŸæ£€æŸ¥
- âš ï¸ éœ€è¦å¤„ç†æ´»é¼ (å¸¦ç¦»æ”¾ç”Ÿ)
- âš ï¸ ä»·æ ¼ç›¸å¯¹è¾ƒé«˜

**é€‚ç”¨åœºæ™¯ï¼š** å®¶ä¸­æœ‰å°å­©æˆ–å® ç‰©ï¼›ä½›æ•™å¾’/ç´ é£Ÿä¸»ä¹‰è€…ï¼›å†œæ‘ç¯å¢ƒå¯å°±åœ°æ”¾ç”Ÿï¼›éœ€è¦ç¡®è®¤é¼ ç§çš„ç§‘ç ”ç”¨é€”

---

### `electronic_trap` - ç”µå‡»æ•é¼ å™¨
ä½¿ç”¨é«˜å‹ç”µæµç¬é—´å‡»æ€ï¼Œç°ä»£åŒ–çš„ç”µå­æ•é¼ è£…ç½®ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… å‡»æ€è¿…é€Ÿ(2ç§’å†…)ï¼Œç›¸å¯¹äººé“
- âœ… æ¸…æ´å«ç”Ÿï¼Œä¸è§è¡€
- âœ… å¯é‡å¤ä½¿ç”¨ï¼Œé•¿æœŸæˆæœ¬ä½
- âœ… éƒ¨åˆ†å‹å·æœ‰å‡»æ€æŒ‡ç¤ºç¯
- âš ï¸ éœ€è¦ç”µæ± æˆ–ç”µæº
- âš ï¸ ä»·æ ¼è¾ƒé«˜(NT$1000-3000)
- âš ï¸ éœ€è¦å®šæœŸæ¸…ç†å†…éƒ¨

**é€‚ç”¨åœºæ™¯ï¼š** é¤å…å¨æˆ¿ã€åŒ»ç–—åœºæ‰€ç­‰é«˜å«ç”Ÿè¦æ±‚ç¯å¢ƒï¼›é¢„ç®—å……è¶³çš„å®¶åº­ç”¨æˆ·ï¼›ä¸æƒ³æ¥è§¦é¼ å°¸çš„ç”¨æˆ·

---

### `bucket_trap` - æ°´æ¡¶é™·é˜±
åˆ©ç”¨è€é¼ æ”€çˆ¬ä¹ æ€§ï¼Œè¯±å¯¼å…¶è·³å…¥æ·±æ¡¶æˆ–æ°´æ¡¶ä¸­å›°ä½æˆ–æººæ­»ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… å¯ä»¥ DIY åˆ¶ä½œï¼Œæˆæœ¬æä½
- âœ… ä¸€æ¬¡å¯æ•è·å¤šåªè€é¼ 
- âœ… é€‚åˆæˆ·å¤–æˆ–å¤§ç©ºé—´ä½¿ç”¨
- âš ï¸ éœ€è¦ä¸€å®šçš„åˆ¶ä½œæŠ€å·§
- âš ï¸ å ç”¨ç©ºé—´è¾ƒå¤§
- âš ï¸ å¦‚ä½¿ç”¨æººæ°´æ–¹å¼è¾ƒä¸äººé“
- âš ï¸ å®¤å†…ä½¿ç”¨å¯èƒ½ä¸ç¾è§‚

**é€‚ç”¨åœºæ™¯ï¼š** å†œåœºã€ä»“åº“ã€å·¥åœ°ç­‰å¤§ç©ºé—´ï¼›è€é¼ æ•°é‡è¾ƒå¤šçš„æƒ…å†µï¼›å–œæ¬¢ DIY çš„ç”¨æˆ·ï¼›é¢„ç®—ææœ‰é™çš„åœºæ™¯

---

### `poison_bait` - æ¯’é¥µ/é¼ è¯
å«æœ‰æŠ—å‡è¡€å‰‚æˆ–ç¥ç»æ¯’ç´ çš„é£Ÿç‰©è¯±é¥µï¼Œè€é¼ é£Ÿç”¨åä¼šåœ¨æ•°å¤©å†…æ­»äº¡ã€‚

**ç‰¹ç‚¹ï¼š**
- âœ… å¯å¤§èŒƒå›´å¸ƒç½®
- âœ… ä¸éœ€è¦æœºæ¢°è£…ç½®
- âœ… å¯¹ä¸¥é‡é¼ æ‚£æ•ˆæœæ˜¾è‘—
- âš ï¸ å¯¹å„¿ç«¥å’Œå® ç‰©æåº¦å±é™©
- âš ï¸ è€é¼ å¯èƒ½æ­»åœ¨å¢™å†…æˆ–éšè”½å¤„äº§ç”Ÿæ¶è‡­
- âš ï¸ ä¸ç¬¦åˆäººé“ä¸»ä¹‰åŸåˆ™
- âš ï¸ å¯èƒ½å½±å“é£Ÿç‰©é“¾(çŒ«å¤´é¹°ã€çŒ«ç­‰æ•é£Ÿè€…äºŒæ¬¡ä¸­æ¯’)

**é€‚ç”¨åœºæ™¯ï¼š** ä»“åº“ã€å·¥å‚ç­‰æ— äººå±…ä½åŒºåŸŸï¼›ä¸¥é‡é¼ æ‚£ä¸”å…¶ä»–æ–¹æ³•æ— æ•ˆï¼›**ä¸æ¨èå®¶åº­ä½¿ç”¨**

<Warning>
**æ¯’é¥µä½¿ç”¨é™åˆ¶ï¼š**
- ğŸš« ç¦æ­¢åœ¨æœ‰å„¿ç«¥æˆ–å® ç‰©çš„ç¯å¢ƒä½¿ç”¨
- ğŸš« ç¦æ­¢åœ¨é£Ÿå“åŠ å·¥åŒºåŸŸä½¿ç”¨
- âš ï¸ å¿…é¡»æ”¾ç½®åœ¨ä¸“ç”¨æ¯’é¥µç«™å†…ï¼Œé¿å…è¯¯é£Ÿ
- âš ï¸ å¿…é¡»éµå®ˆå½“åœ°æ³•è§„(éƒ¨åˆ†åœ°åŒºé™åˆ¶é”€å”®)
</Warning>

---

### `other` - å…¶ä»–ç±»å‹
åŒ…æ‹¬è¶…å£°æ³¢é©±é¼ å™¨ã€å¤©ç„¶é©±é¿å‰‚ã€æ•é¼ çŠ¬/çŒ«ç­‰éä¸»æµæ–¹å¼ã€‚

**ç‰¹ç‚¹ï¼š**
- è¶…å£°æ³¢é©±é¼ å™¨: æ•ˆæœå­˜ç–‘ï¼Œç§‘å­¦è¯æ®ä¸è¶³
- å¤©ç„¶é©±é¿å‰‚(è–„è·æ²¹ã€æ¨Ÿè„‘ç­‰): åªèƒ½çŸ­æœŸé©±èµ¶ï¼Œæ— æ³•æ ¹é™¤
- ç”Ÿç‰©é˜²æ²»(çŒ«): éœ€è¦é•¿æœŸé¥²å…»ï¼Œæ•ˆæœå› çŒ«è€Œå¼‚

**é€‚ç”¨åœºæ™¯ï¼š** ä½œä¸ºè¾…åŠ©æ‰‹æ®µé…åˆå…¶ä»–é™·é˜±ä½¿ç”¨ï¼›è½»å¾®é¼ æ‚£çš„é¢„é˜²é˜¶æ®µ

## existing_trap åˆ†æç»“æœ

å½“ `mode = "existing_trap"` æ—¶ï¼Œå“åº”ä¸­åŒ…å« `existing_trap` å¯¹è±¡ï¼š

<ResponseField name="existing_trap.detected_type" type="string">
  è¯†åˆ«å‡ºçš„é™·é˜±ç±»å‹
</ResponseField>

<ResponseField name="existing_trap.is_suitable" type="boolean">
  æ˜¯å¦é€‚åˆå½“å‰ rodent_target + ç”¨æˆ·ç¯å¢ƒ
</ResponseField>

<ResponseField name="existing_trap.suitability_score" type="number">
  0â€“1 ä¹‹é—´çš„è¯„åˆ†ï¼Œç”¨äºå‰ç«¯å±•ç¤ºä¿¡å¿ƒæ¡
</ResponseField>

<ResponseField name="existing_trap.notes" type="string">
  ç»™ç”¨æˆ·çš„è§£é‡Šè¯´æ˜
</ResponseField>

## é”™è¯¯å“åº”

| åœºæ™¯ | HTTP çŠ¶æ€ç  | Error Code | è¯´æ˜ |
|-----|------------|------------|------|
| LLM æœåŠ¡å¤±è´¥ | 503 | `LLM_SERVICE_ERROR` | AI æ¨èæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• |
| å›¾ç‰‡æ— æ³•è¯†åˆ« | 400 | `MEDIA_RECOGNITION_FAILED` | æ— æ³•ä»ç…§ç‰‡ä¸­è¯†åˆ«æ•é¼ å™¨ï¼Œå»ºè®®é‡æ–°æ‹æ‘„æ›´æ¸…æ™°çš„ç…§ç‰‡ |
| Media Asset ä¸å­˜åœ¨ | 404 | `MEDIA_NOT_FOUND` | ç…§ç‰‡ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç”¨æˆ· |
| ç¼ºå°‘å¿…å¡«å­—æ®µ | 400 | `VALIDATION_ERROR` | è¯·æ±‚å‚æ•°ä¸å®Œæ•´ |
| æ— æ•ˆæšä¸¾å€¼ | 400 | `INVALID_RODENT_TARGET` ç­‰ | å‚æ•°å€¼ä¸åœ¨å…è®¸çš„æšä¸¾èŒƒå›´å†… |
| è¯·æ±‚è¶…æ—¶ | 504 | `REQUEST_TIMEOUT` | AI å¤„ç†è¶…æ—¶ï¼Œè¯·ç®€åŒ–è¯·æ±‚æˆ–ç¨åé‡è¯• |

<Warning>
**å‰ç«¯é”™è¯¯å¤„ç†å»ºè®®ï¼š**
- `LLM_SERVICE_ERROR` / `REQUEST_TIMEOUT`: æ˜¾ç¤º"æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"ï¼Œæä¾›é‡è¯•æŒ‰é’®
- `MEDIA_RECOGNITION_FAILED`: æç¤ºç”¨æˆ·"ç…§ç‰‡ä¸æ¸…æ™°ï¼Œè¯·é‡æ–°æ‹æ‘„"ï¼Œè¿”å›æ‹ç…§ç•Œé¢
- `MEDIA_NOT_FOUND`: æç¤ºç”¨æˆ·é‡æ–°ä¸Šä¼ ç…§ç‰‡
- `VALIDATION_ERROR`: æ ¹æ® `param` å­—æ®µé«˜äº®å¯¹åº”çš„è¾“å…¥æ¡†
</Warning>

---

## æµ‹è¯•èµ„æº

### Preview ç¯å¢ƒæµ‹è¯•æ•°æ®ï¼ˆæ¨èä½¿ç”¨ï¼‰

<Note>
**å›¾ç‰‡ä¸Šä¼ è¯´æ˜ - existing_trap æ¨¡å¼çš„å›¾ç‰‡æ¥æº**

`existing_trap` æ¨¡å¼éœ€è¦æä¾›ç°æœ‰æ•é¼ å™¨çš„ç…§ç‰‡ï¼Œæ”¯æŒä»¥ä¸‹ä¸¤ç§æ–¹å¼ä¸Šä¼ å›¾ç‰‡ï¼š

1. **é€šè¿‡ [media-assets æ¥å£](/api/create-media-asset) ä¸Šä¼ **ï¼ˆæ¨èï¼‰
2. **ç›´æ¥åœ¨ HTTP è¯·æ±‚ä¸­åŒ…å«å›¾ç‰‡æ•°æ®**ï¼ˆBase64 ç¼–ç ï¼‰

âš ï¸ **é‡è¦**: åç«¯ä¸å†é¢„å…ˆå‡†å¤‡æµ‹è¯•å›¾ç‰‡ï¼Œæ‰€æœ‰å›¾ç‰‡å¿…é¡»é€šè¿‡ä»¥ä¸Šä¸¤ç§æ–¹å¼ä¸Šä¼ ã€‚
</Note>

#### æµ‹è¯•ç”¨æˆ·è´¦å·

| å­—æ®µ | å€¼ |
|------|-----|
| Email | `test@example.com` |
| Password | `test1234` |
| User ID | åŠ¨æ€ç”Ÿæˆï¼ˆæ¯ä¸ª PR ç¯å¢ƒç‹¬ç«‹ï¼‰ |

---

### å¿«é€Ÿæµ‹è¯•æµç¨‹ï¼ˆPreview ç¯å¢ƒï¼‰

#### æ­¥éª¤ 1: ç™»å½•è·å– JWT Token

```bash
curl -X POST "https://vwinvkxxheuexvpvzibt.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test1234"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "expires_in": 3600,
  "refresh_token": "...",
  "user": {
    "id": "dynamic-user-id",
    "email": "test@example.com"
  }
}
```

ä¿å­˜ `access_token` ç”¨äºåç»­ API è°ƒç”¨ã€‚

#### æ­¥éª¤ 2: ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼ˆä½¿ç”¨ media-assets æ¥å£ï¼‰

```bash
# 2.1 åˆ›å»ºåª’ä½“èµ„æºè·å–ä¸Šä¼  URL
MEDIA_RESPONSE=$(curl -X POST "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "purpose": "setup",
    "content_type": "image/png",
    "metadata": {}
  }')

# æå– upload_url å’Œ media_asset_id
UPLOAD_URL=$(echo $MEDIA_RESPONSE | jq -r '.upload_url')
MEDIA_ID=$(echo $MEDIA_RESPONSE | jq -r '.id')

# 2.2 ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶
curl -X PUT "$UPLOAD_URL" \
  -H "Content-Type: image/png" \
  --data-binary "@path/to/your/trap-image.png"

# 2.3 è®°å½• MEDIA_ID ç”¨äºåç»­æ­¥éª¤
echo "media_asset_id: $MEDIA_ID"
```

<Check>
**æ¨èä½¿ç”¨ media-assets æ¥å£** - æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ï¼ˆJPEG/PNG/WebPï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆé¢„ç­¾å URLï¼Œå®‰å…¨å¯é 
</Check>

#### æ­¥éª¤ 3: æµ‹è¯• existing_trap æ¨¡å¼ï¼ˆä½¿ç”¨ä¸Šä¼ çš„ media_asset_idï¼‰

```bash
curl -X POST "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-recommendations" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "existing_trap",
    "rodent_target": "mouse",
    "media_asset_id": "'"$MEDIA_ID"'"
  }'
```

#### æ­¥éª¤ 4: æµ‹è¯• no_trap æ¨¡å¼

```bash
curl -X POST "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-recommendations" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "no_trap",
    "rodent_target": "rat",
    "preferences": {
      "avoid_killing": true,
      "has_children_or_pets": true,
      "budget_level": "medium"
    }
  }'
```

---

### Python è‡ªåŠ¨åŒ–æµ‹è¯•ç¤ºä¾‹ï¼ˆPreview ç¯å¢ƒï¼‰

```python
import requests

# Preview ç¯å¢ƒé…ç½®
BASE_URL = "https://vwinvkxxheuexvpvzibt.supabase.co"
ANON_KEY = "your_anon_key_here"

# 1. ç™»å½•è·å– token
login_response = requests.post(
    f"{BASE_URL}/auth/v1/token?grant_type=password",
    headers={
        "apikey": ANON_KEY,
        "Content-Type": "application/json"
    },
    json={
        "email": "test@example.com",
        "password": "test1234"
    }
)

token = login_response.json()["access_token"]
print(f"âœ… ç™»å½•æˆåŠŸï¼ŒToken: {token[:20]}...")

# 2. æµ‹è¯• existing_trap æ¨¡å¼ï¼ˆä½¿ç”¨é¢„ç½®çš„ media_asset_idï¼‰
existing_trap_response = requests.post(
    f"{BASE_URL}/functions/v1/trap-recommendations",
    headers={
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    },
    json={
        "mode": "existing_trap",
        "rodent_target": "mouse",
        "media_asset_id": "your_media_asset_id"  # ä½¿ç”¨ POST /media-assets è·å–çš„ ID
    }
)

result = existing_trap_response.json()
print(f"âœ… è¯†åˆ«ç»“æœ: {result['existing_trap']['detected_type']}")
print(f"âœ… é€‚é…è¯„åˆ†: {result['existing_trap']['suitability_score']}")

# 3. æµ‹è¯• no_trap æ¨¡å¼
no_trap_response = requests.post(
    f"{BASE_URL}/functions/v1/trap-recommendations",
    headers={
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json"
    },
    json={
        "mode": "no_trap",
        "rodent_target": "rat",
        "preferences": {
            "avoid_killing": True,
            "budget_level": "medium"
        }
    }
)

recommendations = no_trap_response.json()
print(f"âœ… æ¨èæ•°é‡: {len(recommendations['recommended_traps'])}")
```

---

---

### æœ¬åœ°æµ‹è¯•å›¾ç‰‡

<Note>
**æµ‹è¯•å›¾ç‰‡ä¿¡æ¯**
- **æ–‡ä»¶å**: rat_tape.png
- **å›¾ç‰‡å†…å®¹**: ç²˜é¼ æ¿æ•é¼ å™¨å®æ‹ç…§ç‰‡
- **æ–‡ä»¶å¤§å°**: 160 KB
- **å­˜æ”¾ä½ç½®**: `rattrap-api/test-assets/rat_tape.png`
- **é™·é˜±ç±»å‹**: `glue_board` (ç²˜é¼ æ¿)
- **é€‚ç”¨ç›®æ ‡**: `rat` (å¤§é¼ )
</Note>

### å®Œæ•´æµ‹è¯•æµç¨‹ï¼ˆå«å›¾ç‰‡ä¸Šä¼ ï¼‰

#### æ­¥éª¤ 1: ç™»å½•è·å– JWT Token

```bash
curl -X POST "https://vwinvkxxheuexvpvzibt.supabase.co/auth/v1/token?grant_type=password" \
  -H "apikey: YOUR_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test1234"
  }'
```

ä¿å­˜è¿”å›çš„ `access_token` ç”¨äºåç»­æ­¥éª¤ã€‚

#### æ­¥éª¤ 2: è·å–æµ‹è¯•å›¾ç‰‡

ä»æ–‡æ¡£ä»“åº“è·å–æµ‹è¯•å›¾ç‰‡ï¼š

```bash
# æ–¹å¼ 1: ä»æœ¬åœ°æ–‡æ¡£ä»“åº“å¤åˆ¶
cp rattrap-api/test-assets/rat_tape.png ./test_trap_image.png

# æ–¹å¼ 2: ä» GitHub ä¸‹è½½ï¼ˆå‡è®¾æ–‡æ¡£å·²å‘å¸ƒï¼‰
curl -O https://raw.githubusercontent.com/your-org/docs/main/rattrap-api/test-assets/rat_tape.png
```

#### æ­¥éª¤ 3: ä¸Šä¼ å›¾ç‰‡è·å– media_asset_id

é€šè¿‡ [create-media-asset](/api/create-media-asset) æ¥å£ä¸Šä¼ å›¾ç‰‡ï¼š

```bash
# 3.1 åˆ›å»ºåª’ä½“èµ„æºï¼Œè·å–ä¸Šä¼  URL
MEDIA_RESPONSE=$(curl -X POST https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "purpose": "setup",
    "content_type": "image/png",
    "metadata": {"test": true}
  }')

# 3.2 æå– upload_url å’Œ media_asset_id
UPLOAD_URL=$(echo $MEDIA_RESPONSE | jq -r '.upload_url')
MEDIA_ID=$(echo $MEDIA_RESPONSE | jq -r '.id')

# 3.3 ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶åˆ°é¢„ç­¾å URL
curl -X PUT "$UPLOAD_URL" \
  -H "Content-Type: image/png" \
  --data-binary "@rat_tape.png"

# 3.4 ç¡®è®¤ä¸Šä¼ æˆåŠŸ
echo "âœ… media_asset_id: $MEDIA_ID"
```

å“åº”ç¤ºä¾‹ï¼ˆæ­¥éª¤ 3.1ï¼‰ï¼š
```json
{
  "id": "e6931f9d-63dd-4664-a914-930bb0c98e4f",
  "object": "media_asset",
  "purpose": "setup",
  "upload_url": "https://vwinvkxxheuexvpvzibt.supabase.co/storage/v1/object/upload/sign/trap-media/...",
  "url": "https://vwinvkxxheuexvpvzibt.supabase.co/storage/v1/object/public/trap-media/...",
  "created": 1764489204
}
```

#### æ­¥éª¤ 4: ä½¿ç”¨ media_asset_id æµ‹è¯•æ¨èæ¥å£

ä½¿ç”¨è·å–åˆ°çš„ `media_asset_id` æµ‹è¯•æ•é¼ å™¨è¯†åˆ«ï¼š

```bash
curl -X POST https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-recommendations \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "existing_trap",
    "rodent_target": "rat",
    "media_asset_id": "'"$MEDIA_ID"'"
  }'
```

**é¢„æœŸå“åº”**ï¼š

API åº”è¯¥è¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ª `glue_board`ï¼ˆç²˜é¼ æ¿ï¼‰ï¼Œå¹¶ç»™å‡ºé€‚é…æ€§åˆ†æå’Œæ¨èï¼š

```json
{
  "object": "trap_recommendation_result",
  "mode": "existing_trap",
  "rodent_target": "rat",
  "existing_trap": {
    "object": "existing_trap_analysis",
    "media_asset_id": "ma_abc123xyz456",
    "detected_type": "glue_board",
    "is_suitable": true,
    "suitability_score": 0.75,
    "notes": "è¯†åˆ«ä¸ºç²˜é¼ æ¿ã€‚å¯¹å¤§é¼ æœ‰ä¸€å®šæ•ˆæœï¼Œä½†å»ºè®®ä½¿ç”¨æ›´å¤§å·çš„ç²˜æ¿æˆ–é…åˆä½¿ç”¨å¼¹ç°§å¤¹ã€‚"
  },
  "recommended_traps": [
    {
      "object": "trap_product",
      "id": "trp_glue_large_01",
      "trap_type": "glue_board",
      "label": "åŠ å¤§å·å¼ºåŠ›ç²˜é¼ æ¿",
      "description": "ä¸“ä¸ºå¤§é¼ è®¾è®¡çš„è¶…å¤§ç²˜æ¿ï¼Œç²˜æ€§æ›´å¼º...",
      "for_rodent": "rat",
      "suitability_score": 0.90,
      "recommended_reason": "æ¯”æ‚¨ç°æœ‰çš„ç²˜æ¿é¢ç§¯æ›´å¤§ï¼Œç²˜æ€§æ›´å¼ºï¼Œå¯¹å¤§é¼ æ•è·ç‡æ›´é«˜"
    }
  ]
}
```

### æµ‹è¯•æ³¨æ„äº‹é¡¹

<Warning>
**é‡è¦æç¤º**

1. **media_asset_id æ˜¯ä¸€æ¬¡æ€§çš„**: æ¯æ¬¡ä¸Šä¼ å›¾ç‰‡éƒ½ä¼šç”Ÿæˆæ–°çš„ IDï¼Œä¸èƒ½é‡å¤ä½¿ç”¨å›ºå®š ID
2. **æµ‹è¯•æ•°æ®éš”ç¦»**: æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ media assets æ˜¯åˆ†å¼€çš„
3. **è®¤è¯è¦æ±‚**: æµ‹è¯•æ—¶éœ€è¦ä½¿ç”¨æœ‰æ•ˆçš„ JWT Token
4. **å›¾ç‰‡è¦æ±‚**:
   - æ ¼å¼ï¼šPNG, JPG, JPEG
   - å¤§å°ï¼šæœ€å¤§ 5 MB
   - å†…å®¹ï¼šå¿…é¡»åŒ…å«æ¸…æ™°çš„æ•é¼ å™¨å›¾åƒ
</Warning>

### è‡ªåŠ¨åŒ–æµ‹è¯•ç¤ºä¾‹

å¦‚æœä½ ä½¿ç”¨ Python è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä»£ç ï¼š

```python
import requests

BASE_URL = "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1"
AUTH_TOKEN = "your_jwt_token_here"

# 1. ä¸Šä¼ æµ‹è¯•å›¾ç‰‡
with open("rattrap-api/test-assets/rat_tape.png", "rb") as f:
    upload_response = requests.post(
        f"{BASE_URL}/media-assets",
        files={"file": f},
        data={"asset_type": "trap_image"},
        headers={"Authorization": f"Bearer {AUTH_TOKEN}"}
    )

media_asset_id = upload_response.json()["id"]
print(f"âœ… ä¸Šä¼ æˆåŠŸï¼Œmedia_asset_id: {media_asset_id}")

# 2. æµ‹è¯•æ•é¼ å™¨è¯†åˆ«
recommendation_response = requests.post(
    f"{BASE_URL}/trap-recommendations",
    json={
        "mode": "existing_trap",
        "rodent_target": "rat",
        "media_asset_id": media_asset_id
    },
    headers={
        "Authorization": f"Bearer {AUTH_TOKEN}",
        "Content-Type": "application/json"
    }
)

result = recommendation_response.json()
print(f"âœ… è¯†åˆ«ç»“æœï¼š{result['existing_trap']['detected_type']}")
print(f"âœ… é€‚é…è¯„åˆ†ï¼š{result['existing_trap']['suitability_score']}")
```

### æµ‹è¯•å›¾ç‰‡é¢„è§ˆ

æµ‹è¯•å›¾ç‰‡å†…å®¹å¦‚ä¸‹ï¼ˆç²˜é¼ æ¿å®æ‹ï¼‰ï¼š

![æµ‹è¯•ç”¨ç²˜é¼ æ¿å›¾ç‰‡](../test-assets/rat_tape.png)

**å›¾ç‰‡è¯´æ˜**ï¼š
- æ•é¼ å™¨ç±»å‹ï¼šç²˜é¼ æ¿ (glue_board)
- æ‹æ‘„è§’åº¦ï¼šä¿¯è§† 45 åº¦è§’
- èƒŒæ™¯ï¼šå®¤å†…åœ°é¢
- ç”¨é€”ï¼šæµ‹è¯• existing_trap æ¨¡å¼çš„å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
