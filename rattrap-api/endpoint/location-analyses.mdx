---
title: '分析放置位置'
openapi: 'POST /location-analyses'
---

<RequestExample>
```bash cURL
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: loc-analysis-7f9b4bde-47c2-4ff0-9b0c-eed1d72ff001" \
  -d '{
    "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
    "media_asset_id": "ma_room_1PpTqQx2YwZv9kLb",
    "rodent_target": "rat",
    "trap_type": "snap_trap",
    "bait_type": "peanut_butter",
    "user_location": {
      "country": "TW",
      "city": "Taipei",
      "environment": "apartment"
    },
    "options": {
      "max_zones": 2,
      "language": "zh-CN"
    }
  }'
```

```javascript Node.js
const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses", {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${accessToken}`,
    "Content-Type": "application/json",
    "Idempotency-Key": `loc-analysis-${crypto.randomUUID()}`
  },
  body: JSON.stringify({
    setup_session_id: sessionId,
    media_asset_id: roomPhotoId,
    rodent_target: "rat",
    trap_type: "snap_trap",
    bait_type: "peanut_butter",
    options: {
      max_zones: 2,
      language: "zh-CN"
    }
  })
});

const analysis = await res.json();
// 使用 analysis.placement_text 显示文字说明
// 使用 analysis.annotated_media_asset_id 加载标注图
```
</RequestExample>

<ResponseExample>
```json 成功响应
{
  "object": "location_analysis",
  "id": "loc_1RasJr2f9hQe8KmN",
  "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
  "media_asset_id": "ma_room_1PpTqQx2YwZv9kLb",
  "annotated_media_asset_id": "ma_room_annotated_9DzXcP4v",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "bait_type": "peanut_butter",
  "placement_text": "建议将老鼠夹放置在冰箱右侧沿墙根位置，距离墙角约 10 厘米，夹子垂直于墙摆放，诱饵一端朝向墙角。请确保陷阱紧贴墙面，并避免被垃圾桶或杂物挡住。",
  "zones": [
    {
      "id": "zone_A",
      "label": "推荐点位 A",
      "priority": 1,
      "confidence": 0.93,
      "description": "冰箱右侧墙角附近，靠近电线和小孔洞，是老鼠常走的贴墙路线。",
      "bounding_box": {
        "x": 0.62,
        "y": 0.48,
        "width": 0.18,
        "height": 0.20
      },
      "distance_to_wall_cm": 0,
      "orientation_hint": "trap_perpendicular_to_wall_bait_towards_corner"
    },
    {
      "id": "zone_B",
      "label": "备选点位 B",
      "priority": 2,
      "confidence": 0.78,
      "description": "水槽下方橱柜前的墙根位置，适合作为第二个陷阱或备用位置。",
      "bounding_box": {
        "x": 0.15,
        "y": 0.60,
        "width": 0.20,
        "height": 0.15
      },
      "distance_to_wall_cm": 0,
      "orientation_hint": "trap_parallel_to_wall"
    }
  ],
  "notes": "房间整体较整洁，可优先在冰箱附近放置第一个陷阱。",
  "created": 1764039000
}
```

```json 错误 - 缺少必填字段
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "media_asset_id is required",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - Media Asset 不存在
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_NOT_FOUND",
    "message": "The specified media_asset_id does not exist or does not belong to the current user",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - 图片分析失败
{
  "error": {
    "type": "invalid_request_error",
    "code": "ROOM_RECOGNITION_FAILED",
    "message": "Unable to analyze the room photo. Please provide a clearer wide-angle photo showing walls and floor clearly.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - 未找到合适位置
{
  "error": {
    "type": "invalid_request_error",
    "code": "NO_SUITABLE_LOCATION",
    "message": "Could not identify suitable trap placement locations in this photo. Please try a different angle or room.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - LLM 服务失败
{
  "error": {
    "type": "api_error",
    "code": "LLM_SERVICE_ERROR",
    "message": "Failed to analyze location. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - LLM 余额不足
{
  "error": {
    "type": "api_error",
    "code": "LLM_QUOTA_EXCEEDED",
    "message": "LLM service quota exceeded. Please contact support or try again later.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - 图片标注失败
{
  "error": {
    "type": "api_error",
    "code": "IMAGE_ANNOTATION_FAILED",
    "message": "Location analysis completed but failed to generate annotated image. Returning text-only result.",
    "param": "annotated_media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```
</ResponseExample>

## 使用说明

这是「位置侦查阶段」的核心接口。AI 会对用户拍摄的房间全景照片进行视觉分析，生成：

<CardGroup cols={3}>
  <Card title="文字说明" icon="align-left">
    详细的放置指导文案 (`placement_text`)
  </Card>
  <Card title="标注图片" icon="image">
    在原图上标出推荐区域 (`annotated_media_asset_id`)
  </Card>
  <Card title="结构化数据" icon="code">
    bounding boxes 供前端高级可视化 (`zones`)
  </Card>
</CardGroup>

---

## 图片上传流程

使用本接口前，需要先上传房间照片：

<Steps>
  <Step title="创建媒体资源">
    调用 `POST /media-assets` 创建媒体资源并获取 `upload_url`

    ```javascript
    const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        purpose: "setup",  // 位置分析属于 setup 阶段
        content_type: "image/jpeg",
        metadata: {
          usage: "location_analysis",
          room_type: "kitchen"  // 可选：标注房间类型
        }
      })
    });
    const mediaAsset = await res.json();
    ```
  </Step>

  <Step title="上传图片到预签名 URL">
    使用返回的 `upload_url` 上传图片

    ```javascript
    await fetch(mediaAsset.upload_url, {
      method: "PUT",
      headers: { "Content-Type": "image/jpeg" },
      body: imageBlob
    });
    ```
  </Step>

  <Step title="调用位置分析接口">
    使用 `media_asset_id` 调用本接口

    ```javascript
    const analysisRes = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "Idempotency-Key": `loc-analysis-${crypto.randomUUID()}`
      },
      body: JSON.stringify({
        media_asset_id: mediaAsset.id,
        rodent_target: "rat",
        trap_type: "snap_trap",
        bait_type: "peanut_butter",
        options: {
          max_zones: 2,
          language: "zh-CN"
        }
      })
    });
    ```
  </Step>

  <Step title="获取标注图片">
    使用返回的 `annotated_media_asset_id` 获取带标注的图片

    ```javascript
    const analysis = await analysisRes.json();

    // 构建标注图片 URL
    const annotatedImageUrl = `https://vwinvkxxheuexvpvzibt.supabase.co/storage/v1/object/public/media-assets/${analysis.annotated_media_asset_id}`;

    // 在前端显示
    document.getElementById('annotated-image').src = annotatedImageUrl;
    document.getElementById('placement-text').textContent = analysis.placement_text;
    ```
  </Step>
</Steps>

<Note>
**关于图片上传的重要说明**

1. **必须先创建 media asset**：不能直接传 media_asset_id，必须先通过 `POST /media-assets` 接口创建资源
2. **预签名 URL 有效期**：upload_url 有 15 分钟有效期，需要在创建后及时上传
3. **认证要求**：media asset 和用户绑定，只能使用自己上传的图片
4. **图片要求**：建议使用广角拍摄，确保墙面、地面清晰可见，避免过暗或模糊
</Note>

---

## 必填字段说明

<Warning>
**必填字段**

- ✅ `media_asset_id` - 房间照片 ID（必须先通过 `/media-assets` 上传）
- ✅ `rodent_target` - 目标鼠种 (rat / mouse / unknown)
- ✅ `trap_type` - 陷阱类型 (snap_trap / glue_board / cage_trap / electronic_trap / other)

**可选但推荐的字段**

- `bait_type` - 诱饵类型，帮助 AI 考虑陷阱朝向
- `setup_session_id` - 关联到布防会话，便于后续追踪
- `user_location` - 用户位置信息，帮助 AI 考虑地域特点
- `options.max_zones` - 返回推荐点位数量（默认 2，最大 5）
- `options.language` - 返回文案的语言（默认 zh-CN）

缺少必填字段会返回 `400 VALIDATION_ERROR`
</Warning>

---

## 前端使用建议

在 **LOC_RESULT** 页面：

1. 用 `placement_text` 做主要说明文案
2. 用 `annotated_media_asset_id` 加载那张带红框的标注图
3. 可选：根据 `zones.bounding_box` 在客户端加动画框 / 点击交互

<Info>
  用户按照提示在现实中放置好陷阱后，点击「我放好了，去检查」进入校准阶段。
</Info>

## zones 结构详解

每个 zone 代表一个候选放置区域：

<ResponseField name="zones[].id" type="string">
  区域 ID，例如 `"zone_A"`
</ResponseField>

<ResponseField name="zones[].priority" type="integer">
  优先级，1 为最高
</ResponseField>

<ResponseField name="zones[].confidence" type="number">
  0–1 之间，AI 对这个点位的信心
</ResponseField>

<ResponseField name="zones[].bounding_box" type="object">
  图片中的矩形区域，用于在前端画框

  ```json
  {
    "x": 0.62,      // 左上角 x，归一化到 0–1
    "y": 0.48,      // 左上角 y
    "width": 0.18,
    "height": 0.20
  }
  ```
</ResponseField>

<ResponseField name="zones[].distance_to_wall_cm" type="number">
  建议陷阱距离墙面的距离（厘米）
</ResponseField>

<ResponseField name="zones[].orientation_hint" type="string">
  陷阱应该如何朝向，例如 `"trap_perpendicular_to_wall_bait_towards_corner"`
</ResponseField>

## options 参数

<ParamField body="options.max_zones" type="integer" default="2">
  返回几个推荐点位，最大 5
</ParamField>

<ParamField body="options.language" type="string" default="zh-CN">
  `placement_text` 的语言
</ParamField>

<ParamField body="options.need_heatmap" type="boolean" default="false">
  是否返回热力图（未来扩展）
</ParamField>

## 错误响应

| 场景 | HTTP 状态码 | Error Code | 说明 |
|-----|------------|------------|------|
| LLM 服务失败 | 503 | `LLM_SERVICE_ERROR` | AI 分析服务暂时不可用，请稍后重试 |
| LLM 余额不足 | 503 | `LLM_QUOTA_EXCEEDED` | AI 服务配额已用尽，请联系技术支持 |
| 图片分析失败 | 400 | `ROOM_RECOGNITION_FAILED` | 无法分析房间照片，建议重新拍摄更清晰的广角照片 |
| 未找到合适位置 | 400 | `NO_SUITABLE_LOCATION` | 未能识别出合适的陷阱放置位置，建议换个角度或房间拍摄 |
| 图片标注失败 | 500 | `IMAGE_ANNOTATION_FAILED` | 位置分析完成但标注图片生成失败，仅返回文字结果 |
| Media Asset 不存在 | 404 | `MEDIA_NOT_FOUND` | 照片不存在或不属于当前用户 |
| 缺少必填字段 | 400 | `VALIDATION_ERROR` | 请求参数不完整 |
| 请求超时 | 504 | `REQUEST_TIMEOUT` | AI 处理超时，请简化图片或稍后重试 |
| 未授权访问 | 401 | `UNAUTHORIZED` | 缺少或无效的 Authorization header |

<Warning>
**前端错误处理建议：**
- `LLM_SERVICE_ERROR` / `LLM_QUOTA_EXCEEDED` / `REQUEST_TIMEOUT`: 显示"服务繁忙，请稍后重试"，提供重试按钮
- `ROOM_RECOGNITION_FAILED` / `NO_SUITABLE_LOCATION`: 提示用户"照片不清晰或未找到合适位置，请重新拍摄"，返回拍照界面
- `IMAGE_ANNOTATION_FAILED`: 显示文字说明，隐藏标注图片（部分降级）
- `MEDIA_NOT_FOUND`: 提示用户重新上传照片
- `VALIDATION_ERROR`: 根据 `param` 字段高亮对应的输入框
- `UNAUTHORIZED`: 引导用户重新登录
</Warning>

---

## AI 分析逻辑说明

<Note>
**本接口使用 LLM（大语言模型）+ 计算机视觉进行分析**

### 分析考虑因素
1. **墙角和墙根**：老鼠喜欢沿墙移动，墙角是高优先级位置
2. **洞口和缝隙**：电线孔、管道口、门缝等是老鼠出入口
3. **食物源附近**：冰箱旁、垃圾桶附近、厨房区域
4. **障碍物**：避免被家具、杂物遮挡的位置
5. **陷阱类型**：不同陷阱需要不同的空间和朝向
6. **鼠种特性**：rat（大鼠）和 mouse（小鼠）的活动路径不同

### 输出内容
1. **placement_text**：详细的文字说明，包括具体距离、朝向、注意事项
2. **annotated_media_asset_id**：在原图上用红框/箭头标注推荐区域的图片
3. **zones**：结构化数据，包含 bounding box、优先级、置信度等

### 性能说明
- 图片分析 + 标注生成通常需要 10-20 秒
- 复杂场景（多个房间、杂乱环境）可能需要 20-30 秒
- 超过 45 秒会返回 `REQUEST_TIMEOUT` 错误

### 质量保证
- 每个推荐位置都有 `confidence` 评分（0-1）
- 优先级排序：priority=1 为最佳位置
- 如果置信度过低（<0.5），系统会返回 `NO_SUITABLE_LOCATION` 错误
</Note>

---

## 幂等性建议

建议对「同一房间照片 + 同一上下文」的分析使用相同 `Idempotency-Key`：
- 避免重复调用 AI，节约成本
- 用户在前端刷新 LOC_RESULT 页面时保持结果一致

<Tip>
**推荐的幂等键格式**：`loc-analysis-${setupSessionId}-${mediaAssetId}`

这样同一个 setup session 中对同一张照片的多次分析会复用结果。
</Tip>

---

## 测试资源

### 房间照片示例

用于测试位置分析的示例图片：

<Frame>
  <img src="/test-assets/room.jpg" alt="测试用房间照片" />
</Frame>

**使用方法**：
1. 下载此图片到本地
2. 通过 `POST /media-assets` 接口上传（`purpose: "setup"`）
3. 使用返回的 `media_asset_id` 调用本接口

**测试脚本示例**：
```python
# 1. 创建媒体资源
response = requests.post(
    f"{BASE_URL}/media-assets",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={"purpose": "setup", "content_type": "image/jpeg", "metadata": {"usage": "location_analysis"}}
)
media_id = response.json()['id']
upload_url = response.json()['upload_url']

# 2. 上传图片
with open('room.jpg', 'rb') as f:
    requests.put(upload_url, headers={"Content-Type": "image/jpeg"}, data=f)

# 3. 调用位置分析接口
response = requests.post(
    f"{BASE_URL}/location-analyses",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={
        "media_asset_id": media_id,
        "rodent_target": "rat",
        "trap_type": "snap_trap",
        "options": {"max_zones": 2, "language": "zh-CN"}
    }
)
```
