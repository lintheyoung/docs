---
title: '分析放置位置'
openapi: 'POST /location-analyses'
---

<RequestExample>
```bash cURL
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: loc-analysis-7f9b4bde-47c2-4ff0-9b0c-eed1d72ff001" \
  -d '{
    "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
    "media_asset_id": "ma_room_1PpTqQx2YwZv9kLb",
    "rodent_target": "rat",
    "trap_type": "snap_trap",
    "bait_type": "peanut_butter",
    "user_location": {
      "country": "TW",
      "city": "Taipei",
      "environment": "apartment"
    },
    "options": {
      "language": "zh-CN"
    }
  }'
```

```javascript Node.js
const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses", {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${accessToken}`,
    "Content-Type": "application/json",
    "Idempotency-Key": `loc-analysis-${crypto.randomUUID()}`
  },
  body: JSON.stringify({
    setup_session_id: sessionId,
    media_asset_id: roomPhotoId,
    rodent_target: "rat",
    trap_type: "snap_trap",
    bait_type: "peanut_butter",
    options: {
      language: "zh-CN"
    }
  })
});

const analysis = await res.json();
// 使用 analysis.recommendations 显示摆放建议列表
// 使用 analysis.summary 显示总结说明
```
</RequestExample>

<ResponseExample>
```json 成功响应
{
  "object": "location_analysis",
  "id": "loc_1RasJr2f9hQe8KmN",
  "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
  "media_asset_id": "ma_room_1PpTqQx2YwZv9kLb",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "bait_type": "peanut_butter",
  "summary": "根据您上传的房间照片，我们识别出这是一个厨房环境。建议优先在墙角和隐蔽处放置陷阱，老鼠通常沿墙壁移动并喜欢在黑暗处活动。",
  "recommendations": [
    {
      "id": "rec_1",
      "title": "沿墙角放置",
      "priority": 1,
      "reason": "老鼠倾向沿着墙壁移动，墙角是它们的必经之路",
      "tips": [
        "靠近墙角放置，陷阱紧贴墙面",
        "保持出入动线通畅，不要被杂物遮挡",
        "距离食源（冰箱、垃圾桶）10-30 厘米"
      ]
    },
    {
      "id": "rec_2",
      "title": "隐蔽的黑暗处",
      "priority": 2,
      "reason": "老鼠喜欢在隐蔽、安静的地方活动",
      "tips": [
        "放在橱柜下方或后面",
        "放在冰箱后面或侧面",
        "保持周围环境安静"
      ]
    },
    {
      "id": "rec_3",
      "title": "管道和电线孔附近",
      "priority": 3,
      "reason": "这些是老鼠进出房间的常见入口",
      "tips": [
        "检查墙壁上的管道孔洞",
        "在电线穿墙处附近放置",
        "陷阱开口朝向孔洞方向"
      ]
    }
  ],
  "placement_tips": {
    "orientation": "陷阱垂直于墙面放置，诱饵端朝向墙角",
    "distance_to_wall": "紧贴墙面或距离墙面不超过 5 厘米",
    "quantity_suggestion": "建议在厨房放置 2-3 个陷阱，覆盖不同角落"
  },
  "environment_analysis": {
    "room_type": "kitchen",
    "risk_level": "medium",
    "identified_features": ["冰箱", "橱柜", "墙角"]
  },
  "created": 1764039000
}
```

```json 错误 - 缺少必填字段
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "media_asset_id is required",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - Media Asset 不存在
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_NOT_FOUND",
    "message": "The specified media_asset_id does not exist or does not belong to the current user",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - 图片分析失败
{
  "error": {
    "type": "invalid_request_error",
    "code": "ROOM_RECOGNITION_FAILED",
    "message": "Unable to analyze the room photo. Please provide a clearer wide-angle photo showing walls and floor clearly.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - LLM 服务失败
{
  "error": {
    "type": "api_error",
    "code": "LLM_SERVICE_ERROR",
    "message": "Failed to analyze location. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```

```json 错误 - LLM 余额不足
{
  "error": {
    "type": "api_error",
    "code": "LLM_QUOTA_EXCEEDED",
    "message": "LLM service quota exceeded. Please contact support or try again later.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/location-analyses"
  }
}
```
</ResponseExample>

## 使用说明

这是「位置侦查阶段」的核心接口。AI 会对用户拍摄的房间照片进行分析，识别房间类型和环境特征，然后返回通用的陷阱摆放建议。

<CardGroup cols={2}>
  <Card title="摆放建议" icon="list-check">
    结构化的建议列表 (`recommendations`)，包含标题、原因和具体技巧
  </Card>
  <Card title="环境分析" icon="magnifying-glass">
    识别房间类型和风险等级 (`environment_analysis`)
  </Card>
</CardGroup>

<Info>
**注意**：本接口不会返回图片中的具体坐标位置，而是根据房间类型和环境特征，提供通用的摆放策略和建议。用户需要根据建议自行选择具体的放置位置。
</Info>

---

## 图片上传流程

使用本接口前，需要先上传房间照片：

<Steps>
  <Step title="创建媒体资源">
    调用 `POST /media-assets` 创建媒体资源并获取 `upload_url`

    ```javascript
    const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        purpose: "setup",
        content_type: "image/jpeg",
        metadata: {}
      })
    });
    const mediaAsset = await res.json();
    ```
  </Step>

  <Step title="上传图片到预签名 URL">
    使用返回的 `upload_url` 上传图片

    ```javascript
    await fetch(mediaAsset.upload_url, {
      method: "PUT",
      headers: { "Content-Type": "image/jpeg" },
      body: imageBlob
    });
    ```
  </Step>

  <Step title="调用位置分析接口">
    使用 `media_asset_id` 调用本接口

    ```javascript
    const analysisRes = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/location-analyses", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "Idempotency-Key": `loc-analysis-${crypto.randomUUID()}`
      },
      body: JSON.stringify({
        media_asset_id: mediaAsset.id,
        rodent_target: "rat",
        trap_type: "snap_trap"
      })
    });
    ```
  </Step>
</Steps>

---

## 请求参数

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `media_asset_id` | string | ✅ | 房间照片 ID（必须先通过 `/media-assets` 上传） |
| `rodent_target` | string | ✅ | 目标鼠种：`rat` / `mouse` / `unknown` |
| `trap_type` | string | ✅ | 陷阱类型：`snap_trap` / `glue_board` / `cage_trap` / `electronic_trap` / `other` |
| `bait_type` | string | | 诱饵类型，帮助 AI 提供更针对性的建议 |
| `setup_session_id` | string | | 关联到布防会话，便于后续追踪 |
| `user_location` | object | | 用户位置信息，帮助 AI 考虑地域特点 |
| `options.language` | string | | 返回文案的语言（默认 `zh-CN`） |

<Warning>
缺少必填字段会返回 `400 VALIDATION_ERROR`
</Warning>

---

## 响应字段说明

### 顶层字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 分析记录 ID，格式: `loc_xxx` |
| `object` | string | 固定值 `"location_analysis"` |
| `summary` | string | 总结说明，概述房间情况和整体建议 |
| `recommendations` | array | 摆放建议列表，按优先级排序 |
| `placement_tips` | object | 通用摆放技巧 |
| `environment_analysis` | object | 环境分析结果 |
| `created` | integer | 创建时间戳（Unix timestamp） |

### recommendations 结构

每个建议包含：

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 建议 ID，如 `rec_1` |
| `title` | string | 建议标题，如「沿墙角放置」 |
| `priority` | integer | 优先级，1 为最高 |
| `reason` | string | 为什么推荐这个位置 |
| `tips` | array | 具体操作建议列表 |

### placement_tips 结构

| 字段 | 类型 | 说明 |
|------|------|------|
| `orientation` | string | 陷阱朝向建议 |
| `distance_to_wall` | string | 距离墙面的建议 |
| `quantity_suggestion` | string | 建议放置数量 |

### environment_analysis 结构

| 字段 | 类型 | 说明 |
|------|------|------|
| `room_type` | string | 识别的房间类型：`kitchen` / `bathroom` / `storage` / `bedroom` / `living_room` / `garage` / `other` |
| `risk_level` | string | 风险等级：`low` / `medium` / `high` |
| `identified_features` | array | 识别到的环境特征列表 |

---

## 前端使用建议

在 **LOC_RESULT** 页面：

1. 用 `summary` 做顶部的总结说明
2. 用 `recommendations` 渲染建议卡片列表
3. 用 `placement_tips` 显示通用摆放技巧
4. 可选：根据 `environment_analysis.room_type` 显示对应的图标

```jsx
// React 示例
function LocationResult({ analysis }) {
  return (
    <div>
      <p className="summary">{analysis.summary}</p>

      {analysis.recommendations.map(rec => (
        <Card key={rec.id}>
          <h3>{rec.title}</h3>
          <p className="reason">{rec.reason}</p>
          <ul>
            {rec.tips.map((tip, i) => <li key={i}>{tip}</li>)}
          </ul>
        </Card>
      ))}

      <div className="tips">
        <p>朝向：{analysis.placement_tips.orientation}</p>
        <p>距墙：{analysis.placement_tips.distance_to_wall}</p>
        <p>数量：{analysis.placement_tips.quantity_suggestion}</p>
      </div>
    </div>
  );
}
```

<Info>
用户阅读建议后，点击「我放好了，去检查」进入校准阶段。
</Info>

---

## 错误响应

| 场景 | HTTP 状态码 | Error Code | 说明 |
|-----|------------|------------|------|
| 缺少必填字段 | 400 | `VALIDATION_ERROR` | 请求参数不完整 |
| Media Asset 不存在 | 404 | `MEDIA_NOT_FOUND` | 照片不存在或不属于当前用户 |
| 图片分析失败 | 400 | `ROOM_RECOGNITION_FAILED` | 无法分析房间照片，建议重新拍摄 |
| LLM 服务失败 | 503 | `LLM_SERVICE_ERROR` | AI 分析服务暂时不可用 |
| LLM 余额不足 | 503 | `LLM_QUOTA_EXCEEDED` | AI 服务配额已用尽 |
| 请求超时 | 504 | `REQUEST_TIMEOUT` | AI 处理超时 |
| 未授权访问 | 401 | `UNAUTHORIZED` | 缺少或无效的 Authorization header |

---

## AI 分析逻辑说明

<Note>
**本接口使用 LLM（大语言模型）进行分析**

### 分析流程
1. **房间识别**：识别照片中的房间类型（厨房、卫生间、储藏室等）
2. **特征提取**：识别环境特征（冰箱、橱柜、管道等）
3. **风险评估**：根据环境特征评估鼠患风险等级
4. **建议生成**：根据鼠种、陷阱类型和环境特征生成摆放建议

### 考虑因素
- **鼠种特性**：rat（大鼠）和 mouse（小鼠）的活动习性不同
- **陷阱类型**：不同陷阱需要不同的摆放策略
- **环境特征**：根据识别到的家具、电器等提供针对性建议
- **地域因素**：如果提供了 `user_location`，会考虑地域特点

### 性能说明
- 分析通常需要 5-15 秒
- 超过 45 秒会返回 `REQUEST_TIMEOUT` 错误
</Note>

---

## 幂等性建议

建议对「同一房间照片 + 同一上下文」的分析使用相同 `Idempotency-Key`：

<Tip>
**推荐的幂等键格式**：`loc-analysis-${setupSessionId}-${mediaAssetId}`

这样同一个 setup session 中对同一张照片的多次分析会复用结果。
</Tip>

---

## 测试资源

### 房间照片示例

用于测试位置分析的示例图片：

<Frame>
  <img src="/images/room.jpg" alt="测试用房间照片" />
</Frame>

**测试脚本示例**：
```python
# 1. 创建媒体资源
response = requests.post(
    f"{BASE_URL}/media-assets",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={"purpose": "setup", "content_type": "image/jpeg", "metadata": {}}
)
media_id = response.json()['id']
upload_url = response.json()['upload_url']

# 2. 上传图片
with open('room.jpg', 'rb') as f:
    requests.put(upload_url, headers={"Content-Type": "image/jpeg"}, data=f)

# 3. 调用位置分析接口
response = requests.post(
    f"{BASE_URL}/location-analyses",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={
        "media_asset_id": media_id,
        "rodent_target": "rat",
        "trap_type": "snap_trap"
    }
)
print(response.json())
```
