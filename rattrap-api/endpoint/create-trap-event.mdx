---
title: '创建陷阱事件'
openapi: 'POST /trap-events'
---

<RequestExample>
```bash cURL - 检查事件（带照片）
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-events \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "trap_id": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7",
    "event_type": "check",
    "media_id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "details": {
      "result": "empty",
      "bait_condition": "good"
    }
  }'
```

```bash cURL - 检查事件（不带照片）
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-events \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "trap_id": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7",
    "event_type": "check",
    "details": {
      "result": "empty",
      "bait_condition": "good"
    }
  }'
```

```bash cURL - 捕获事件
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-events \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "trap_id": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7",
    "event_type": "catch",
    "details": {
      "rodent_type": "rat",
      "disposal_method": "disposed"
    }
  }'
```

```bash cURL - 补饵事件
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/trap-events \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "trap_id": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7",
    "event_type": "rebait",
    "details": {
      "new_bait_type": "peanut_butter",
      "reason": "expired"
    }
  }'
```
</RequestExample>

<ResponseExample>
```json 成功响应
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "object": "trap_event",
  "trap_id": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7",
  "event_type": "check",
  "media_id": "b2c3d4e5-f678-9012-bcde-f12345678901",
  "details": {
    "result": "empty",
    "bait_condition": "good"
  },
  "recorded_at": 1764300000,
  "created": 1764300000
}
```

```json 404 错误 - 陷阱不存在
{
  "error": {
    "type": "invalid_request_error",
    "code": "TRAP_NOT_FOUND",
    "message": "Trap not found",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/trap-events"
  }
}
```

```json 400 错误 - 无效事件类型
{
  "error": {
    "type": "invalid_request_error",
    "code": "INVALID_EVENT_TYPE",
    "message": "Invalid event_type. Must be one of: deployment, check, catch, miss, rebait, maintenance",
    "param": "event_type",
    "doc_url": "https://docs.rattrap.ai/api/trap-events"
  }
}
```
</ResponseExample>

## 使用说明

记录陷阱相关的各种事件，用于追踪历史和更新状态。

<Info>
`trap_id` 使用 UUID 格式（如 `3c175d6d-d5af-4070-b73a-c9a5ab8e37e7`）。
</Info>

## 请求参数

<ParamField body="trap_id" type="string" required>
  陷阱 ID（UUID 格式）
</ParamField>

<ParamField body="event_type" type="string" required>
  事件类型：`deployment` / `check` / `catch` / `miss` / `rebait` / `maintenance`
</ParamField>

<ParamField body="media_id" type="string">
  关联的媒体资源 ID（UUID 格式），如检查照片、捕获证据照片。使用 `POST /media-assets` 返回的 `id` 字段。

  <Note>
  如果提供 `media_id`，后端会验证该媒体资源是否存在，不存在则返回 400 错误。
  </Note>
</ParamField>

<ParamField body="details" type="object">
  事件详情，结构根据事件类型不同而变化
</ParamField>

## 事件类型

| 类型 | 说明 | 触发场景 |
|------|------|----------|
| `deployment` | 部署完成 | 从 Session 创建陷阱时**自动创建**（无需手动调用） |
| `check` | 检查 | 用户定期检查陷阱 |
| `catch` | 捕获 | 成功捕获老鼠 |
| `miss` | 空触发 | 触发但未捕获 |
| `rebait` | 补饵 | 更换或补充诱饵 |
| `maintenance` | 维护 | 清洁、调整、修复等 |

<Warning>
`deployment` 事件由 `POST /create-trap-from-session` 自动创建，前端通常不需要手动调用。
</Warning>

## 各事件类型的 details 结构

<Tabs>
  <Tab title="check">
    **基础检查**（不使用 AI）：
    ```json
    {
      "result": "empty",        // empty / triggered / caught
      "bait_condition": "good", // good / degraded / gone / expired
      "notes": "一切正常"
    }
    ```

    **AI 智能巡检**（使用 `POST /trap-checks` 后）：
    ```json
    {
      "result": "empty",
      "bait_condition": "good",
      "ai_diagnosis": "neophobia",  // neophobia / bait_stolen / false_trigger / escape
      "ai_confidence": 0.89,
      "recommended_next_check_hours": 240,
      "notes": "AI 诊断：静默期，建议保持现状"
    }
    ```

    <Note>
    如果使用了 AI 巡检，建议在 `details` 中包含 AI 分析结果。后端会根据 `recommended_next_check_hours` 自动更新 `trap.next_check_at`。
    </Note>
  </Tab>
  <Tab title="catch">
    **基础捕获记录**（不使用 AI）：
    ```json
    {
      "rodent_type": "rat",           // rat / mouse / unknown
      "disposal_method": "disposed",  // disposed / released / pending
      "notes": "在厨房捕获一只大鼠"
    }
    ```

    **AI 智能巡检**（使用 `POST /trap-checks` 后）：
    ```json
    {
      "rodent_type": "rat",
      "disposal_method": "disposed",
      "ai_identified_species": "rat",
      "ai_subspecies": "Norway rat",
      "ai_confidence": 0.92,
      "ai_sex": "male",
      "ai_estimated_weight_grams": 280,
      "notes": "AI 识别：成年雄性挪威鼠"
    }
    ```

    <Note>
    如果使用了 AI 巡检，建议在 `details` 中包含 AI 识别结果，方便后续数据分析和统计。
    </Note>
  </Tab>
  <Tab title="rebait">
    ```json
    {
      "new_bait_type": "peanut_butter",
      "reason": "expired",  // expired / eaten / preventive
      "notes": "更换为新鲜花生酱"
    }
    ```
  </Tab>
  <Tab title="maintenance">
    ```json
    {
      "action": "cleaned",  // cleaned / adjusted / repaired / relocated
      "notes": "清理了陷阱周围的灰尘"
    }
    ```
  </Tab>
</Tabs>

## 响应字段

<ResponseField name="id" type="string">
  事件 ID（UUID 格式）
</ResponseField>

<ResponseField name="object" type="string">
  固定值 `"trap_event"`
</ResponseField>

<ResponseField name="trap_id" type="string">
  关联的陷阱 ID（UUID 格式）
</ResponseField>

<ResponseField name="event_type" type="string">
  事件类型：`deployment` / `check` / `catch` / `miss` / `rebait` / `maintenance`
</ResponseField>

<ResponseField name="media_id" type="string | null">
  关联的媒体资源 ID
</ResponseField>

<ResponseField name="details" type="object">
  事件详情
</ResponseField>

<ResponseField name="recorded_at" type="integer">
  事件发生时间（Unix 时间戳，秒）
</ResponseField>

<ResponseField name="created" type="integer">
  记录创建时间（Unix 时间戳，秒）
</ResponseField>

## 事件创建后的副作用

创建事件后，系统会自动更新关联陷阱的状态和统计数据：

| 事件类型 | 陷阱字段更新 |
|---------|-------------|
| `check` | `last_checked_at` ← 当前时间<br/>`next_check_at` ← 根据 `details.recommended_next_check_hours` 计算（如果提供），否则使用默认规则<br/>`last_check_media_id` ← `media_id`（如果提供） |
| `catch` | `status` ← `triggered_caught`<br/>`stats_catches` ← +1<br/>`last_checked_at` ← 当前时间 |
| `miss` | `stats_misses` ← +1<br/>`last_checked_at` ← 当前时间 |
| `rebait` | `bait_type` ← `details.new_bait_type`（如果提供）<br/>`last_checked_at` ← 当前时间 |
| `maintenance` | `last_checked_at` ← 当前时间 |
| `deployment` | 无额外更新（由创建陷阱流程处理） |

<Note>
所有会更新 `last_checked_at` 的事件也会同时更新 `last_check_media_id`（如果请求中提供了 `media_id`）。
</Note>

## 错误响应

| 场景 | HTTP 状态码 | Error Code | 说明 |
|-----|------------|------------|------|
| 陷阱不存在 | 404 | `TRAP_NOT_FOUND` | trap_id 不存在或不属于当前用户 |
| 无效事件类型 | 400 | `INVALID_EVENT_TYPE` | event_type 不是有效的枚举值 |
| 缺少必填字段 | 400 | `VALIDATION_ERROR` | 缺少 trap_id 或 event_type |
| 无效 media_id 格式 | 400 | `VALIDATION_ERROR` | media_id 不是有效的 UUID 格式 |
| 媒体资源不存在 | 400 | `VALIDATION_ERROR` | media_id 指向的媒体资源不存在或不属于当前用户 |
| 未认证 | 401 | `UNAUTHORIZED` | 缺少或无效的 Authorization header |

## 建议的检查流程

<Steps>
  <Step title="拍照">
    用户拍摄陷阱当前状态，调用 `POST /media-assets` 获取 `media_id`
  </Step>
  <Step title="选择结果">
    用户选择检查结果：空 / 触发 / 捕获
  </Step>
  <Step title="创建事件">
    调用 `POST /trap-events` 记录事件
  </Step>
  <Step title="处理后续">
    - 如果是捕获：引导用户处理并可能重新布防
    - 如果是空触发：提示可能需要调整位置
    - 如果诱饵不佳：引导补饵
  </Step>
</Steps>

## 相关接口

<CardGroup cols={2}>
  <Card title="获取陷阱详情" icon="magnifying-glass" href="/rattrap-api/endpoint/get-trap">
    `GET /traps/{id}`
  </Card>
  <Card title="创建媒体资源" icon="image" href="/rattrap-api/endpoint/create-media-asset">
    `POST /media-assets`
  </Card>
  <Card title="从会话创建陷阱" icon="wand-magic-sparkles" href="/rattrap-api/endpoint/create-trap-from-session">
    `POST /create-trap-from-session`
  </Card>
</CardGroup>
