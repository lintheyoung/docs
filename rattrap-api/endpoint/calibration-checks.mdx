---
title: 'æ ¡å‡†æ£€æŸ¥'
openapi: 'POST /calibration-checks'
---

<RequestExample>
```bash cURL
curl https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/calibration-checks \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzMyNjE4MDAwLCJpYXQiOjE3MzI2MTQ0MDAsImlzcyI6Imh0dHBzOi8vdndpbnZreHhoZXVleHZwdnppYnQuc3VwYWJhc2UuY28iLCJzdWIiOiJ1c2VyLWlkLWhlcmUifQ.xxx" \
  -H "Content-Type: application/json" \
  -H "Idempotency-Key: calib-check-4a5b8ff9-1b58-4402-b5e5-b2ecb0e5bb10" \
  -d '{
    "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
    "media_asset_id": "ma_calib_1PpTqQx2YwZv9kLb",
    "rodent_target": "rat",
    "trap_type": "snap_trap",
    "bait_type": "peanut_butter",
    "location_context": {
      "recommended_zone_id": "zone_A",
      "recommended_description": "å†°ç®±å³ä¾§æ²¿å¢™ï¼Œè·å¢™è§’çº¦ 10cmï¼Œå¤¹å­å‚ç›´äºå¢™ã€‚",
      "recommended_distance_to_wall_cm": 0
    },
    "options": {
      "language": "zh-CN",
      "need_annotated_image": true,
      "tolerance": "normal"
    }
  }'
```

```javascript Node.js
const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/calibration-checks", {
  method: "POST",
  headers: {
    "Authorization": `Bearer ${accessToken}`,
    "Content-Type": "application/json",
    "Idempotency-Key": `calib-check-${crypto.randomUUID()}`
  },
  body: JSON.stringify({
    setup_session_id: sessionId,
    media_asset_id: trapPhotoId,
    rodent_target: "rat",
    trap_type: "snap_trap",
    bait_type: "peanut_butter",
    location_context: {
      recommended_zone_id: "zone_A",
      recommended_description: "å†°ç®±å³ä¾§æ²¿å¢™ï¼Œè·å¢™è§’çº¦ 10cm"
    },
    options: {
      language: "zh-CN",
      need_annotated_image: true,
      tolerance: "normal"
    }
  })
});

const check = await res.json();
// check.is_correct åˆ¤æ–­å¸ƒç½®æ˜¯å¦åˆæ ¼
// check.issues æŸ¥çœ‹å…·ä½“é—®é¢˜
// check.advice_text æ˜¾ç¤ºç»¼åˆå»ºè®®æ–‡æ¡ˆ
```
</RequestExample>

<ResponseExample>
```json å¸ƒç½®ä¸æ­£ç¡® (CALIB_FAIL)
{
  "object": "calibration_check",
  "id": "calib_1SgF3zD8wQpR6NmK",
  "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
  "media_asset_id": "ma_calib_1PpTqQx2YwZv9kLb",
  "annotated_media_asset_id": "ma_calib_annotated_7YzXcP4v",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "bait_type": "peanut_butter",
  "is_correct": false,
  "confidence": 0.94,
  "placement_match_score": 0.42,
  "issues": [
    {
      "code": "too_far_from_wall",
      "message": "The trap is placed too far away from the wall.",
      "severity": "error",
      "param": "distance_to_wall",
      "metrics": {
        "distance_to_wall_cm": 8,
        "recommended_max_distance_cm": 1
      },
      "suggestion": "å°†é™·é˜±ç»§ç»­å‘å¢™æ ¹æ¨è¿›ï¼Œå°½é‡è´´ç´§å¢™é¢æ‘†æ”¾ã€‚"
    },
    {
      "code": "suboptimal_orientation",
      "message": "The bait is not oriented towards the wall.",
      "severity": "warning",
      "param": "orientation",
      "metrics": {
        "angle_deviation_deg": 20
      },
      "suggestion": "è°ƒæ•´å¤¹å­æ–¹å‘ï¼Œè®©è¯±é¥µä¸€ç«¯æœå‘å¢™è§’æˆ–è€é¼ å¸¸å‡ºçš„ç¼éš™ã€‚"
    }
  ],
  "advice_text": "AI å‘ç°å½“å‰é™·é˜±è·ç¦»å¢™å¤§çº¦ 8 å…¬åˆ†ï¼Œè€é¼ æ›´å–œæ¬¢ç´§è´´å¢™æ ¹ç§»åŠ¨ï¼Œè¿™æ ·çš„è·ç¦»å¯èƒ½ä¼šè¢«ç›´æ¥ç»•è¿‡ã€‚å»ºè®®å°†é™·é˜±æ¨åˆ°ç´§è´´å¢™æ ¹æ‘†æ”¾ï¼Œå¹¶æŠŠè¯±é¥µä¸€ç«¯æœå‘å¢™è§’æˆ–ç¼éš™ï¼Œç„¶åé‡æ–°æ‹ä¸€å¼ ç…§ç‰‡è®©æˆ‘å†æ¬¡æ£€æŸ¥ã€‚",
  "recommended_actions": [
    {
      "code": "move_closer_to_wall",
      "label": "æŠŠé™·é˜±æ¨åˆ°ç´§è´´å¢™é¢",
      "details": "å°†é™·é˜±æ•´ä½“å‘å¢™æ ¹æ¨è¿›ï¼Œç›´è‡³å¤¹å­åº•åº§å®Œå…¨è´´ç´§è¸¢è„šçº¿ã€‚",
      "priority": 1
    },
    {
      "code": "rotate_trap",
      "label": "è°ƒæ•´å¤¹å­æ–¹å‘",
      "details": "æ—‹è½¬é™·é˜±ï¼Œè®©è¯±é¥µä¸€ç«¯æœå‘å¢™è§’æˆ–é¼ æ´æ–¹å‘ã€‚",
      "priority": 2
    }
  ],
  "created": 1764039200
}
```

```json å¸ƒç½®æ­£ç¡® (CALIB_SUCCESS)
{
  "object": "calibration_check",
  "id": "calib_1SgF3zD8wQpR6NmK_ok",
  "setup_session_id": "ss_1Qy8u8CZ7aQp98Xb5WJtR3",
  "media_asset_id": "ma_calib_2_ok",
  "annotated_media_asset_id": "ma_calib_2_ok_annotated",
  "rodent_target": "rat",
  "trap_type": "snap_trap",
  "bait_type": "peanut_butter",
  "is_correct": true,
  "confidence": 0.89,
  "placement_match_score": 0.91,
  "issues": [],
  "advice_text": "å¾ˆå¥½ï¼é™·é˜±å·²ç»ç´§è´´å¢™æ ¹æ‘†æ”¾ï¼Œæ–¹å‘ä¹Ÿæ­£ç¡®ï¼Œè¯±é¥µæœå‘å¢™è§’ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§åŒ–è€é¼ ç»è¿‡æ—¶è¢«è§¦å‘çš„æ¦‚ç‡ã€‚æ¥ä¸‹æ¥åªéœ€è¦æŒ‰ App æé†’å®šæœŸæ£€æŸ¥å’Œè¡¥å……è¯±é¥µå³å¯ã€‚",
  "recommended_actions": [
    {
      "code": "set_reminder",
      "label": "æŒ‰æç¤ºå®šæœŸæ£€æŸ¥é™·é˜±",
      "details": "å»ºè®®æ¯ 2â€“3 å¤©æŸ¥çœ‹ä¸€æ¬¡é™·é˜±ï¼ŒåŠæ—¶å¤„ç†æ•è·å’Œè¡¥å……è¯±é¥µã€‚",
      "priority": 1
    }
  ],
  "created": 1764039300
}
```

```json é”™è¯¯ - ç¼ºå°‘å¿…å¡«å­—æ®µ
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "media_asset_id is required",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - Media Asset ä¸å­˜åœ¨
{
  "error": {
    "type": "invalid_request_error",
    "code": "MEDIA_NOT_FOUND",
    "message": "The specified media_asset_id does not exist or does not belong to the current user",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - æ— æ³•è¯†åˆ«é™·é˜±
{
  "error": {
    "type": "invalid_request_error",
    "code": "TRAP_RECOGNITION_FAILED",
    "message": "Unable to identify a trap in the provided photo. Please provide a clearer close-up photo of the trap placement.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - ç…§ç‰‡æ¨¡ç³Šæˆ–ä¸æ¸…æ™°
{
  "error": {
    "type": "invalid_request_error",
    "code": "IMAGE_QUALITY_INSUFFICIENT",
    "message": "The photo quality is too low for accurate calibration. Please provide a clearer, well-lit photo.",
    "param": "media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - LLM æœåŠ¡å¤±è´¥
{
  "error": {
    "type": "api_error",
    "code": "LLM_SERVICE_ERROR",
    "message": "Failed to perform calibration check. Please try again.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - LLM ä½™é¢ä¸è¶³
{
  "error": {
    "type": "api_error",
    "code": "LLM_QUOTA_EXCEEDED",
    "message": "LLM service quota exceeded. Please contact support or try again later.",
    "param": null,
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - å›¾ç‰‡æ ‡æ³¨å¤±è´¥
{
  "error": {
    "type": "api_error",
    "code": "IMAGE_ANNOTATION_FAILED",
    "message": "Calibration check completed but failed to generate annotated image. Returning text-only result.",
    "param": "annotated_media_asset_id",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```

```json é”™è¯¯ - æ— æ•ˆæšä¸¾å€¼
{
  "error": {
    "type": "invalid_request_error",
    "code": "VALIDATION_ERROR",
    "message": "tolerance must be one of: normal, strict",
    "param": "options.tolerance",
    "doc_url": "https://docs.rattrap.ai/api/calibration-checks"
  }
}
```
</ResponseExample>

## ä½¿ç”¨è¯´æ˜

è¿™æ˜¯ã€Œæ ¡å‡†é˜¶æ®µã€çš„æ ¸å¿ƒæ¥å£ã€‚AI ä¼šå¯¹ç”¨æˆ·æ‹çš„**å·²å¸ƒç½®å¥½çš„é™·é˜±è¿‘æ™¯ç…§ç‰‡**è¿›è¡Œæ ¡å‡†æ£€æŸ¥ï¼š

<CardGroup cols={3}>
  <Card title="åˆæ ¼åˆ¤æ–­" icon="check-circle">
    åˆ¤æ–­å¸ƒç½®æ˜¯å¦æ­£ç¡® (`is_correct`)
  </Card>
  <Card title="é—®é¢˜åˆ†æ" icon="magnifying-glass">
    åˆ—å‡ºå…·ä½“é—®é¢˜å’Œå»ºè®® (`issues`)
  </Card>
  <Card title="æ ‡æ³¨å›¾ç‰‡" icon="image">
    åœ¨åŸå›¾ä¸Šæ ‡æ³¨é—®é¢˜ç‚¹ (`annotated_media_asset_id`)
  </Card>
</CardGroup>

<Check>
  AI ä¼š**çœŸå®åˆ¤æ–­**å¸ƒç½®æ˜¯å¦æ­£ç¡®ï¼Œä¸ä¼š"æ•…æ„å¤±è´¥"
</Check>

---

## å›¾ç‰‡ä¸Šä¼ æµç¨‹

ä½¿ç”¨æœ¬æ¥å£å‰ï¼Œéœ€è¦å…ˆä¸Šä¼ é™·é˜±è¿‘æ™¯ç…§ç‰‡ï¼š

<Steps>
  <Step title="åˆ›å»ºåª’ä½“èµ„æº">
    è°ƒç”¨ `POST /media-assets` åˆ›å»ºåª’ä½“èµ„æºå¹¶è·å– `upload_url`

    ```javascript
    const res = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/media-assets", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        purpose: "setup",  // æ ¡å‡†æ£€æŸ¥å±äº setup é˜¶æ®µ
        content_type: "image/jpeg",
        metadata: {
          usage: "calibration_check",
          trap_type: "snap_trap"  // å¯é€‰ï¼šæ ‡æ³¨é™·é˜±ç±»å‹
        }
      })
    });
    const mediaAsset = await res.json();
    ```
  </Step>

  <Step title="ä¸Šä¼ å›¾ç‰‡åˆ°é¢„ç­¾å URL">
    ä½¿ç”¨è¿”å›çš„ `upload_url` ä¸Šä¼ å›¾ç‰‡

    ```javascript
    await fetch(mediaAsset.upload_url, {
      method: "PUT",
      headers: { "Content-Type": "image/jpeg" },
      body: imageBlob
    });
    ```
  </Step>

  <Step title="è°ƒç”¨æ ¡å‡†æ£€æŸ¥æ¥å£">
    ä½¿ç”¨ `media_asset_id` è°ƒç”¨æœ¬æ¥å£

    ```javascript
    const checkRes = await fetch("https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1/calibration-checks", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json",
        "Idempotency-Key": `calib-check-${crypto.randomUUID()}`
      },
      body: JSON.stringify({
        media_asset_id: mediaAsset.id,
        rodent_target: "rat",
        trap_type: "snap_trap",
        bait_type: "peanut_butter",
        options: {
          language: "zh-CN",
          need_annotated_image: true,
          tolerance: "normal"
        }
      })
    });
    ```
  </Step>

  <Step title="å¤„ç†æ£€æŸ¥ç»“æœ">
    æ ¹æ® `is_correct` åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´

    ```javascript
    const check = await checkRes.json();

    if (check.is_correct) {
      // å¸ƒç½®æ­£ç¡®ï¼Œæ˜¾ç¤ºæˆåŠŸç•Œé¢
      showSuccess(check.advice_text);
    } else {
      // éœ€è¦è°ƒæ•´ï¼Œæ˜¾ç¤ºé—®é¢˜å’Œå»ºè®®
      showIssues(check.issues);
      showAdvice(check.advice_text);

      // å¦‚æœæœ‰æ ‡æ³¨å›¾ç‰‡ï¼Œæ˜¾ç¤ºé—®é¢˜ç‚¹
      if (check.annotated_media_asset_id) {
        const annotatedUrl = `https://vwinvkxxheuexvpvzibt.supabase.co/storage/v1/object/public/media-assets/${check.annotated_media_asset_id}`;
        showAnnotatedImage(annotatedUrl);
      }
    }
    ```
  </Step>
</Steps>

<Note>
**å…³äºå›¾ç‰‡ä¸Šä¼ çš„é‡è¦è¯´æ˜**

1. **å¿…é¡»å…ˆåˆ›å»º media asset**ï¼šä¸èƒ½ç›´æ¥ä¼  media_asset_idï¼Œå¿…é¡»å…ˆé€šè¿‡ `POST /media-assets` æ¥å£åˆ›å»ºèµ„æº
2. **é¢„ç­¾å URL æœ‰æ•ˆæœŸ**ï¼šupload_url æœ‰ 15 åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œéœ€è¦åœ¨åˆ›å»ºååŠæ—¶ä¸Šä¼ 
3. **è®¤è¯è¦æ±‚**ï¼šmedia asset å’Œç”¨æˆ·ç»‘å®šï¼Œåªèƒ½ä½¿ç”¨è‡ªå·±ä¸Šä¼ çš„å›¾ç‰‡
4. **å›¾ç‰‡è¦æ±‚**ï¼šå»ºè®®è¿‘è·ç¦»æ‹æ‘„ï¼Œç¡®ä¿é™·é˜±å’Œå‘¨å›´ç¯å¢ƒæ¸…æ™°å¯è§ï¼Œé¿å…è¿‡æš—æˆ–æ¨¡ç³Š
</Note>

---

## å¿…å¡«å­—æ®µè¯´æ˜

<Warning>
**å¿…å¡«å­—æ®µ**

- âœ… `media_asset_id` - é™·é˜±è¿‘æ™¯ç…§ç‰‡ IDï¼ˆå¿…é¡»å…ˆé€šè¿‡ `/media-assets` ä¸Šä¼ ï¼‰

**å¯é€‰ä½†æ¨èçš„å­—æ®µ**

- `rodent_target` - ç›®æ ‡é¼ ç§ (rat / mouse / unknown)ï¼Œå¸®åŠ© AI åˆ¤æ–­é™·é˜±å¤§å°æ˜¯å¦åˆé€‚
- `trap_type` - é™·é˜±ç±»å‹ï¼Œå¸®åŠ© AI è¿›è¡Œé’ˆå¯¹æ€§æ£€æŸ¥
- `bait_type` - è¯±é¥µç±»å‹ï¼Œå¸®åŠ© AI æ£€æŸ¥è¯±é¥µä½ç½®å’ŒçŠ¶æ€
- `setup_session_id` - å…³è”åˆ°å¸ƒé˜²ä¼šè¯ï¼Œä¾¿äºåç»­è¿½è¸ª
- `location_context` - ä¸Šä¸€é˜¶æ®µçš„æ¨èä½ç½®ä¿¡æ¯ï¼Œå¸®åŠ© AI å¯¹æ¯”å®é™…å¸ƒç½®

ç¼ºå°‘å¿…å¡«å­—æ®µä¼šè¿”å› `400 VALIDATION_ERROR`
</Warning>

---

## åˆ¤æ–­ç»“æœå¤„ç†

<Tabs>
  <Tab title="âœ… is_correct = true">
    å¸ƒç½®æ­£ç¡®ï¼
    - UI æ˜¾ç¤º"å®Œç¾éƒ¨ç½²"ç»¿æ¡
    - æ˜¾ç¤º `advice_text` ä¸­çš„é¼“åŠ±æ–‡æ¡ˆ
    - ç”¨æˆ·ç‚¹å‡»ã€Œå®Œæˆå¸ƒé˜²ã€ååˆ›å»º trap
  </Tab>
  <Tab title="âŒ is_correct = false">
    éœ€è¦è°ƒæ•´ï¼ç”¨æˆ·æœ‰ä¸¤ç§é€‰æ‹©ï¼š
    1. **ã€Œè°ƒæ•´åé‡æ‹ã€** â†’ æ ¹æ® `issues` å’Œ `recommended_actions` è°ƒæ•´ â†’ é‡æ–°æ‹ç…§ â†’ å†æ¬¡è°ƒç”¨æ­¤æ¥å£
    2. **ã€Œè·³è¿‡ï¼Œå…ˆç”¨è¿™æ ·ã€** â†’ ç›´æ¥åˆ›å»º trapï¼ˆæ ‡è®° calibration ä¸å®Œç¾ï¼‰
  </Tab>
</Tabs>

---

## å“åº”å­—æ®µè¯¦è§£

### annotated_media_asset_id

<ResponseField name="annotated_media_asset_id" type="string | null">
  æ ‡æ³¨é—®é¢˜ç‚¹åçš„å›¾ç‰‡èµ„æº IDã€‚

  - **æœ‰æ ‡æ³¨å›¾ç‰‡æ—¶**ï¼šè¿”å›æ–°ç”Ÿæˆçš„ media asset IDï¼Œå¯é€šè¿‡å­˜å‚¨ URL è®¿é—®
  - **æ— æ ‡æ³¨å›¾ç‰‡æ—¶**ï¼šè¿”å› `null`ï¼ˆå½“ `need_annotated_image: false` æˆ–æ ‡æ³¨ç”Ÿæˆå¤±è´¥æ—¶ï¼‰

  **æ ‡æ³¨å†…å®¹åŒ…æ‹¬ï¼š**
  - ğŸ”² **è¾¹ç•Œæ¡†**ï¼šæ¡†å‡ºé™·é˜±ä½ç½®å’Œé—®é¢˜åŒºåŸŸ
  - â¡ï¸ **ç®­å¤´**ï¼šæŒ‡ç¤ºæ­£ç¡®çš„è°ƒæ•´æ–¹å‘
  - ğŸ“ **æ–‡å­—è¯´æ˜**ï¼šç®€çŸ­çš„é—®é¢˜æè¿°ï¼ˆå¦‚"è·å¢™å¤ªè¿œ"ï¼‰

  **è·å–æ ‡æ³¨å›¾ç‰‡ URLï¼š**
  ```javascript
  if (check.annotated_media_asset_id) {
    const annotatedUrl = `https://vwinvkxxheuexvpvzibt.supabase.co/storage/v1/object/public/media-assets/${check.annotated_media_asset_id}`;
    showAnnotatedImage(annotatedUrl);
  }
  ```
</ResponseField>

---

## issues ç»“æ„è¯¦è§£

æ¯ä¸ª issue è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„é—®é¢˜ï¼š

<ResponseField name="issues[].code" type="string">
  æœºå™¨å¯è¯»é—®é¢˜ç ï¼Œä¾‹å¦‚ï¼š
  - `too_far_from_wall` - è·ç¦»å¢™å¤ªè¿œ
  - `wrong_orientation` - æ–¹å‘é”™è¯¯
  - `bait_position_suboptimal` - è¯±é¥µä½ç½®ä¸ä½³
  - `bait_missing` - æœªæ£€æµ‹åˆ°è¯±é¥µ
  - `trap_not_armed` - é™·é˜±æœªè®¾ç½®å¥½ï¼ˆå¼¹ç°§å¤¹æœªæ‹‰å¼€ç­‰ï¼‰
  - `obstruction_detected` - æœ‰éšœç¢ç‰©æŒ¡ä½é™·é˜±
  - `lighting_insufficient` - å…‰çº¿ä¸è¶³ï¼Œæ— æ³•å‡†ç¡®åˆ¤æ–­
</ResponseField>

<ResponseField name="issues[].severity" type="string">
  ä¸¥é‡ç¨‹åº¦ï¼š
  - `error` - ä¸¥é‡é—®é¢˜ï¼Œå¼ºçƒˆå»ºè®®ä¿®æ­£
  - `warning` - æ¬¡è¦é—®é¢˜ï¼Œå»ºè®®ä¼˜åŒ–
  - `info` - æç¤ºä¿¡æ¯ï¼Œå¯å¿½ç•¥
</ResponseField>

<ResponseField name="issues[].metrics" type="object">
  å®šé‡ä¿¡æ¯ï¼Œç»“æ„æ ¹æ® issue code ä¸åŒè€Œå˜åŒ–ã€‚ä»¥ä¸‹æ˜¯å„ç±»é—®é¢˜çš„ metrics ç¤ºä¾‹ï¼š

  **è·ç¦»é—®é¢˜ (`too_far_from_wall`)ï¼š**
  ```json
  {
    "distance_to_wall_cm": 8,
    "recommended_max_distance_cm": 1
  }
  ```

  **æ–¹å‘é—®é¢˜ (`wrong_orientation`, `suboptimal_orientation`)ï¼š**
  ```json
  {
    "angle_deviation_deg": 20,
    "recommended_orientation": "perpendicular_to_wall"
  }
  ```

  **è¯±é¥µé—®é¢˜ (`bait_position_suboptimal`)ï¼š**
  ```json
  {
    "bait_visibility_score": 0.3,
    "recommended_position": "center_of_trigger"
  }
  ```

  **éšœç¢ç‰©é—®é¢˜ (`obstruction_detected`)ï¼š**
  ```json
  {
    "obstruction_type": "furniture",
    "clearance_needed_cm": 15
  }
  ```

  <Info>
    `metrics` æ˜¯åŠ¨æ€ç»“æ„ï¼Œå‰ç«¯åº”ä¼˜é›…å¤„ç†æœªçŸ¥å­—æ®µã€‚å»ºè®®ä»¥ `message` å’Œ `suggestion` ä¸ºä¸»è¦å±•ç¤ºå†…å®¹ã€‚
  </Info>
</ResponseField>

<ResponseField name="issues[].suggestion" type="string">
  é’ˆå¯¹è¯¥é—®é¢˜çš„å•æ¡å»ºè®®æ–‡æ¡ˆ
</ResponseField>

## recommended_actions ç»“æ„è¯¦è§£

<ResponseField name="recommended_actions[].code" type="string">
  æ“ä½œä»£ç ï¼Œå¯ç”¨äºå‰ç«¯æŒ‰é’®æ˜ å°„ï¼š
  - `move_closer_to_wall` - é è¿‘å¢™é¢
  - `rotate_trap` - æ—‹è½¬é™·é˜±
  - `add_bait` - æ·»åŠ è¯±é¥µ
  - `arm_trap` - è®¾ç½®é™·é˜±
  - `remove_obstruction` - ç§»é™¤éšœç¢ç‰©
  - `retake_photo` - é‡æ–°æ‹ç…§ï¼ˆå…‰çº¿é—®é¢˜ï¼‰
  - `set_reminder` - è®¾ç½®æ£€æŸ¥æé†’
</ResponseField>

<ResponseField name="recommended_actions[].priority" type="integer">
  ä¼˜å…ˆçº§ï¼Œ1 ä¸ºæœ€é«˜ä¼˜å…ˆçº§
</ResponseField>

<ResponseField name="recommended_actions[].label" type="string">
  æ“ä½œçš„ç®€çŸ­æ ‡ç­¾ï¼Œé€‚åˆç”¨ä½œæŒ‰é’®æ–‡æ¡ˆ
</ResponseField>

<ResponseField name="recommended_actions[].details" type="string">
  è¯¦ç»†è¯´æ˜æ–‡æ¡ˆ
</ResponseField>

## options å‚æ•°

<ParamField body="options.language" type="string" default="zh-CN">
  è¿”å›æ–‡æ¡ˆçš„è¯­è¨€
</ParamField>

<ParamField body="options.need_annotated_image" type="boolean" default="true">
  æ˜¯å¦ç”Ÿæˆæ ‡æ³¨é—®é¢˜ç‚¹çš„å›¾ç‰‡ã€‚

  - è®¾ä¸º `true`ï¼šAI ä¼šåœ¨åŸå›¾ä¸Šç»˜åˆ¶æ ‡æ³¨ï¼ˆè¾¹ç•Œæ¡†ã€ç®­å¤´ã€æ–‡å­—è¯´æ˜ï¼‰ï¼Œç»“æœå­˜å‚¨åœ¨ `annotated_media_asset_id`
  - è®¾ä¸º `false`ï¼šä¸ç”Ÿæˆæ ‡æ³¨å›¾ç‰‡ï¼Œ`annotated_media_asset_id` è¿”å› `null`ï¼Œå¯èŠ‚çœå¤„ç†æ—¶é—´
</ParamField>

<ParamField body="options.tolerance" type="string" default="normal">
  å¯¹"å®Œç¾åº¦"çš„å®¹å¿åº¦ï¼š
  - `normal` - æ­£å¸¸æ ‡å‡†ï¼Œå…è®¸è½»å¾®åå·®
  - `strict` - ä¸¥æ ¼æ ‡å‡†ï¼Œè¦æ±‚ç²¾ç¡®å¸ƒç½®
</ParamField>

## location_context å‚æ•°

å¯ä»¥ä¼ å…¥ä¸Šä¸€é˜¶æ®µ `location_scout_data` çš„æ ¸å¿ƒå†…å®¹ï¼Œæ–¹ä¾¿ AI å¯¹æ¯”å®é™…å¸ƒç½®ä¸æ¨èä½ç½®ï¼š

<ResponseField name="location_context.recommended_zone_id" type="string">
  ä¸Šä¸€é˜¶æ®µæ¨èçš„åŒºåŸŸ IDï¼Œä¾‹å¦‚ `zone_A`
</ResponseField>

<ResponseField name="location_context.recommended_description" type="string">
  æ¨èä½ç½®çš„æ–‡å­—æè¿°ï¼Œä¾‹å¦‚ "å†°ç®±å³ä¾§æ²¿å¢™ï¼Œè·å¢™è§’çº¦ 10cmï¼Œå¤¹å­å‚ç›´äºå¢™ã€‚"
</ResponseField>

<ResponseField name="location_context.recommended_distance_to_wall_cm" type="number">
  æ¨èçš„è·å¢™è·ç¦»ï¼ˆå˜ç±³ï¼‰ï¼Œé€šå¸¸ä¸º 0ï¼ˆè´´å¢™ï¼‰
</ResponseField>

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```json
{
  "location_context": {
    "recommended_zone_id": "zone_A",
    "recommended_description": "å†°ç®±å³ä¾§æ²¿å¢™ï¼Œè·å¢™è§’çº¦ 10cmï¼Œå¤¹å­å‚ç›´äºå¢™ã€‚",
    "recommended_distance_to_wall_cm": 0
  }
}
```

<Info>
  è¯¥å­—æ®µæ˜¯å®Œå…¨å¯é€‰çš„ï¼Œå¦‚æœä¸ä¼ ï¼ŒAI ä»…å‡­å½“å‰ç…§ç‰‡æ¥åšåˆ¤æ–­ã€‚ä¼ å…¥å AI å¯ä»¥å¯¹æ¯”æ¨èä½ç½®å’Œå®é™…ä½ç½®ï¼Œæä¾›æ›´ç²¾ç¡®çš„åé¦ˆã€‚
</Info>

---

## é”™è¯¯å“åº”

| åœºæ™¯ | HTTP çŠ¶æ€ç  | Error Code | è¯´æ˜ |
|-----|------------|------------|------|
| LLM æœåŠ¡å¤±è´¥ | 503 | `LLM_SERVICE_ERROR` | AI æ ¡å‡†æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯• |
| LLM ä½™é¢ä¸è¶³ | 503 | `LLM_QUOTA_EXCEEDED` | AI æœåŠ¡é…é¢å·²ç”¨å°½ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ |
| æ— æ³•è¯†åˆ«é™·é˜± | 400 | `TRAP_RECOGNITION_FAILED` | ç…§ç‰‡ä¸­æœªèƒ½è¯†åˆ«åˆ°é™·é˜±ï¼Œå»ºè®®é‡æ–°æ‹æ‘„æ¸…æ™°çš„è¿‘æ™¯ç…§ç‰‡ |
| ç…§ç‰‡è´¨é‡ä¸è¶³ | 400 | `IMAGE_QUALITY_INSUFFICIENT` | ç…§ç‰‡æ¨¡ç³Šæˆ–å…‰çº¿ä¸è¶³ï¼Œå»ºè®®åœ¨å…‰çº¿å……è¶³çš„ç¯å¢ƒä¸‹é‡æ–°æ‹æ‘„ |
| å›¾ç‰‡æ ‡æ³¨å¤±è´¥ | 500 | `IMAGE_ANNOTATION_FAILED` | æ ¡å‡†æ£€æŸ¥å®Œæˆä½†æ ‡æ³¨å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œä»…è¿”å›æ–‡å­—ç»“æœ |
| Media Asset ä¸å­˜åœ¨ | 404 | `MEDIA_NOT_FOUND` | ç…§ç‰‡ä¸å­˜åœ¨æˆ–ä¸å±äºå½“å‰ç”¨æˆ· |
| ç¼ºå°‘å¿…å¡«å­—æ®µ | 400 | `VALIDATION_ERROR` | è¯·æ±‚å‚æ•°ä¸å®Œæ•´ |
| æ— æ•ˆæšä¸¾å€¼ | 400 | `VALIDATION_ERROR` | å‚æ•°å€¼ä¸åœ¨å…è®¸çš„æšä¸¾èŒƒå›´å†… |
| è¯·æ±‚è¶…æ—¶ | 504 | `REQUEST_TIMEOUT` | AI å¤„ç†è¶…æ—¶ï¼Œè¯·ç®€åŒ–å›¾ç‰‡æˆ–ç¨åé‡è¯• |
| æœªæˆæƒè®¿é—® | 401 | `UNAUTHORIZED` | ç¼ºå°‘æˆ–æ— æ•ˆçš„ Authorization header |

<Warning>
**å‰ç«¯é”™è¯¯å¤„ç†å»ºè®®ï¼š**
- `LLM_SERVICE_ERROR` / `LLM_QUOTA_EXCEEDED` / `REQUEST_TIMEOUT`: æ˜¾ç¤º"æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"ï¼Œæä¾›é‡è¯•æŒ‰é’®
- `TRAP_RECOGNITION_FAILED` / `IMAGE_QUALITY_INSUFFICIENT`: æç¤ºç”¨æˆ·"ç…§ç‰‡ä¸æ¸…æ™°æˆ–æœªè¯†åˆ«åˆ°é™·é˜±ï¼Œè¯·é‡æ–°æ‹æ‘„è¿‘æ™¯ç…§ç‰‡"ï¼Œè¿”å›æ‹ç…§ç•Œé¢
- `IMAGE_ANNOTATION_FAILED`: æ˜¾ç¤ºæ–‡å­—è¯´æ˜å’Œ issuesï¼Œéšè—æ ‡æ³¨å›¾ç‰‡ï¼ˆéƒ¨åˆ†é™çº§ï¼‰
- `MEDIA_NOT_FOUND`: æç¤ºç”¨æˆ·é‡æ–°ä¸Šä¼ ç…§ç‰‡
- `VALIDATION_ERROR`: æ ¹æ® `param` å­—æ®µé«˜äº®å¯¹åº”çš„è¾“å…¥æ¡†
- `UNAUTHORIZED`: å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
</Warning>

---

## AI åˆ†æé€»è¾‘è¯´æ˜

<Note>
**æœ¬æ¥å£ä½¿ç”¨ LLMï¼ˆå¤§è¯­è¨€æ¨¡å‹ï¼‰+ è®¡ç®—æœºè§†è§‰è¿›è¡Œåˆ†æ**

### æ£€æŸ¥è€ƒè™‘å› ç´ 
1. **é™·é˜±è¯†åˆ«**ï¼šè¯†åˆ«ç…§ç‰‡ä¸­çš„é™·é˜±ç±»å‹æ˜¯å¦ä¸å£°æ˜ä¸€è‡´
2. **ä½ç½®åˆ¤æ–­**ï¼šåˆ¤æ–­é™·é˜±æ˜¯å¦é è¿‘å¢™æ ¹ï¼ˆè€é¼ æ²¿å¢™ç§»åŠ¨çš„ä¹ æ€§ï¼‰
3. **æ–¹å‘åˆ¤æ–­**ï¼šåˆ¤æ–­é™·é˜±æœå‘æ˜¯å¦æ­£ç¡®ï¼ˆè¯±é¥µç«¯æœå‘é¢„æœŸè·¯å¾„ï¼‰
4. **è¯±é¥µçŠ¶æ€**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰è¯±é¥µã€è¯±é¥µä½ç½®æ˜¯å¦æ­£ç¡®
5. **éšœç¢ç‰©æ£€æµ‹**ï¼šæ£€æŸ¥å‘¨å›´æ˜¯å¦æœ‰å¯èƒ½é˜»æŒ¡è€é¼ çš„éšœç¢ç‰©
6. **é™·é˜±çŠ¶æ€**ï¼šæ£€æŸ¥é™·é˜±æ˜¯å¦å·²æ­£ç¡®è®¾ç½®ï¼ˆå¼¹ç°§å¤¹æ˜¯å¦æ‹‰å¼€ç­‰ï¼‰

### è¾“å‡ºå†…å®¹
1. **is_correct**ï¼šå¸ƒå°”å€¼ï¼Œåˆ¤æ–­å¸ƒç½®æ˜¯å¦åˆæ ¼
2. **confidence**ï¼šAI å¯¹åˆ¤æ–­ç»“æœçš„ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
3. **placement_match_score**ï¼šå¸ƒç½®ä¸æœ€ä½³å®è·µçš„åŒ¹é…åˆ†æ•°ï¼ˆ0-1ï¼‰
4. **issues**ï¼šå…·ä½“é—®é¢˜åˆ—è¡¨ï¼Œæ¯ä¸ªé—®é¢˜åŒ…å«ä»£ç ã€ä¸¥é‡ç¨‹åº¦ã€å»ºè®®
5. **advice_text**ï¼šç»¼åˆå»ºè®®æ–‡æ¡ˆï¼Œé€‚åˆç›´æ¥æ˜¾ç¤ºç»™ç”¨æˆ·
6. **recommended_actions**ï¼šæ¨èæ“ä½œåˆ—è¡¨ï¼Œå¯æ˜ å°„åˆ° UI æŒ‰é’®
7. **annotated_media_asset_id**ï¼šæ ‡æ³¨é—®é¢˜ç‚¹çš„å›¾ç‰‡

### æ€§èƒ½è¯´æ˜
- å›¾ç‰‡åˆ†æ + æ ‡æ³¨ç”Ÿæˆé€šå¸¸éœ€è¦ 5-15 ç§’
- å¤æ‚åœºæ™¯ï¼ˆå¤šä¸ªé—®é¢˜ç‚¹ï¼‰å¯èƒ½éœ€è¦ 15-25 ç§’
- è¶…è¿‡ 45 ç§’ä¼šè¿”å› `REQUEST_TIMEOUT` é”™è¯¯

### è´¨é‡ä¿è¯
- `confidence` è¯„åˆ†ä½äº 0.6 æ—¶ï¼ŒAI ä¼šåœ¨ `advice_text` ä¸­è¯´æ˜ä¸ç¡®å®šå› ç´ 
- `tolerance=strict` æ¨¡å¼ä¸‹ï¼Œè½»å¾®åå·®ä¹Ÿä¼šè¢«æ ‡è®°ä¸ºé—®é¢˜
- å¦‚æœç…§ç‰‡è´¨é‡å¤ªå·®ï¼Œä¼šè¿”å› `IMAGE_QUALITY_INSUFFICIENT` é”™è¯¯
</Note>

---

## æ”¯æŒå¤šæ¬¡é‡è¯•

è¯¥æ¥å£æ”¯æŒ**å¤šæ¬¡é‡è¯•**ï¼šç”¨æˆ·å¯ä»¥"è°ƒæ•´åé‡æ‹"ï¼Œæ¯æ¬¡éƒ½è°ƒç”¨ä¸€æ¬¡æ ¡éªŒã€‚å»ºè®®åœ¨ session çš„ `calibration_data.attempts` æ•°ç»„ä¸­è®°å½•æ¯æ¬¡å°è¯•ã€‚

<Tip>
**æ¨èçš„å¹‚ç­‰é”®æ ¼å¼**ï¼š`calib-check-${setupSessionId}-${attemptNumber}`

è¿™æ ·å¯ä»¥è¿½è¸ªåŒä¸€ä¸ª setup session ä¸­çš„å¤šæ¬¡æ ¡å‡†å°è¯•ã€‚
</Tip>

---

## å‰ç«¯ä½¿ç”¨å»ºè®®

åœ¨ **CALIB_RESULT** é¡µé¢ï¼š

1. ç”¨ `is_correct` å†³å®šæ˜¾ç¤ºæˆåŠŸè¿˜æ˜¯éœ€è¦è°ƒæ•´çš„ UI
2. ç”¨ `advice_text` åšä¸»è¦è¯´æ˜æ–‡æ¡ˆ
3. ç”¨ `annotated_media_asset_id` åŠ è½½å¸¦æ ‡æ³¨çš„å›¾ç‰‡ï¼ˆæ˜¾ç¤ºé—®é¢˜ç‚¹ï¼‰
4. ç”¨ `issues` åˆ—è¡¨æ˜¾ç¤ºå…·ä½“é—®é¢˜ï¼ˆå¯æŠ˜å å±•å¼€ï¼‰
5. ç”¨ `recommended_actions` æ¸²æŸ“æ“ä½œæŒ‰é’®

```javascript
// ç¤ºä¾‹ï¼šæ¸²æŸ“æ¨èæ“ä½œæŒ‰é’®
check.recommended_actions.forEach(action => {
  const button = document.createElement('button');
  button.textContent = action.label;
  button.title = action.details;
  button.onclick = () => handleAction(action.code);
  actionsContainer.appendChild(button);
});
```

---

## æµ‹è¯•èµ„æº

### æµ‹è¯•ç”¨æˆ·è´¦å·

| å­—æ®µ | å€¼ |
|------|-----|
| Email | `test@example.com` |
| Password | `test1234` |

### æµ‹è¯•æµç¨‹

```python
import requests

BASE_URL = "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1"
AUTH_URL = "https://vwinvkxxheuexvpvzibt.supabase.co/auth/v1/token?grant_type=password"
ANON_KEY = "your_anon_key_here"

# 1. ç™»å½•è·å– token
login_response = requests.post(
    AUTH_URL,
    headers={"apikey": ANON_KEY, "Content-Type": "application/json"},
    json={"email": "test@example.com", "password": "test1234"}
)
token = login_response.json()["access_token"]

# 2. åˆ›å»ºåª’ä½“èµ„æº
media_response = requests.post(
    f"{BASE_URL}/media-assets",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={"purpose": "setup", "content_type": "image/jpeg", "metadata": {"usage": "calibration_check"}}
)
media_id = media_response.json()['id']
upload_url = media_response.json()['upload_url']

# 3. ä¸Šä¼ å›¾ç‰‡
with open('trap_photo.jpg', 'rb') as f:
    requests.put(upload_url, headers={"Content-Type": "image/jpeg"}, data=f)

# 4. è°ƒç”¨æ ¡å‡†æ£€æŸ¥æ¥å£
response = requests.post(
    f"{BASE_URL}/calibration-checks",
    headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
    json={
        "media_asset_id": media_id,
        "rodent_target": "rat",
        "trap_type": "snap_trap",
        "bait_type": "peanut_butter",
        "options": {"language": "zh-CN", "need_annotated_image": True, "tolerance": "normal"}
    }
)

result = response.json()
print(f"å¸ƒç½®æ˜¯å¦æ­£ç¡®: {result['is_correct']}")
print(f"ç½®ä¿¡åº¦: {result['confidence']}")
print(f"é—®é¢˜æ•°é‡: {len(result['issues'])}")
print(f"å»ºè®®: {result['advice_text']}")
```
