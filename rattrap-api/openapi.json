{
  "openapi": "3.1.0",
  "info": {
    "title": "RatTrap API",
    "description": "智能捕鼠器应用 API - 采用 Stripe 风格的 REST API，帮助用户从诊断老鼠问题到布置陷阱的完整流程。",
    "version": "2024-11-22",
    "contact": {
      "name": "RatTrap Support",
      "email": "support@rattrap.ai"
    },
    "license": {
      "name": "MIT"
    }
  },
  "servers": [
    {
      "url": "https://vwinvkxxheuexvpvzibt.supabase.co/functions/v1",
      "description": "Supabase Edge Functions"
    },
    {
      "url": "https://vwinvkxxheuexvpvzibt.supabase.co",
      "description": "Supabase Auth API"
    }
  ],
  "security": [
    {
      "bearerAuth": []
    }
  ],
  "paths": {
    "/auth/v1/token": {
      "post": {
        "operationId": "login",
        "summary": "用户登录",
        "description": "使用邮箱和密码登录，获取 Bearer Token。使用 grant_type=password 参数。",
        "tags": ["Authentication"],
        "security": [{"apiKey": []}],
        "servers": [
          {
            "url": "https://vwinvkxxheuexvpvzibt.supabase.co",
            "description": "Supabase Auth API"
          }
        ],
        "parameters": [
          {
            "name": "grant_type",
            "in": "query",
            "required": true,
            "description": "授权类型",
            "schema": {
              "type": "string",
              "enum": ["password", "refresh_token"],
              "default": "password"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": ["email", "password"],
                "properties": {
                  "email": {
                    "type": "string",
                    "format": "email",
                    "description": "用户邮箱",
                    "example": "user@example.com"
                  },
                  "password": {
                    "type": "string",
                    "format": "password",
                    "description": "用户密码",
                    "example": "your-password"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "登录成功",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "access_token": {
                      "type": "string",
                      "description": "Bearer Token，用于 API 认证"
                    },
                    "token_type": {
                      "type": "string",
                      "example": "bearer"
                    },
                    "expires_in": {
                      "type": "integer",
                      "description": "Token 有效期（秒）",
                      "example": 3600
                    },
                    "refresh_token": {
                      "type": "string",
                      "description": "刷新 Token"
                    },
                    "user": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "email": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "登录失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/setup-sessions": {
      "post": {
        "operationId": "createSetupSession",
        "summary": "创建布防会话",
        "description": "创建一条新的布防会话（setup session）。每当用户在 App 内点击「＋ 新布防」时调用。",
        "tags": ["Setup Sessions"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateSetupSessionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功创建布防会话",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SetupSession"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "认证失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/setup-sessions/{id}": {
      "post": {
        "operationId": "updateSetupSession",
        "summary": "更新布防会话",
        "description": "更新一个已有的布防会话。提交哪个阶段的数据，就推进到下一个阶段。rodent_target 实际存储在 identification_data.rodent_target 中。",
        "tags": ["Setup Sessions"],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Setup session ID",
            "schema": {
              "type": "string",
              "example": "ss_1Qy8u8CZ7aQp98Xb5WJtR3"
            }
          }
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/UpdateSetupSessionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功更新布防会话",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/SetupSession"
                }
              }
            }
          },
          "404": {
            "description": "会话不存在",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/create-trap-from-session": {
      "post": {
        "operationId": "createTrapFromSession",
        "summary": "从会话创建陷阱",
        "description": "从一个已完成的 setup session 创建 Trap 实体。要求 current_stage 为 completed，且所有核心字段（name, location_desc, trap_type, bait_type, rodent_target）必须由用户提供。支持幂等性：如果 session 已创建过陷阱，直接返回已存在的陷阱。",
        "tags": ["Setup Sessions"],
        "parameters": [
          {
            "name": "session_id",
            "in": "query",
            "required": true,
            "description": "Setup session ID",
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateTrapFromSessionRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功创建陷阱（或返回已存在的陷阱）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Trap"
                }
              }
            }
          },
          "400": {
            "description": "请求错误（SESSION_NOT_COMPLETED 或 MISSING_REQUIRED_FIELD）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "Session 不存在",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "409": {
            "description": "幂等键冲突",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/trap-recommendations": {
      "post": {
        "operationId": "createTrapRecommendation",
        "summary": "获取捕鼠器推荐",
        "description": "根据用户所在地区、目标鼠种、用户偏好返回推荐的捕鼠器列表。支持识别现有工具或推荐购买新工具。",
        "tags": ["AI Recommendations"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TrapRecommendationRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功返回推荐结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TrapRecommendationResult"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误（包括 rodent_target=unknown 时返回 UNKNOWN_RODENT_NOT_SUPPORTED）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "认证失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/bait-recommendations": {
      "post": {
        "operationId": "createBaitRecommendation",
        "summary": "获取诱饵推荐",
        "description": "根据目标鼠种、陷阱类型、用户所在地区返回适合的诱饵推荐。支持从冰箱照片中识别可用食物。",
        "tags": ["AI Recommendations"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/BaitRecommendationRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功返回诱饵推荐",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BaitRecommendationResult"
                }
              }
            }
          }
        }
      }
    },
    "/location-analyses": {
      "post": {
        "operationId": "createLocationAnalysis",
        "summary": "分析放置位置",
        "description": "对用户拍摄的房间全景照片进行视觉分析，找出最佳放置陷阱的位置，并生成带标注的图片。",
        "tags": ["AI Recommendations"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LocationAnalysisRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功返回位置分析",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/LocationAnalysis"
                }
              }
            }
          }
        }
      }
    },
    "/calibration-checks": {
      "post": {
        "operationId": "createCalibrationCheck",
        "summary": "校准检查",
        "description": "对用户拍的已布置好的陷阱近景照片进行校准检查，判断布置是否合格并给出调整建议。",
        "tags": ["AI Recommendations"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CalibrationCheckRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功返回校准结果",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CalibrationCheck"
                }
              }
            }
          }
        }
      }
    },
    "/media-assets": {
      "post": {
        "operationId": "createMediaAsset",
        "summary": "创建媒体资源",
        "description": "为用户拍的每一张照片创建媒体记录，返回上传信息和 media_asset_id。",
        "tags": ["Media"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateMediaAssetRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功创建媒体资源",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/MediaAsset"
                }
              }
            }
          }
        }
      }
    },
    "/traps": {
      "get": {
        "operationId": "listTraps",
        "summary": "列出陷阱",
        "description": "列出当前用户的所有陷阱，支持状态筛选和分页。",
        "tags": ["Traps"],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "description": "按状态过滤，支持逗号分隔多值（如 status=active,warning）",
            "schema": {
              "type": "string",
              "enum": ["active", "inactive", "warning", "triggered_caught"]
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "每页数量",
            "schema": {
              "type": "integer",
              "default": 10,
              "maximum": 100
            }
          },
          {
            "name": "starting_after",
            "in": "query",
            "description": "向后分页的游标（上一页最后一个 trap 的 ID）",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "ending_before",
            "in": "query",
            "description": "向前分页的游标（下一页第一个 trap 的 ID），用于反向分页回到上一页",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "成功返回陷阱列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TrapList"
                }
              }
            }
          }
        }
      }
    },
    "/traps/{id}": {
      "get": {
        "operationId": "getTrap",
        "summary": "获取陷阱详情",
        "description": "获取单个陷阱的详细信息。只能获取当前用户拥有的陷阱，访问其他用户的陷阱会返回 404。",
        "tags": ["Traps"],
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "required": true,
            "description": "Trap ID（UUID 格式）",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "成功返回陷阱详情",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Trap"
                }
              }
            }
          },
          "400": {
            "description": "请求参数错误（无效 ID 格式）",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "401": {
            "description": "认证失败",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          },
          "404": {
            "description": "陷阱不存在或不属于当前用户",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                }
              }
            }
          }
        }
      }
    },
    "/trap-events": {
      "post": {
        "operationId": "createTrapEvent",
        "summary": "创建陷阱事件",
        "description": "创建陷阱事件：布防完成、检查、捕获、补饵等。",
        "tags": ["Trap Events"],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateTrapEventRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "成功创建事件",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TrapEvent"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "bearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "description": "使用 Bearer token 进行认证"
      },
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "apikey",
        "description": "Supabase anon key，可在 Supabase Dashboard 的项目设置中找到"
      }
    },
    "schemas": {
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "object",
            "properties": {
              "type": {
                "type": "string",
                "description": "错误类型",
                "enum": ["invalid_request_error", "authentication_error", "authorization_error", "rate_limit_error", "api_error", "idempotency_error"]
              },
              "code": {
                "type": "string",
                "description": "错误代码"
              },
              "message": {
                "type": "string",
                "description": "错误消息"
              },
              "param": {
                "type": "string",
                "description": "相关参数"
              },
              "doc_url": {
                "type": "string",
                "description": "文档链接"
              }
            }
          }
        }
      },
      "UserLocation": {
        "type": "object",
        "properties": {
          "country": {
            "type": "string",
            "description": "国家代码",
            "example": "TW"
          },
          "city": {
            "type": "string",
            "description": "城市",
            "example": "Taipei"
          },
          "environment": {
            "type": "string",
            "description": "环境类型",
            "enum": ["apartment", "house", "farm", "warehouse", "restaurant_kitchen"]
          }
        }
      },
      "CreateSetupSessionRequest": {
        "type": "object",
        "properties": {
          "source": {
            "type": "string",
            "description": "会话来源",
            "example": "mobile_app"
          },
          "initial_rodent_target": {
            "type": "string",
            "description": "初始目标鼠种。有效值：rat, mouse, unknown。不接受空字符串，空字符串会返回 400 VALIDATION_ERROR。",
            "enum": ["rat", "mouse", "unknown"]
          },
          "user_location_hint": {
            "$ref": "#/components/schemas/UserLocation"
          },
          "metadata": {
            "type": "object",
            "description": "自定义元数据"
          }
        }
      },
      "SetupSession": {
        "type": "object",
        "description": "布防会话对象。rodent_target 从 identification_data.rodent_target 提取到顶层方便使用。",
        "properties": {
          "id": {
            "type": "string",
            "description": "Session ID",
            "example": "ss_1Qy8u8CZ7aQp98Xb5WJtR3"
          },
          "object": {
            "type": "string",
            "enum": ["setup_session"]
          },
          "current_stage": {
            "type": "string",
            "description": "当前阶段",
            "enum": ["identification", "strategy", "location", "calibration", "completed"]
          },
          "created_trap_id": {
            "type": "string",
            "nullable": true,
            "description": "创建的陷阱 ID"
          },
          "rodent_target": {
            "type": "string",
            "nullable": true,
            "description": "目标鼠种（从 identification_data.rodent_target 提取）",
            "enum": ["rat", "mouse", "unknown"]
          },
          "identification_data": {
            "type": "object",
            "nullable": true,
            "description": "识别阶段数据（rodent_target 实际存储在这里）"
          },
          "strategy_data": {
            "type": "object",
            "nullable": true
          },
          "location_scout_data": {
            "type": "object",
            "nullable": true
          },
          "calibration_data": {
            "type": "object",
            "nullable": true
          },
          "metadata": {
            "type": "object"
          },
          "created": {
            "type": "integer",
            "description": "创建时间戳"
          },
          "updated": {
            "type": "integer",
            "description": "更新时间戳"
          }
        }
      },
      "UpdateSetupSessionRequest": {
        "type": "object",
        "description": "更新布防会话的请求。rodent_target 会自动合并到 identification_data.rodent_target。提交哪个阶段的数据就推进到下一阶段。",
        "properties": {
          "rodent_target": {
            "type": "string",
            "description": "目标鼠种（会自动合并到 identification_data.rodent_target）。有效值：rat, mouse, unknown。不接受空字符串，空字符串会返回 400 VALIDATION_ERROR。",
            "enum": ["rat", "mouse", "unknown"]
          },
          "identification_data": {
            "type": "object",
            "description": "识别阶段数据（提交后推进到 strategy 阶段）"
          },
          "strategy_data": {
            "type": "object",
            "description": "策略阶段数据（提交后推进到 location 阶段）"
          },
          "location_scout_data": {
            "type": "object",
            "description": "位置侦查阶段数据（提交后推进到 calibration 阶段）"
          },
          "calibration_data": {
            "type": "object",
            "description": "校准阶段数据（提交后推进到 completed 阶段）"
          },
          "metadata": {
            "type": "object",
            "description": "自定义元数据（会与现有数据合并，不影响阶段推进）"
          }
        }
      },
      "CreateTrapFromSessionRequest": {
        "type": "object",
        "description": "从会话创建陷阱的请求。所有核心字段都必须由用户提供。Session 的 current_stage 必须为 completed。",
        "required": ["name", "location_desc", "trap_type", "bait_type", "rodent_target"],
        "properties": {
          "name": {
            "type": "string",
            "description": "陷阱名称",
            "example": "厨房 - 冰箱右侧"
          },
          "location_desc": {
            "type": "string",
            "description": "位置描述",
            "example": "冰箱右侧沿墙根，距墙角约 10cm"
          },
          "trap_type": {
            "type": "string",
            "description": "陷阱类型",
            "enum": ["snap_trap", "glue_board", "cage_trap", "electronic_trap", "other"]
          },
          "bait_type": {
            "type": "string",
            "description": "诱饵类型",
            "enum": ["peanut_butter", "cheese", "bacon", "chocolate", "nuts", "grain", "other", "none"]
          },
          "rodent_target": {
            "type": "string",
            "description": "目标鼠种",
            "enum": ["rat", "mouse", "unknown"]
          },
          "status": {
            "type": "string",
            "description": "陷阱状态，默认为 active",
            "enum": ["active", "inactive"],
            "default": "active"
          },
          "calibration_override": {
            "type": "object",
            "description": "校准覆盖选项，用于标记校准失败但用户接受的情况",
            "properties": {
              "quality": {
                "type": "string",
                "description": "校准质量",
                "enum": ["passed", "failed_but_accepted"]
              }
            }
          },
          "metadata": {
            "type": "object",
            "description": "自定义元数据"
          }
        }
      },
      "TrapRecommendationRequest": {
        "type": "object",
        "required": ["mode", "rodent_target"],
        "properties": {
          "mode": {
            "type": "string",
            "description": "推荐模式",
            "enum": ["existing_trap", "no_trap"]
          },
          "rodent_target": {
            "type": "string",
            "description": "目标鼠种。只接受 rat 或 mouse，不支持 unknown（unknown 会返回 400 UNKNOWN_RODENT_NOT_SUPPORTED 错误）",
            "enum": ["rat", "mouse"]
          },
          "media_asset_id": {
            "type": "string",
            "description": "现有工具照片 ID（mode=existing_trap 时必填）"
          },
          "user_location": {
            "$ref": "#/components/schemas/UserLocation"
          },
          "preferences": {
            "type": "object",
            "properties": {
              "avoid_killing": {
                "type": "boolean"
              },
              "has_children_or_pets": {
                "type": "boolean"
              },
              "budget_level": {
                "type": "string",
                "enum": ["low", "medium", "high"]
              }
            }
          },
          "limit": {
            "type": "integer",
            "default": 3,
            "maximum": 10
          }
        }
      },
      "TrapRecommendationResult": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["trap_recommendation_result"]
          },
          "mode": {
            "type": "string"
          },
          "rodent_target": {
            "type": "string"
          },
          "existing_trap": {
            "type": "object",
            "nullable": true,
            "properties": {
              "detected_type": {
                "type": "string"
              },
              "is_suitable": {
                "type": "boolean"
              },
              "suitability_score": {
                "type": "number"
              },
              "notes": {
                "type": "string"
              }
            }
          },
          "recommended_traps": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TrapProduct"
            }
          },
          "created": {
            "type": "integer"
          }
        }
      },
      "TrapProduct": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["trap_product"]
          },
          "id": {
            "type": "string"
          },
          "trap_type": {
            "type": "string",
            "enum": ["snap_trap", "glue_board", "cage_trap", "electronic_trap", "other"]
          },
          "label": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "for_rodent": {
            "type": "string",
            "enum": ["rat", "mouse", "both"]
          },
          "suitability_score": {
            "type": "number"
          },
          "safety_level": {
            "type": "string",
            "enum": ["low", "medium", "high"]
          },
          "price_band": {
            "type": "string",
            "enum": ["low", "medium", "high"]
          },
          "recommended_reason": {
            "type": "string"
          }
        }
      },
      "BaitRecommendationRequest": {
        "type": "object",
        "required": ["rodent_target"],
        "properties": {
          "mode": {
            "type": "string",
            "enum": ["standard", "from_fridge"],
            "default": "standard"
          },
          "rodent_target": {
            "type": "string",
            "enum": ["rat", "mouse", "unknown"]
          },
          "trap_type": {
            "type": "string",
            "enum": ["snap_trap", "glue_board", "cage_trap", "electronic_trap", "other"]
          },
          "media_asset_id": {
            "type": "string",
            "description": "冰箱照片 ID（mode=from_fridge 时必填）"
          },
          "user_location": {
            "$ref": "#/components/schemas/UserLocation"
          },
          "limit": {
            "type": "integer",
            "default": 3
          }
        }
      },
      "BaitRecommendationResult": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["bait_recommendation_result"]
          },
          "mode": {
            "type": "string"
          },
          "primary_bait": {
            "$ref": "#/components/schemas/BaitOption"
          },
          "alternative_baits": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/BaitOption"
            }
          },
          "fridge_analysis": {
            "type": "object",
            "nullable": true
          },
          "created": {
            "type": "integer"
          }
        }
      },
      "BaitOption": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["bait_option"]
          },
          "id": {
            "type": "string"
          },
          "bait_type": {
            "type": "string",
            "enum": ["peanut_butter", "cheese", "bacon", "chocolate", "nuts", "grain", "other", "none"]
          },
          "label": {
            "type": "string"
          },
          "description": {
            "type": "string"
          },
          "suitability_score": {
            "type": "number"
          },
          "spoilage_risk": {
            "type": "string",
            "enum": ["low", "medium", "high"]
          },
          "usage_tips": {
            "type": "string"
          }
        }
      },
      "LocationAnalysisRequest": {
        "type": "object",
        "required": ["media_asset_id"],
        "properties": {
          "setup_session_id": {
            "type": "string"
          },
          "media_asset_id": {
            "type": "string",
            "description": "房间全景照片 ID"
          },
          "rodent_target": {
            "type": "string",
            "enum": ["rat", "mouse", "unknown"]
          },
          "trap_type": {
            "type": "string"
          },
          "bait_type": {
            "type": "string"
          },
          "options": {
            "type": "object",
            "properties": {
              "max_zones": {
                "type": "integer",
                "default": 2
              },
              "language": {
                "type": "string",
                "default": "zh-CN"
              }
            }
          }
        }
      },
      "LocationAnalysis": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["location_analysis"]
          },
          "id": {
            "type": "string"
          },
          "media_asset_id": {
            "type": "string"
          },
          "annotated_media_asset_id": {
            "type": "string",
            "description": "带标注的图片 ID"
          },
          "placement_text": {
            "type": "string",
            "description": "详细的放置说明"
          },
          "zones": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/PlacementZone"
            }
          },
          "created": {
            "type": "integer"
          }
        }
      },
      "PlacementZone": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "label": {
            "type": "string"
          },
          "priority": {
            "type": "integer"
          },
          "confidence": {
            "type": "number"
          },
          "description": {
            "type": "string"
          },
          "bounding_box": {
            "type": "object",
            "properties": {
              "x": { "type": "number" },
              "y": { "type": "number" },
              "width": { "type": "number" },
              "height": { "type": "number" }
            }
          }
        }
      },
      "CalibrationCheckRequest": {
        "type": "object",
        "required": ["media_asset_id"],
        "properties": {
          "setup_session_id": {
            "type": "string",
            "description": "关联的布防会话 ID，便于后续追踪"
          },
          "media_asset_id": {
            "type": "string",
            "description": "校准照片 ID（必填），必须先通过 POST /media-assets 上传"
          },
          "rodent_target": {
            "type": "string",
            "description": "目标鼠种（推荐），帮助 AI 判断陷阱大小是否合适",
            "enum": ["rat", "mouse", "unknown"]
          },
          "trap_type": {
            "type": "string",
            "description": "陷阱类型（推荐），帮助 AI 进行针对性检查",
            "enum": ["snap_trap", "glue_board", "cage_trap", "electronic_trap", "other"]
          },
          "bait_type": {
            "type": "string",
            "description": "诱饵类型（推荐），帮助 AI 检查诱饵位置和状态",
            "enum": ["peanut_butter", "cheese", "bacon", "chocolate", "nuts", "grain", "other", "none"]
          },
          "location_context": {
            "type": "object",
            "description": "上一阶段的推荐位置信息，帮助 AI 对比实际布置",
            "properties": {
              "recommended_zone_id": {
                "type": "string",
                "description": "推荐区域 ID"
              },
              "recommended_description": {
                "type": "string",
                "description": "推荐位置描述"
              },
              "recommended_distance_to_wall_cm": {
                "type": "number",
                "description": "推荐距墙距离（厘米）"
              }
            }
          },
          "options": {
            "type": "object",
            "properties": {
              "language": {
                "type": "string",
                "description": "返回文案的语言",
                "default": "zh-CN"
              },
              "need_annotated_image": {
                "type": "boolean",
                "description": "是否生成标注问题点的图片。设为 false 时 annotated_media_asset_id 返回 null",
                "default": true
              },
              "tolerance": {
                "type": "string",
                "description": "对布置完美度的容忍度。normal 允许轻微偏差，strict 要求精确布置",
                "enum": ["normal", "strict"],
                "default": "normal"
              }
            }
          }
        }
      },
      "CalibrationCheck": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["calibration_check"]
          },
          "id": {
            "type": "string",
            "description": "校准检查 ID，格式: calib_xxx"
          },
          "media_asset_id": {
            "type": "string",
            "description": "原始校准照片 ID"
          },
          "annotated_media_asset_id": {
            "type": "string",
            "nullable": true,
            "description": "标注问题点后的图片 ID。当 need_annotated_image=false 或标注生成失败时为 null"
          },
          "is_correct": {
            "type": "boolean",
            "description": "布置是否合格"
          },
          "confidence": {
            "type": "number",
            "description": "AI 对判断结果的置信度（0-1）",
            "minimum": 0,
            "maximum": 1
          },
          "placement_match_score": {
            "type": "number",
            "description": "布置与最佳实践的匹配分数（0-1）",
            "minimum": 0,
            "maximum": 1
          },
          "issues": {
            "type": "array",
            "description": "检测到的问题列表",
            "items": {
              "$ref": "#/components/schemas/CalibrationIssue"
            }
          },
          "advice_text": {
            "type": "string",
            "description": "综合建议文案，适合直接显示给用户"
          },
          "recommended_actions": {
            "type": "array",
            "description": "推荐操作列表，可映射到 UI 按钮",
            "items": {
              "type": "object",
              "properties": {
                "code": {
                  "type": "string",
                  "description": "操作代码，如 move_closer_to_wall, rotate_trap, add_bait 等"
                },
                "label": {
                  "type": "string",
                  "description": "操作的简短标签，适合用作按钮文案"
                },
                "details": {
                  "type": "string",
                  "description": "详细说明文案"
                },
                "priority": {
                  "type": "integer",
                  "description": "优先级，1 为最高"
                }
              }
            }
          },
          "created": {
            "type": "integer",
            "description": "创建时间（Unix 时间戳）"
          }
        }
      },
      "CalibrationIssue": {
        "type": "object",
        "description": "校准检查发现的单个问题",
        "properties": {
          "code": {
            "type": "string",
            "description": "问题代码，如 too_far_from_wall, wrong_orientation, bait_missing 等"
          },
          "message": {
            "type": "string",
            "description": "问题的简短描述（英文）"
          },
          "severity": {
            "type": "string",
            "description": "严重程度：error=必须修正, warning=建议优化, info=可忽略",
            "enum": ["info", "warning", "error"]
          },
          "suggestion": {
            "type": "string",
            "description": "针对该问题的修正建议（本地化语言）"
          },
          "metrics": {
            "type": "object",
            "description": "定量信息，结构根据问题类型变化。如距离问题包含 distance_to_wall_cm，方向问题包含 angle_deviation_deg"
          }
        }
      },
      "CreateMediaAssetRequest": {
        "type": "object",
        "required": ["purpose", "content_type", "metadata"],
        "properties": {
          "purpose": {
            "type": "string",
            "description": "媒体用途",
            "enum": ["setup", "check", "evidence"]
          },
          "content_type": {
            "type": "string",
            "description": "内容类型，支持的格式: image/jpeg, image/png, image/webp",
            "enum": ["image/jpeg", "image/png", "image/webp"],
            "example": "image/jpeg"
          },
          "metadata": {
            "type": "object",
            "description": "自定义元数据（如 stage, session_id 等）"
          }
        }
      },
      "MediaAsset": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "媒体资源 ID，格式: ma_xxx",
            "example": "ma_1PpTqQx2YwZv9kLb"
          },
          "object": {
            "type": "string",
            "enum": ["media_asset"]
          },
          "purpose": {
            "type": "string",
            "description": "媒体用途"
          },
          "content_type": {
            "type": "string",
            "description": "内容类型"
          },
          "upload_url": {
            "type": "string",
            "description": "预签名上传 URL（15分钟有效期）"
          },
          "url": {
            "type": "string",
            "description": "访问 URL"
          },
          "status": {
            "type": "string",
            "description": "状态：pending（待上传）、ready（已就绪）",
            "enum": ["pending", "ready"],
            "example": "pending"
          },
          "metadata": {
            "type": "object",
            "description": "自定义元数据"
          },
          "created": {
            "type": "integer",
            "description": "创建时间戳（Unix timestamp）"
          }
        }
      },
      "Trap": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Trap ID（UUID 格式）",
            "example": "3c175d6d-d5af-4070-b73a-c9a5ab8e37e7"
          },
          "object": {
            "type": "string",
            "enum": ["trap"]
          },
          "name": {
            "type": "string"
          },
          "location_desc": {
            "type": "string",
            "nullable": true
          },
          "trap_type": {
            "type": "string",
            "enum": ["snap_trap", "glue_board", "cage_trap", "electronic_trap", "other"]
          },
          "bait_type": {
            "type": "string",
            "description": "诱饵类型",
            "enum": ["peanut_butter", "cheese", "bacon", "chocolate", "nuts", "grain", "other", "none"]
          },
          "rodent_target": {
            "type": "string",
            "description": "目标鼠种",
            "enum": ["rat", "mouse", "unknown"]
          },
          "status": {
            "type": "string",
            "description": "陷阱状态。active/inactive 可由用户设置，warning/triggered_caught 由系统自动设置",
            "enum": ["active", "inactive", "warning", "triggered_caught"]
          },
          "deployment_media_id": {
            "type": "string",
            "nullable": true,
            "description": "部署时的图片 ID，由后端在创建陷阱时自动记录"
          },
          "last_check_media_id": {
            "type": "string",
            "nullable": true,
            "description": "最近一次检查的图片 ID，由后端在每次检查时自动更新"
          },
          "last_checked_at": {
            "type": "integer",
            "nullable": true,
            "description": "上次检查时间（Unix 时间戳），初始为 null"
          },
          "next_check_at": {
            "type": "integer",
            "nullable": true,
            "description": "下次检查时间（Unix 时间戳），通常不会为 null"
          },
          "stats_catches": {
            "type": "integer"
          },
          "stats_misses": {
            "type": "integer"
          },
          "metadata": {
            "type": "object"
          },
          "created": {
            "type": "integer"
          },
          "updated": {
            "type": "integer"
          }
        }
      },
      "TrapList": {
        "type": "object",
        "properties": {
          "object": {
            "type": "string",
            "enum": ["list"]
          },
          "url": {
            "type": "string"
          },
          "has_more": {
            "type": "boolean"
          },
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/Trap"
            }
          }
        }
      },
      "CreateTrapEventRequest": {
        "type": "object",
        "required": ["trap_id", "event_type"],
        "properties": {
          "trap_id": {
            "type": "string",
            "format": "uuid",
            "description": "陷阱 ID（UUID 格式）"
          },
          "event_type": {
            "type": "string",
            "enum": ["deployment", "check", "catch", "miss", "rebait", "maintenance"],
            "description": "事件类型"
          },
          "media_id": {
            "type": "string",
            "description": "关联的媒体资源 ID"
          },
          "details": {
            "type": "object",
            "description": "事件详情，结构根据事件类型不同而变化"
          }
        }
      },
      "TrapEvent": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "事件 ID（UUID 格式）"
          },
          "object": {
            "type": "string",
            "enum": ["trap_event"]
          },
          "trap_id": {
            "type": "string",
            "format": "uuid",
            "description": "关联的陷阱 ID（UUID 格式）"
          },
          "event_type": {
            "type": "string",
            "enum": ["deployment", "check", "catch", "miss", "rebait", "maintenance"],
            "description": "事件类型"
          },
          "media_id": {
            "type": "string",
            "nullable": true,
            "description": "关联的媒体资源 ID"
          },
          "details": {
            "type": "object",
            "description": "事件详情"
          },
          "recorded_at": {
            "type": "integer",
            "description": "事件发生时间（Unix 时间戳，秒）"
          },
          "created": {
            "type": "integer",
            "description": "记录创建时间（Unix 时间戳，秒）"
          }
        }
      }
    }
  }
}
