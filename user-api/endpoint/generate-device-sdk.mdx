---
title: '生成 TypeScript SDK'
openapi: 'GET /generate-device-sdk'
---

## 接口说明

自动生成 TypeScript SDK 文件,包含所有设备类型的类型定义。该接口是多设备框架的核心功能,确保前端开发的类型安全。

<Note>
**类型安全开发**:
- 自动生成 TypeScript 接口定义
- 编译时类型检查,避免运行时错误
- 枚举值自动补全
- 支持嵌套对象和可选字段
</Note>

## 核心概念

### SDK 生成流程

```
设备类型定义 (数据库)
    │
    ▼
Edge Function
    │ 解析 reported_schema
    │ 解析 desired_schema
    │ 生成 TypeScript 接口
    ▼
TypeScript SDK 文件
    │
    ▼
前端应用
    │ 导入 SDK
    │ 类型安全的开发
```

### 生成的 SDK 结构

```typescript
// device-types.generated.ts

/** 设备类型 1 - 上报数据 */
export interface DeviceType1Reported { ... }

/** 设备类型 1 - 控制命令 */
export interface DeviceType1Desired { ... }

/** 设备类型 2 - 上报数据 */
export interface DeviceType2Reported { ... }

/** 设备类型 2 - 控制命令 */
export interface DeviceType2Desired { ... }

/** 设备类型映射 */
export interface DeviceTypeMap {
  device_type_1: {
    reported: DeviceType1Reported;
    desired: DeviceType1Desired;
  };
  device_type_2: {
    reported: DeviceType2Reported;
    desired: DeviceType2Desired;
  };
}

export type DeviceTypeName = keyof DeviceTypeMap;
```

## 请求参数

<ParamField query="type_id" type="string">
  设备类型ID (可选)

  如果指定,只生成该设备类型的 SDK

  示例: `type-uuid-1`
</ParamField>

## 响应数据

返回 TypeScript 代码文件,Content-Type 为 `text/typescript`

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `TYPE_NOT_FOUND` | 404 | 指定的设备类型不存在 |
| `INVALID_REQUEST` | 400 | 请求参数无效 |
| `PERMISSION_DENIED` | 403 | 没有权限访问 |

<RequestExample>
```bash cURL - 生成所有设备类型的 SDK
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/generate-device-sdk' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -o device-types.generated.ts
```

```bash cURL - 生成单个设备类型的 SDK
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/generate-device-sdk?type_id=type-uuid-1' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -o temp-humidity-sensor.ts
```

```javascript Node.js - 下载并保存 SDK
import fs from 'fs';

async function downloadDeviceSDK() {
  const response = await fetch(
    'https://your-supabase-project.supabase.co/functions/v1/generate-device-sdk',
    {
      headers: { 'Authorization': `Bearer ${token}` }
    }
  );

  const sdkCode = await response.text();

  // 保存为文件
  fs.writeFileSync('./src/types/device-types.generated.ts', sdkCode);

  console.log('SDK 已生成并保存');
}

// 使用示例
await downloadDeviceSDK();
```

```python Python - 下载并保存 SDK
import requests

def download_device_sdk(token: str, output_path: str = 'device_types.generated.ts'):
    """
    下载并保存 TypeScript SDK

    Args:
        token: JWT Token
        output_path: 输出文件路径
    """
    response = requests.get(
        'https://your-supabase-project.supabase.co/functions/v1/generate-device-sdk',
        headers={'Authorization': f'Bearer {token}'}
    )

    # 保存为文件
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(response.text)

    print(f'SDK 已生成并保存到 {output_path}')

# 使用示例
download_device_sdk(token, './src/types/device-types.generated.ts')
```
</RequestExample>

<ResponseExample>
```typescript 生成的 SDK 示例
// Auto-generated TypeScript SDK for device types
// DO NOT EDIT - Generated from device_types table
// Generated at: 2026-01-10T08:26:03Z

/** 温湿度传感器 - 上报数据 */
export interface TempHumiditySensorReported {
  env: {
    tempC: number;  // 温度 (℃)
    humPct: number;  // 湿度 (%)
  };
  hw?: {
    batteryPct?: number;  // 电量 (%)
  };
}

/** 温湿度传感器 - 控制命令 */
export type TempHumiditySensorDesired = Record<string, never>;

/** 智能捕鼠器 - 上报数据 */
export interface SmartTrapReported {
  status: 'idle' | 'triggered' | 'error';  // 状态
  hw?: {
    batteryPct?: number;  // 电量 (%)
  };
  sensor?: {
    vibration?: number;  // 振动值
  };
}

/** 智能捕鼠器 - 控制命令 */
export interface SmartTrapDesired {
  armed?: boolean;  // 布防
  sensitivity?: 'low' | 'medium' | 'high';  // 灵敏度
}

/** 设备类型映射 */
export interface DeviceTypeMap {
  temp_humidity_sensor: {
    reported: TempHumiditySensorReported;
    desired: TempHumiditySensorDesired;
  };
  smart_trap: {
    reported: SmartTrapReported;
    desired: SmartTrapDesired;
  };
}

export type DeviceTypeName = keyof DeviceTypeMap;

/** 获取设备类型的上报数据类型 */
export type DeviceReported<T extends DeviceTypeName> = DeviceTypeMap[T]['reported'];

/** 获取设备类型的控制命令类型 */
export type DeviceDesired<T extends DeviceTypeName> = DeviceTypeMap[T]['desired'];
```
</ResponseExample>

## 使用说明

### 权限要求
- 需要有效的用户JWT Token
- 普通用户权限即可

### SDK 使用示例

#### 1. 类型安全的数据展示

```typescript
import { SmartTrapReported } from './device-types.generated';

interface Device {
  id: string;
  name: string;
  device_type: string;
  device_data: any;
}

function TrapStatusCard({ device }: { device: Device }) {
  // 类型安全的数据访问
  const reported: SmartTrapReported = device.device_data;

  return (
    <div>
      <h3>捕鼠器状态</h3>
      <p>状态: {reported.status}</p>
      <p>电量: {reported.hw?.batteryPct}%</p>
      <p>振动值: {reported.sensor?.vibration}</p>
    </div>
  );
}
```

#### 2. 类型安全的命令发送

```typescript
import { SmartTrapDesired } from './device-types.generated';

async function armTrap(deviceId: string) {
  // 类型安全的命令构造
  const command: SmartTrapDesired = {
    armed: true,
    sensitivity: 'high'  // 自动补全: 'low' | 'medium' | 'high'
  };

  const response = await fetch('/functions/v1/send-device-command', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_id: deviceId,
      command_type: 'update_desired',
      command_payload: command
    })
  });

  return await response.json();
}
```

#### 3. 泛型函数

```typescript
import { DeviceTypeMap, DeviceTypeName } from './device-types.generated';

// 类型安全的命令发送函数
async function sendCommand<T extends DeviceTypeName>(
  deviceId: string,
  deviceType: T,
  command: DeviceTypeMap[T]['desired']
) {
  const response = await fetch('/functions/v1/send-device-command', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      device_id: deviceId,
      command_type: 'update_desired',
      command_payload: command
    })
  });

  return await response.json();
}

// 使用示例 - 编译时类型检查
await sendCommand('device-id', 'smart_trap', {
  armed: true,
  sensitivity: 'high'  // 自动补全和类型检查
});
```

### SDK 更新策略

<Steps>
  <Step title="1. 定期更新">
    建议每周或每月更新一次 SDK,确保与最新的设备类型定义同步
  </Step>

  <Step title="2. 版本控制">
    将生成的 SDK 文件提交到版本控制系统,方便团队协作
  </Step>

  <Step title="3. 自动化">
    在 CI/CD 流程中自动下载最新 SDK,确保构建使用最新定义
  </Step>

  <Step title="4. 变更通知">
    设备类型定义更新后,通知前端团队重新生成 SDK
  </Step>
</Steps>

### 集成到构建流程

```json
// package.json
{
  "scripts": {
    "generate-sdk": "node scripts/download-device-sdk.js",
    "prebuild": "npm run generate-sdk",
    "build": "vite build"
  }
}
```

```javascript
// scripts/download-device-sdk.js
import fs from 'fs';
import fetch from 'node-fetch';

async function downloadSDK() {
  const token = process.env.SUPABASE_TOKEN;
  const apiUrl = process.env.SUPABASE_URL;

  const response = await fetch(
    `${apiUrl}/functions/v1/generate-device-sdk`,
    {
      headers: { 'Authorization': `Bearer ${token}` }
    }
  );

  const sdkCode = await response.text();
  fs.writeFileSync('./src/types/device-types.generated.ts', sdkCode);

  console.log('✅ Device SDK generated successfully');
}

downloadSDK().catch(console.error);
```

### 常见问题

<AccordionGroup>
  <Accordion title="SDK 需要手动更新吗?">
    是的。设备类型定义更新后,需要重新调用此接口生成最新的 SDK。

    建议:
    - 定期更新(每周或每月)
    - 设备类型更新后立即更新
    - 集成到 CI/CD 流程自动更新
  </Accordion>

  <Accordion title="生成的 SDK 可以修改吗?">
    不建议修改。生成的 SDK 文件包含 "DO NOT EDIT" 注释,表示不应手动修改。

    如果需要自定义类型,建议:
    - 创建新的类型文件扩展生成的类型
    - 使用 TypeScript 的类型组合功能
    - 联系管理员修改设备类型定义
  </Accordion>

  <Accordion title="如何处理 SDK 版本冲突?">
    如果团队成员使用不同版本的 SDK:
    - 将 SDK 文件提交到版本控制
    - 统一使用同一版本
    - 定期同步更新

    避免每个人独立生成 SDK。
  </Accordion>

  <Accordion title="SDK 支持哪些 TypeScript 版本?">
    生成的 SDK 使用标准 TypeScript 语法,支持 TypeScript 4.0 及以上版本。

    建议使用 TypeScript 4.5 或更高版本以获得最佳体验。
  </Accordion>

  <Accordion title="可以生成其他语言的 SDK 吗?">
    目前只支持 TypeScript。未来可能支持:
    - Python (Pydantic models)
    - Go (structs)
    - Java (classes)

    如有需求,请联系技术支持。
  </Accordion>
</AccordionGroup>

<Warning>
**不要手动修改**: 生成的 SDK 文件不应手动修改,下次生成时会被覆盖。如需自定义类型,请创建新的类型文件。
</Warning>

<Tip>
**自动化更新**: 将 SDK 生成集成到 CI/CD 流程,确保每次构建都使用最新的设备类型定义。
</Tip>
