---
title: '获取AWS凭证'
openapi: 'POST /get-aws-credentials'
---

## 接口说明

获取用于连接AWS IoT Core的临时凭证（AccessKey、SecretKey、SessionToken），用于MQTT over WebSocket连接。

系统会自动缓存凭证，有效期内直接返回缓存数据，显著提升响应速度（<100ms）。

## 请求参数

无需请求体，仅需在Header中提供JWT Token。

## 响应数据

<ResponseField name="identityId" type="string">
  AWS Cognito Identity ID

  格式: `{region}:{uuid}`

  例如: `ap-southeast-1:12345678-1234-1234-1234-123456789012`
</ResponseField>

<ResponseField name="credentials" type="object">
  AWS临时凭证

  <Expandable title="Credentials">
    <ResponseField name="AccessKeyId" type="string">
      AWS访问密钥ID
    </ResponseField>

    <ResponseField name="SecretKey" type="string">
      AWS密钥
    </ResponseField>

    <ResponseField name="SessionToken" type="string">
      会话令牌
    </ResponseField>

    <ResponseField name="Expiration" type="number">
      过期时间（Unix时间戳，秒）
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="policyAttached" type="boolean">
  IoT策略是否已附加
</ResponseField>

<ResponseField name="policyName" type="string">
  IoT策略名称，通常为 `PestGG-User-MQTT-Policy`
</ResponseField>

<ResponseField name="fromCache" type="boolean">
  是否从缓存返回
  - `true`: 从缓存返回（<100ms）
  - `false`: 从AWS Cognito获取（1-2秒）
</ResponseField>

<ResponseField name="expiresIn" type="number">
  凭证剩余有效时间（秒）
</ResponseField>

## 错误码

| 错误码 | HTTP状态码 | 说明 |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | 缺少或无效的认证Token |
| `COGNITO_ERROR` | 500 | AWS Cognito服务调用失败 |
| `IOT_POLICY_ERROR` | 500 | IoT策略附加失败 |
| `DATABASE_ERROR` | 500 | 缓存读写失败 |

<RequestExample>
```bash cURL
curl -X POST \
  'https://your-supabase-project.supabase.co/functions/v1/get-aws-credentials' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

```javascript Node.js
const response = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/get-aws-credentials',
  {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_JWT_TOKEN'
    }
  }
);

const data = await response.json();
console.log(`Identity ID: ${data.identityId}`);
console.log(`From cache: ${data.fromCache}`);
console.log(`Expires in: ${data.expiresIn}s`);
```

```python Python
import requests

response = requests.post(
    'https://your-supabase-project.supabase.co/functions/v1/get-aws-credentials',
    headers={'Authorization': 'Bearer YOUR_JWT_TOKEN'}
)

data = response.json()
print(f"Identity ID: {data['identityId']}")
print(f"From cache: {data['fromCache']}")
print(f"Expires in: {data['expiresIn']}s")
```
</RequestExample>

<ResponseExample>
```json 成功响应 - 首次获取
{
  "identityId": "ap-southeast-1:12345678-1234-1234-1234-123456789012",
  "credentials": {
    "AccessKeyId": "ASIAXXXXXXXXXXX",
    "SecretKey": "abcdefghijklmnopqrstuvwxyz1234567890ABCD",
    "SessionToken": "FwoGZXIvYXdzEBYaDH...",
    "Expiration": 1703002800
  },
  "policyAttached": true,
  "policyName": "PestGG-User-MQTT-Policy",
  "fromCache": false,
  "expiresIn": 3600
}
```

```json 成功响应 - 从缓存返回
{
  "identityId": "ap-southeast-1:12345678-1234-1234-1234-123456789012",
  "credentials": {
    "AccessKeyId": "ASIAXXXXXXXXXXX",
    "SecretKey": "abcdefghijklmnopqrstuvwxyz1234567890ABCD",
    "SessionToken": "FwoGZXIvYXdzEBYaDH...",
    "Expiration": 1703002800
  },
  "policyAttached": true,
  "policyName": "PestGG-User-MQTT-Policy",
  "fromCache": true,
  "expiresIn": 2850
}
```

```json 错误响应 - Cognito错误
{
  "error": {
    "code": "COGNITO_ERROR",
    "message": "Failed to get identity from Cognito: InvalidParameterException",
    "statusCode": 500
  }
}
```
</ResponseExample>

## 使用说明

### 凭证用途

获取的AWS凭证用于：
1. **MQTT over WebSocket连接** - 连接到AWS IoT Core
2. **实时设备控制** - 通过MQTT发送控制命令
3. **实时遥测订阅** - 订阅设备Shadow更新

### 缓存机制

<Steps>
  <Step title="检查缓存">
    系统首先检查数据库中是否有未过期的凭证
  </Step>

  <Step title="返回缓存">
    如果缓存有效（距离过期>5分钟），直接返回（<100ms）
  </Step>

  <Step title="获取新凭证">
    如果缓存失效，调用AWS Cognito获取新凭证（1-2秒）
  </Step>

  <Step title="保存缓存">
    将新凭证保存到数据库，有效期1小时
  </Step>
</Steps>

### 凭证有效期

- **默认有效期**: 1小时
- **刷新建议**: 剩余时间<5分钟时自动刷新
- **缓存保留**: 距离过期>5分钟时使用缓存

### MQTT连接示例

使用获取的凭证连接AWS IoT Core：

```javascript
import { mqtt } from 'aws-iot-device-sdk-v2';

// 1. 获取凭证
const credResponse = await fetch('/get-aws-credentials', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${jwtToken}` }
});
const { credentials, identityId } = await credResponse.json();

// 2. 构建MQTT连接
const config = {
  endpoint: 'a2b3c4d5e6f7g8.iot.ap-southeast-1.amazonaws.com',
  credentials: {
    accessKeyId: credentials.AccessKeyId,
    secretAccessKey: credentials.SecretKey,
    sessionToken: credentials.SessionToken
  }
};

// 3. 连接MQTT
const connection = mqtt.aws_iot_mqtt_connection_builder
  .websockets()
  .with_credentials(
    config.credentials.accessKeyId,
    config.credentials.secretAccessKey,
    config.credentials.sessionToken
  )
  .with_endpoint(config.endpoint)
  .build();

await connection.connect();
console.log('MQTT connected!');

// 4. 订阅设备Shadow更新
await connection.subscribe(
  `$aws/things/RT4G:001/shadow/update/documents`,
  mqtt.QoS.AtLeastOnce,
  (topic, payload) => {
    const message = JSON.parse(payload.toString());
    console.log('Shadow updated:', message.current.state.reported);
  }
);
```

### IoT策略权限

`PestGG-User-MQTT-Policy` 允许用户：
- 连接到AWS IoT Core（`iot:Connect`）
- 订阅设备Shadow主题（`iot:Subscribe`）
- 接收Shadow更新（`iot:Receive`）
- 发布控制命令（`iot:Publish`）

<Note>
**首次调用**: 首次调用会自动将IoT策略附加到您的Cognito Identity，后续调用无需重复附加。
</Note>

<Warning>
**凭证安全**: SessionToken是临时凭证，有效期1小时。请勿将凭证硬编码或泄露给第三方。
</Warning>

### 性能优化

推荐的调用策略：
1. **应用启动时**获取一次凭证
2. **每50分钟**刷新一次
3. **MQTT断线时**重新获取（可能凭证已过期）
4. 利用 `fromCache` 字段判断响应速度

### 常见问题

<AccordionGroup>
  <Accordion title="凭证过期后会怎样？">
    凭证过期后MQTT连接会断开。建议在过期前5分钟主动刷新凭证。
  </Accordion>

  <Accordion title="多个设备需要多次调用吗？">
    不需要。一个用户获取一次凭证即可控制其所有设备。
  </Accordion>

  <Accordion title="缓存在哪里？">
    凭证缓存在Supabase数据库的 `cognito_credentials_cache` 表中，按用户ID索引。
  </Accordion>
</AccordionGroup>
