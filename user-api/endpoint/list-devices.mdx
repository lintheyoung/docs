---
title: 'è·å–è®¾å¤‡åˆ—è¡¨'
openapi: 'GET /user-devices'
---

## æ¥å£è¯´æ˜

è·å–å½“å‰ç”¨æˆ·ç§Ÿæˆ·ä¸‹çš„æ‰€æœ‰è®¾å¤‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç½‘å…³è®¾å¤‡å’Œå­è®¾å¤‡ã€‚è¿”å›è®¾å¤‡çš„å±‚çº§å…³ç³»ã€çŠ¶æ€ã€ç±»å‹ç­‰è¯¦ç»†ä¿¡æ¯ã€‚

## æŸ¥è¯¢å‚æ•°

<ParamField query="device_type" type="string">
  æŒ‰è®¾å¤‡ç±»å‹ç­›é€‰
  - `gateway`: ä»…è¿”å›ç½‘å…³è®¾å¤‡
  - `smart_trap`: ä»…è¿”å›æ™ºèƒ½æ•é¼ å™¨
  - `vibration_sensor`: ä»…è¿”å›éœ‡åŠ¨ä¼ æ„Ÿå™¨
  - `temp_humidity_sensor`: ä»…è¿”å›æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨
  - `pir_sensor`: ä»…è¿”å›çº¢å¤–ä¼ æ„Ÿå™¨
  - ä¸ä¼ åˆ™è¿”å›æ‰€æœ‰è®¾å¤‡
</ParamField>

<ParamField query="status" type="string">
  æŒ‰è®¾å¤‡çŠ¶æ€ç­›é€‰
  - `registered`: å·²æ³¨å†Œï¼ˆå·¥å‚åˆ›å»ºï¼‰
  - `pending`: å¾…è®¾ç½®ï¼ˆå·²ç»‘å®šæœªå®Œæˆè®¾ç½®ï¼‰
  - `active`: æ¿€æ´»ï¼ˆå¯æ­£å¸¸ä½¿ç”¨ï¼‰
  - `inactive`: åœç”¨
  - `offline`: ç¦»çº¿
  - ä¸ä¼ åˆ™è¿”å›æ‰€æœ‰çŠ¶æ€
</ParamField>

<ParamField query="gateway_id" type="string">
  æŒ‰ç½‘å…³ç­›é€‰ï¼Œè¿”å›æŒ‡å®šç½‘å…³ä¸‹çš„æ‰€æœ‰å­è®¾å¤‡

  ç¤ºä¾‹: `d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b`
</ParamField>

<ParamField query="include_shared" type="boolean" default="true">
  æ˜¯å¦åŒ…å«å…¶ä»–ç”¨æˆ·å…±äº«ç»™æˆ‘çš„è®¾å¤‡
  - `true`: åŒ…å«å…±äº«è®¾å¤‡ï¼ˆé»˜è®¤ï¼‰
  - `false`: ä»…è¿”å›è‡ªå·±ç»‘å®šçš„è®¾å¤‡
</ParamField>

<ParamField query="page" type="number" default="1">
  é¡µç ï¼Œä»1å¼€å§‹
</ParamField>

<ParamField query="limit" type="number" default="20">
  æ¯é¡µæ•°é‡ï¼ŒèŒƒå›´: 1-100
</ParamField>

## å“åº”æ•°æ®

<ResponseField name="devices" type="array">
  è®¾å¤‡åˆ—è¡¨

  <Expandable title="Device å¯¹è±¡">
    <ResponseField name="device_id" type="string">
      è®¾å¤‡ID (UUID)
    </ResponseField>

    <ResponseField name="thing_name" type="string">
      AWS IoT Thingåç§°ï¼Œä¾‹å¦‚: `IoT-Gateway-000001`
    </ResponseField>

    <ResponseField name="device_type" type="string">
      è®¾å¤‡ç±»å‹: `gateway` | `vibration_sensor` | `smart_trap` | `temp_humidity_sensor` | `pir_sensor`
    </ResponseField>

    <ResponseField name="model" type="string">
      è®¾å¤‡å‹å·ï¼Œä¾‹å¦‚: `RT-Gateway-Pro`, `SmartTrap-v2`
    </ResponseField>

    <ResponseField name="device_nickname" type="string">
      è®¾å¤‡æ˜µç§°
    </ResponseField>

    <ResponseField name="status" type="string">
      è®¾å¤‡çŠ¶æ€: `registered` | `pending` | `active` | `inactive` | `offline`
    </ResponseField>

    <ResponseField name="online" type="boolean">
      æ˜¯å¦åœ¨çº¿
    </ResponseField>

    <ResponseField name="gateway_id" type="string">
      æ‰€å±ç½‘å…³IDï¼ˆä»…å­è®¾å¤‡æœ‰æ­¤å­—æ®µï¼‰
    </ResponseField>

    <ResponseField name="gateway_info" type="object">
      æ‰€å±ç½‘å…³ä¿¡æ¯ï¼ˆä»…å­è®¾å¤‡æœ‰æ­¤å­—æ®µï¼‰

      <Expandable title="GatewayInfo">
        <ResponseField name="device_id" type="string">
          ç½‘å…³è®¾å¤‡ID
        </ResponseField>

        <ResponseField name="thing_name" type="string">
          ç½‘å…³Thingåç§°
        </ResponseField>

        <ResponseField name="device_nickname" type="string">
          ç½‘å…³æ˜µç§°
        </ResponseField>

        <ResponseField name="online" type="boolean">
          ç½‘å…³æ˜¯å¦åœ¨çº¿
        </ResponseField>
      </Expandable>
    </ResponseField>

    <ResponseField name="child_devices" type="array">
      å­è®¾å¤‡åˆ—è¡¨ï¼ˆä»…ç½‘å…³è®¾å¤‡æœ‰æ­¤å­—æ®µï¼‰

      åŒ…å«è¯¥ç½‘å…³ä¸‹æ‰€æœ‰å­è®¾å¤‡çš„ç®€è¦ä¿¡æ¯
    </ResponseField>

    <ResponseField name="child_count" type="number">
      å­è®¾å¤‡æ•°é‡ï¼ˆä»…ç½‘å…³è®¾å¤‡æœ‰æ­¤å­—æ®µï¼‰
    </ResponseField>

    <ResponseField name="bound_at" type="string">
      ç»‘å®šæ—¶é—´ (ISO 8601)
    </ResponseField>

    <ResponseField name="last_seen" type="string">
      æœ€åä¸Šçº¿æ—¶é—´ (ISO 8601)
    </ResponseField>

    <ResponseField name="owner_info" type="object">
      è®¾å¤‡æ‰€æœ‰è€…ä¿¡æ¯

      <Expandable title="OwnerInfo">
        <ResponseField name="user_id" type="string">
          æ‰€æœ‰è€…ç”¨æˆ·ID
        </ResponseField>

        <ResponseField name="email" type="string">
          æ‰€æœ‰è€…é‚®ç®±
        </ResponseField>

        <ResponseField name="is_me" type="boolean">
          æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
        </ResponseField>
      </Expandable>
    </ResponseField>

    <ResponseField name="my_role" type="string">
      æˆ‘å¯¹æ­¤è®¾å¤‡çš„æƒé™è§’è‰²: `owner` | `editor` | `viewer`
    </ResponseField>

    <ResponseField name="metadata" type="object">
      è®¾å¤‡å…ƒæ•°æ®ï¼ˆè‡ªå®šä¹‰å­—æ®µï¼‰
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="pagination" type="object">
  åˆ†é¡µä¿¡æ¯

  <Expandable title="Pagination">
    <ResponseField name="page" type="number">
      å½“å‰é¡µç 
    </ResponseField>

    <ResponseField name="limit" type="number">
      æ¯é¡µæ•°é‡
    </ResponseField>

    <ResponseField name="total" type="number">
      æ€»è®¾å¤‡æ•°
    </ResponseField>

    <ResponseField name="total_pages" type="number">
      æ€»é¡µæ•°
    </ResponseField>
  </Expandable>
</ResponseField>

<ResponseField name="summary" type="object">
  è®¾å¤‡ç»Ÿè®¡æ‘˜è¦

  <Expandable title="Summary">
    <ResponseField name="total_devices" type="number">
      æ€»è®¾å¤‡æ•°
    </ResponseField>

    <ResponseField name="gateways_count" type="number">
      ç½‘å…³æ•°é‡
    </ResponseField>

    <ResponseField name="child_devices_count" type="number">
      å­è®¾å¤‡æ•°é‡
    </ResponseField>

    <ResponseField name="online_count" type="number">
      åœ¨çº¿è®¾å¤‡æ•°
    </ResponseField>

    <ResponseField name="offline_count" type="number">
      ç¦»çº¿è®¾å¤‡æ•°
    </ResponseField>

    <ResponseField name="by_type" type="object">
      æŒ‰è®¾å¤‡ç±»å‹ç»Ÿè®¡
    </ResponseField>
  </Expandable>
</ResponseField>

## é”™è¯¯ç 

| é”™è¯¯ç  | HTTPçŠ¶æ€ç  | è¯´æ˜ |
|--------|-----------|------|
| `UNAUTHORIZED` | 401 | ç¼ºå°‘æˆ–æ— æ•ˆçš„è®¤è¯Token |
| `INVALID_PARAMETERS` | 400 | æŸ¥è¯¢å‚æ•°éªŒè¯å¤±è´¥ |
| `GATEWAY_NOT_FOUND` | 404 | æŒ‡å®šçš„ç½‘å…³ä¸å­˜åœ¨ |
| `DATABASE_ERROR` | 500 | æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ |

<RequestExample>
```bash cURL - è·å–æ‰€æœ‰è®¾å¤‡
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/user-devices' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

```bash cURL - ä»…è·å–ç½‘å…³è®¾å¤‡
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/user-devices?device_type=gateway' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

```bash cURL - è·å–æŒ‡å®šç½‘å…³çš„æ‰€æœ‰å­è®¾å¤‡
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/user-devices?gateway_id=d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

```bash cURL - è·å–åœ¨çº¿è®¾å¤‡
curl -X GET \
  'https://your-supabase-project.supabase.co/functions/v1/user-devices?status=active' \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

```javascript Node.js - è·å–æ‰€æœ‰è®¾å¤‡
const response = await fetch(
  'https://your-supabase-project.supabase.co/functions/v1/user-devices',
  {
    method: 'GET',
    headers: {
      'Authorization': 'Bearer YOUR_JWT_TOKEN'
    }
  }
);

const data = await response.json();
console.log(`Total devices: ${data.summary.total_devices}`);
console.log(`Gateways: ${data.summary.gateways_count}`);
console.log(`Child devices: ${data.summary.child_devices_count}`);

// éå†è®¾å¤‡
data.devices.forEach(device => {
  console.log(`${device.device_nickname} (${device.device_type}): ${device.status}`);

  if (device.device_type === 'gateway' && device.child_devices) {
    console.log(`  â””â”€ Has ${device.child_count} child devices`);
  }

  if (device.gateway_info) {
    console.log(`  â””â”€ Connected to gateway: ${device.gateway_info.device_nickname}`);
  }
});
```

```javascript Node.js - æŒ‰ç½‘å…³ç»„ç»‡è®¾å¤‡
// è·å–æ‰€æœ‰è®¾å¤‡
const { devices } = await fetch('/user-devices').then(r => r.json());

// æ„å»ºç½‘å…³->å­è®¾å¤‡çš„å±‚çº§ç»“æ„
const gateways = devices.filter(d => d.device_type === 'gateway');

gateways.forEach(gateway => {
  console.log(`\nğŸ“¡ ${gateway.device_nickname} (${gateway.online ? 'åœ¨çº¿' : 'ç¦»çº¿'})`);

  const children = devices.filter(d => d.gateway_id === gateway.device_id);
  children.forEach(child => {
    console.log(`  â””â”€ ${child.device_nickname} (${child.device_type})`);
  });
});
```

```python Python - è·å–æ‰€æœ‰è®¾å¤‡
import requests

response = requests.get(
    'https://your-supabase-project.supabase.co/functions/v1/user-devices',
    headers={'Authorization': 'Bearer YOUR_JWT_TOKEN'}
)

data = response.json()
print(f"Total devices: {data['summary']['total_devices']}")
print(f"Gateways: {data['summary']['gateways_count']}")
print(f"Child devices: {data['summary']['child_devices_count']}")

# éå†è®¾å¤‡
for device in data['devices']:
    status_icon = 'ğŸŸ¢' if device['online'] else 'ğŸ”´'
    print(f"{status_icon} {device['device_nickname']} ({device['device_type']})")

    if device['device_type'] == 'gateway':
        print(f"  â””â”€ {device['child_count']} child devices")
```

```python Python - æŒ‰ç½‘å…³åˆ†ç»„æ˜¾ç¤º
import requests
from collections import defaultdict

response = requests.get(
    'https://your-supabase-project.supabase.co/functions/v1/user-devices',
    headers={'Authorization': 'Bearer YOUR_JWT_TOKEN'}
)

devices = response.json()['devices']

# åˆ†ç»„ï¼šç½‘å…³å’Œå­è®¾å¤‡
gateways = [d for d in devices if d['device_type'] == 'gateway']
children_by_gateway = defaultdict(list)

for device in devices:
    if 'gateway_id' in device:
        children_by_gateway[device['gateway_id']].append(device)

# æ˜¾ç¤ºå±‚çº§ç»“æ„
for gateway in gateways:
    status = 'ğŸŸ¢ åœ¨çº¿' if gateway['online'] else 'ğŸ”´ ç¦»çº¿'
    print(f"\nğŸ“¡ {gateway['device_nickname']} ({status})")

    children = children_by_gateway.get(gateway['device_id'], [])
    for child in children:
        child_status = 'ğŸŸ¢' if child['online'] else 'ğŸ”´'
        print(f"  {child_status} â””â”€ {child['device_nickname']} ({child['device_type']})")
```
</RequestExample>

<ResponseExample>
```json æˆåŠŸå“åº” - è·å–æ‰€æœ‰è®¾å¤‡
{
  "devices": [
    {
      "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "thing_name": "IoT-Gateway-000001",
      "device_type": "gateway",
      "model": "RT-Gateway-Pro",
      "device_nickname": "å®¶åº­ç½‘å…³",
      "status": "active",
      "online": true,
      "child_count": 3,
      "child_devices": [
        {
          "device_id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
          "thing_name": "IoT-Trap-000100",
          "device_type": "smart_trap",
          "device_nickname": "å®¢å…æ•é¼ å™¨",
          "online": true
        },
        {
          "device_id": "b2c3d4e5-6f7g-8h9i-0j1k-2l3m4n5o6p7q",
          "thing_name": "IoT-VibSensor-000001",
          "device_type": "vibration_sensor",
          "device_nickname": "å¨æˆ¿éœ‡åŠ¨ä¼ æ„Ÿå™¨",
          "online": true
        },
        {
          "device_id": "c3d4e5f6-7g8h-9i0j-1k2l-3m4n5o6p7q8r",
          "thing_name": "IoT-TempSensor-000001",
          "device_type": "temp_humidity_sensor",
          "device_nickname": "å§å®¤æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨",
          "online": false
        }
      ],
      "bound_at": "2024-12-23T10:30:00Z",
      "last_seen": "2024-12-23T18:45:00Z",
      "firmware_version": "v2.1.0",
      "owner_info": {
        "user_id": "user_abc123",
        "email": "user@example.com",
        "is_me": true
      },
      "my_role": "owner",
      "metadata": {
        "location": "å®¢å…",
        "installation_date": "2024-12-20"
      }
    },
    {
      "device_id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
      "thing_name": "IoT-Trap-000100",
      "device_type": "smart_trap",
      "model": "SmartTrap-v2",
      "device_nickname": "å®¢å…æ•é¼ å™¨",
      "status": "active",
      "online": true,
      "gateway_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "gateway_info": {
        "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
        "thing_name": "IoT-Gateway-000001",
        "device_nickname": "å®¶åº­ç½‘å…³",
        "online": true
      },
      "bound_at": "2024-12-23T10:35:00Z",
      "last_seen": "2024-12-23T18:45:00Z",
      "firmware_version": "v1.5.0",
      "owner_info": {
        "user_id": "user_abc123",
        "email": "user@example.com",
        "is_me": true
      },
      "my_role": "owner",
      "metadata": {
        "location": "å®¢å…",
        "bait_type": "peanut_butter"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 4,
    "total_pages": 1
  },
  "summary": {
    "total_devices": 4,
    "gateways_count": 1,
    "child_devices_count": 3,
    "online_count": 3,
    "offline_count": 1,
    "by_type": {
      "gateway": 1,
      "smart_trap": 1,
      "vibration_sensor": 1,
      "temp_humidity_sensor": 1
    }
  }
}
```

```json æˆåŠŸå“åº” - ä»…è·å–ç½‘å…³è®¾å¤‡
{
  "devices": [
    {
      "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "thing_name": "IoT-Gateway-000001",
      "device_type": "gateway",
      "model": "RT-Gateway-Pro",
      "device_nickname": "å®¶åº­ç½‘å…³",
      "status": "active",
      "online": true,
      "child_count": 3,
      "child_devices": [
        {
          "device_id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
          "thing_name": "IoT-Trap-000100",
          "device_type": "smart_trap",
          "device_nickname": "å®¢å…æ•é¼ å™¨",
          "online": true
        }
      ],
      "bound_at": "2024-12-23T10:30:00Z",
      "last_seen": "2024-12-23T18:45:00Z",
      "owner_info": {
        "user_id": "user_abc123",
        "email": "user@example.com",
        "is_me": true
      },
      "my_role": "owner"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 1,
    "total_pages": 1
  },
  "summary": {
    "total_devices": 1,
    "gateways_count": 1,
    "child_devices_count": 0,
    "online_count": 1,
    "offline_count": 0,
    "by_type": {
      "gateway": 1
    }
  }
}
```

```json æˆåŠŸå“åº” - è·å–æŒ‡å®šç½‘å…³çš„å­è®¾å¤‡
{
  "devices": [
    {
      "device_id": "a1b2c3d4-5e6f-7g8h-9i0j-1k2l3m4n5o6p",
      "thing_name": "IoT-Trap-000100",
      "device_type": "smart_trap",
      "device_nickname": "å®¢å…æ•é¼ å™¨",
      "status": "active",
      "online": true,
      "gateway_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "gateway_info": {
        "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
        "thing_name": "IoT-Gateway-000001",
        "device_nickname": "å®¶åº­ç½‘å…³",
        "online": true
      },
      "my_role": "owner"
    },
    {
      "device_id": "b2c3d4e5-6f7g-8h9i-0j1k-2l3m4n5o6p7q",
      "thing_name": "IoT-VibSensor-000001",
      "device_type": "vibration_sensor",
      "device_nickname": "å¨æˆ¿éœ‡åŠ¨ä¼ æ„Ÿå™¨",
      "status": "active",
      "online": true,
      "gateway_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
      "gateway_info": {
        "device_id": "d9e3f5c1-4e0a-4b5e-8f3a-1c2d3e4f5a6b",
        "thing_name": "IoT-Gateway-000001",
        "device_nickname": "å®¶åº­ç½‘å…³",
        "online": true
      },
      "my_role": "owner"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 3,
    "total_pages": 1
  },
  "summary": {
    "total_devices": 3,
    "gateways_count": 0,
    "child_devices_count": 3,
    "online_count": 2,
    "offline_count": 1,
    "by_type": {
      "smart_trap": 1,
      "vibration_sensor": 1,
      "temp_humidity_sensor": 1
    }
  }
}
```

```json é”™è¯¯å“åº” - æœªæˆæƒ
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Missing or invalid authentication token",
    "statusCode": 401
  }
}
```

```json é”™è¯¯å“åº” - ç½‘å…³ä¸å­˜åœ¨
{
  "error": {
    "code": "GATEWAY_NOT_FOUND",
    "message": "Gateway device not found or not accessible",
    "statusCode": 404
  }
}
```
</ResponseExample>

## ä½¿ç”¨è¯´æ˜

### æƒé™è¦æ±‚
- éœ€è¦æœ‰æ•ˆçš„ç”¨æˆ·JWT Token
- è¿”å›å½“å‰ç”¨æˆ·ç§Ÿæˆ·ä¸‹çš„æ‰€æœ‰è®¾å¤‡
- åŒ…å«ç”¨æˆ·è‡ªå·±ç»‘å®šçš„è®¾å¤‡ + å…¶ä»–ç”¨æˆ·å…±äº«ç»™è‡ªå·±çš„è®¾å¤‡

### è®¾å¤‡å±‚çº§å…³ç³»

è¿”å›çš„è®¾å¤‡åˆ—è¡¨å±•ç¤ºäº†å®Œæ•´çš„å±‚çº§å…³ç³»ï¼š

**ç½‘å…³è®¾å¤‡å­—æ®µ**ï¼š
- `child_count`: å­è®¾å¤‡æ•°é‡
- `child_devices`: å­è®¾å¤‡ç®€è¦ä¿¡æ¯æ•°ç»„

**å­è®¾å¤‡å­—æ®µ**ï¼š
- `gateway_id`: æ‰€å±ç½‘å…³çš„è®¾å¤‡ID
- `gateway_info`: æ‰€å±ç½‘å…³çš„è¯¦ç»†ä¿¡æ¯

### æ•°æ®å±•ç¤ºå»ºè®®

#### åˆ—è¡¨è§†å›¾
```
ğŸ“¡ å®¶åº­ç½‘å…³ (åœ¨çº¿) - 3ä¸ªå­è®¾å¤‡
  â””â”€ ğŸŸ¢ å®¢å…æ•é¼ å™¨
  â””â”€ ğŸŸ¢ å¨æˆ¿éœ‡åŠ¨ä¼ æ„Ÿå™¨
  â””â”€ ğŸ”´ å§å®¤æ¸©æ¹¿åº¦ä¼ æ„Ÿå™¨
```

#### å¡ç‰‡è§†å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¡ å®¶åº­ç½‘å…³             â”‚
â”‚ çŠ¶æ€: ğŸŸ¢ åœ¨çº¿           â”‚
â”‚ å­è®¾å¤‡: 3ä¸ª             â”‚
â”‚ æœ€åä¸Šçº¿: 5åˆ†é’Ÿå‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸª¤ å®¢å…æ•é¼ å™¨           â”‚
â”‚ çŠ¶æ€: ğŸŸ¢ åœ¨çº¿           â”‚
â”‚ ç½‘å…³: å®¶åº­ç½‘å…³          â”‚
â”‚ æœ€åä¸Šçº¿: 1åˆ†é’Ÿå‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç­›é€‰åœºæ™¯

<Tabs>
  <Tab title="æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡">
    ```javascript
    GET /user-devices
    ```
    è¿”å›ç§Ÿæˆ·ä¸‹æ‰€æœ‰è®¾å¤‡ï¼ˆç½‘å…³ + å­è®¾å¤‡ï¼‰
  </Tab>

  <Tab title="ä»…æŸ¥çœ‹ç½‘å…³">
    ```javascript
    GET /user-devices?device_type=gateway
    ```
    ç”¨äºç®¡ç†ç½‘å…³åˆ—è¡¨
  </Tab>

  <Tab title="æŸ¥çœ‹æŸç½‘å…³çš„å­è®¾å¤‡">
    ```javascript
    GET /user-devices?gateway_id={gateway_id}
    ```
    å±•ç¤ºæŒ‡å®šç½‘å…³ä¸‹çš„æ‰€æœ‰å­è®¾å¤‡
  </Tab>

  <Tab title="æŸ¥çœ‹ç¦»çº¿è®¾å¤‡">
    ```javascript
    GET /user-devices?status=offline
    ```
    å¿«é€Ÿå®šä½é—®é¢˜è®¾å¤‡
  </Tab>

  <Tab title="ä»…è‡ªå·±çš„è®¾å¤‡">
    ```javascript
    GET /user-devices?include_shared=false
    ```
    æ’é™¤å…¶ä»–ç”¨æˆ·å…±äº«çš„è®¾å¤‡
  </Tab>
</Tabs>

### å‰ç«¯å®ç°ç¤ºä¾‹

#### React ç»„ä»¶ç¤ºä¾‹

```jsx
import { useState, useEffect } from 'react';

function DeviceList() {
  const [devices, setDevices] = useState([]);
  const [summary, setSummary] = useState({});
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDevices();
  }, []);

  const fetchDevices = async () => {
    const response = await fetch('/user-devices', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const data = await response.json();
    setDevices(data.devices);
    setSummary(data.summary);
    setLoading(false);
  };

  // æŒ‰ç½‘å…³åˆ†ç»„
  const gateways = devices.filter(d => d.device_type === 'gateway');

  return (
    <div>
      <h2>æˆ‘çš„è®¾å¤‡ ({summary.total_devices})</h2>
      <p>åœ¨çº¿: {summary.online_count} | ç¦»çº¿: {summary.offline_count}</p>

      {gateways.map(gateway => (
        <div key={gateway.device_id} className="gateway-card">
          <h3>
            {gateway.online ? 'ğŸŸ¢' : 'ğŸ”´'} {gateway.device_nickname}
          </h3>
          <p>{gateway.child_count} ä¸ªå­è®¾å¤‡</p>

          <div className="child-devices">
            {gateway.child_devices?.map(child => (
              <div key={child.device_id} className="child-device">
                {child.online ? 'ğŸŸ¢' : 'ğŸ”´'} {child.device_nickname}
              </div>
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

<Note>
**åˆ†é¡µåŠ è½½**: è®¾å¤‡æ•°é‡è¾ƒå¤šæ—¶ï¼Œå»ºè®®ä½¿ç”¨åˆ†é¡µå‚æ•° `page` å’Œ `limit`
</Note>

<Note>
**ç¼“å­˜ç­–ç•¥**: è®¾å¤‡åˆ—è¡¨å˜åŒ–ä¸é¢‘ç¹ï¼Œå»ºè®®å®¢æˆ·ç«¯ç¼“å­˜5-10åˆ†é’Ÿ
</Note>

<Note>
**å¢é‡æ›´æ–°**: ä½¿ç”¨MQTTè®¢é˜…è®¾å¤‡çŠ¶æ€å˜åŒ–ï¼Œå®æ—¶æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼Œé¿å…é¢‘ç¹è½®è¯¢
</Note>

### å¸¸è§é—®é¢˜

<AccordionGroup>
  <Accordion title="ä¸ºä»€ä¹ˆçœ‹ä¸åˆ°æŸäº›è®¾å¤‡ï¼Ÿ">
    å¯èƒ½çš„åŸå› ï¼š
    1. è®¾å¤‡å±äºå…¶ä»–ç§Ÿæˆ·ï¼ˆä¸åŒè´¦å·ï¼‰
    2. è®¾å¤‡å°šæœªç»‘å®šåˆ°æ‚¨çš„è´¦å·
    3. æ‚¨æ²¡æœ‰è¯¥è®¾å¤‡çš„è®¿é—®æƒé™
    4. ä½¿ç”¨äº†ç­›é€‰å‚æ•°è¿‡æ»¤æ‰äº†
  </Accordion>

  <Accordion title="child_devices å’Œå•ç‹¬æŸ¥è¯¢å­è®¾å¤‡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ">
    - `child_devices`: ç½‘å…³å¯¹è±¡ä¸­å†…åµŒçš„ç®€è¦å­è®¾å¤‡åˆ—è¡¨ï¼Œæ–¹ä¾¿å¿«é€Ÿå±•ç¤ºå±‚çº§
    - å•ç‹¬æŸ¥è¯¢: ä½¿ç”¨ `gateway_id` å‚æ•°è·å–å®Œæ•´çš„å­è®¾å¤‡è¯¦ç»†ä¿¡æ¯

    å»ºè®®ï¼šåˆ—è¡¨é¡µç”¨ `child_devices`ï¼Œè¯¦æƒ…é¡µå†å•ç‹¬æŸ¥è¯¢
  </Accordion>

  <Accordion title="å¦‚ä½•å®æ—¶æ›´æ–°è®¾å¤‡åœ¨çº¿çŠ¶æ€ï¼Ÿ">
    ä¸¤ç§æ–¹å¼ï¼š
    1. **è½®è¯¢**: æ¯30-60ç§’è°ƒç”¨ä¸€æ¬¡æ­¤æ¥å£ï¼ˆä¸æ¨èï¼‰
    2. **MQTTè®¢é˜…**ï¼ˆæ¨èï¼‰:
       ```javascript
       // è®¢é˜…è®¾å¤‡çŠ¶æ€å˜åŒ–
       subscribe('$aws/events/presence/connected/+');
       subscribe('$aws/events/presence/disconnected/+');
       ```
  </Accordion>

  <Accordion title="è®¾å¤‡å¾ˆå¤šæ—¶å¦‚ä½•æé«˜åŠ è½½é€Ÿåº¦ï¼Ÿ">
    1. ä½¿ç”¨åˆ†é¡µ: `limit=20` æ¯é¡µä»…åŠ è½½20ä¸ªè®¾å¤‡
    2. æŒ‰éœ€åŠ è½½: å…ˆåŠ è½½ç½‘å…³ï¼Œç‚¹å‡»åå†åŠ è½½å­è®¾å¤‡
    3. ä½¿ç”¨ç­›é€‰: æŒ‰ `device_type` æˆ– `status` å‡å°‘è¿”å›æ•°æ®
    4. å¯ç”¨å®¢æˆ·ç«¯ç¼“å­˜
  </Accordion>

  <Accordion title="å…±äº«è®¾å¤‡å¦‚ä½•åŒºåˆ†ï¼Ÿ">
    æŸ¥çœ‹ `owner_info.is_me` å­—æ®µï¼š
    - `true`: è‡ªå·±ç»‘å®šçš„è®¾å¤‡
    - `false`: å…¶ä»–ç”¨æˆ·å…±äº«ç»™æˆ‘çš„è®¾å¤‡

    åŒæ—¶ `my_role` è¡¨ç¤ºæ‚¨å¯¹æ­¤è®¾å¤‡çš„æƒé™çº§åˆ«ã€‚
  </Accordion>
</AccordionGroup>

## æœ€ä½³å®è·µ

### ç§»åŠ¨ç«¯ App

```javascript
// 1. Appå¯åŠ¨æ—¶åŠ è½½è®¾å¤‡åˆ—è¡¨
const { devices, summary } = await fetchDevices();
localStorage.setItem('devices', JSON.stringify(devices));
localStorage.setItem('devices_timestamp', Date.now());

// 2. å»ºç«‹MQTTè¿æ¥ï¼Œè®¢é˜…è®¾å¤‡çŠ¶æ€
devices.forEach(device => {
  subscribeToDevice(device.thing_name);
});

// 3. å®šæœŸåˆ·æ–°ï¼ˆ30åˆ†é’Ÿï¼‰
setInterval(async () => {
  const { devices } = await fetchDevices();
  updateLocalCache(devices);
}, 30 * 60 * 1000);
```

### Web Dashboard

```javascript
// ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼ˆRedux/Zustandï¼‰
const useDeviceStore = create((set) => ({
  devices: [],
  summary: {},

  fetchDevices: async (filters) => {
    const params = new URLSearchParams(filters);
    const response = await fetch(`/user-devices?${params}`);
    const data = await response.json();
    set({ devices: data.devices, summary: data.summary });
  },

  updateDeviceStatus: (deviceId, online) => {
    set(state => ({
      devices: state.devices.map(d =>
        d.device_id === deviceId ? { ...d, online } : d
      )
    }));
  }
}));
```

### è®¾å¤‡æ ‘çŠ¶å›¾

```javascript
// æ„å»ºå±‚çº§æ ‘ç»“æ„ç”¨äºUIå±•ç¤º
function buildDeviceTree(devices) {
  const gateways = devices.filter(d => d.device_type === 'gateway');

  return gateways.map(gateway => ({
    ...gateway,
    children: devices.filter(d => d.gateway_id === gateway.device_id)
  }));
}

// ä½¿ç”¨
const tree = buildDeviceTree(devices);
<TreeView data={tree} />
```
