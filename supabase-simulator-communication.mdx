# Supabase 后端与 Python 模拟器通信指南

> 详细介绍 Supabase 后端和 Python 模拟器如何通信，包括 MQTT 频道订阅、连接要求和完整通信流程

## 概述

PestGG IoT 系统采用 **AWS IoT Core + Supabase** 双路架构：

- **实时路径**：设备 ⇄ AWS IoT Core (MQTT) ⇄ Web UI - 延迟 <100ms
- **持久路径**：设备 → AWS IoT Core → Projector Lambda → Supabase - 延迟 1-3秒

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        通信架构总览                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Python Simulator        AWS IoT Core          Supabase Backend            │
│   (设备模拟器)                                    (业务逻辑)                  │
│          │                    │                        │                     │
│          │  MQTT 证书认证      │                        │                     │
│          │──────────────────►│                        │                     │
│          │                    │                        │                     │
│          │  Shadow Update     │                        │                     │
│          │  (reported)        │                        │                     │
│          │──────────────────►│                        │                     │
│          │                    │  IoT Rule              │                     │
│          │                    │───────────────────────►│                     │
│          │                    │  (Shadow documents)    │                     │
│          │                    │                        │                     │
│          │                    │                        │  Projector Lambda   │
│          │                    │                        │  同步状态到数据库    │
│          │                    │                        │                     │
│          │  Shadow Delta      │                        │                     │
│          │  (desired)         │                        │                     │
│          │◄───────────────────│                        │                     │
│          │                    │                        │                     │
│          │  执行命令           │                        │                     │
│          │                    │                        │                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 1. MQTT 频道订阅

### 1.1 设备需要订阅的频道

Python 模拟器作为网关设备，需要订阅以下 MQTT 主题：

| 主题模式 | 用途 | 订阅时机 |
|---------|------|---------|
| `$aws/things/{thingName}/shadow/name/{shadowName}/update/delta` | 接收云端下发的命令 | MQTT 连接成功后立即订阅 |
| `$aws/things/{thingName}/shadow/name/{shadowName}/update/accepted` | Shadow 更新确认 | 可选，用于确认上报成功 |
| `$aws/things/{thingName}/shadow/name/{shadowName}/get/accepted` | 获取当前 Shadow 状态 | 发送 GET 请求前订阅 |

### 1.2 Python 模拟器订阅代码示例

```python
# virtual_vibration_sensor.py 中的订阅逻辑

def subscribe_to_shadow_deltas(self):
    """订阅所有子设备的 Shadow Delta（接收云端命令）"""
    shadow_name = "vibration-sensor-001"
    thing_name = "IoT-Gateway-000011"

    # 订阅 Delta 主题（接收命令）
    delta_topic = f"$aws/things/{thing_name}/shadow/name/{shadow_name}/update/delta"

    self.mqtt_client.subscribe(
        topic=delta_topic,
        qos=0,  # QoS 0 = AT_MOST_ONCE
        callback=lambda topic, payload: self._on_shadow_delta(topic, payload)
    )

    logger.info(f"✅ Subscribed to delta: {delta_topic}")
```

### 1.3 主题格式说明

#### Classic Shadow（网关自身状态）
```
$aws/things/{thingName}/shadow/update
```

#### Named Shadow（子设备状态）
```
$aws/things/{thingName}/shadow/name/{shadowName}/update
```

示例：
- 网关 Thing: `IoT-Gateway-000011`
- 子设备 Shadow: `vibration-sensor-001`
- Delta 主题: `$aws/things/IoT-Gateway-000011/shadow/name/vibration-sensor-001/update/delta`

## 2. 连接硬性要求

### 2.1 证书认证

设备必须使用工厂生产时生成的 X.509 证书连接 AWS IoT Core：

| 配置项 | 说明 | 示例 |
|-------|------|------|
| **证书文件** | 设备证书 | `IoT-Gateway-000011.cert.pem` |
| **私钥文件** | 设备私钥（保密） | `IoT-Gateway-000011.private.key` |
| **根 CA** | Amazon 根 CA | `AmazonRootCA1.pem` |
| **IoT Endpoint** | 区域终端节点 | `a1f8xc5wo59rp8-ats.iot.ap-southeast-1.amazonaws.com` |
| **端口** | MQTT over TLS | `8883` |

### 2.2 连接参数

```python
# config.py 连接配置

MQTT_ENDPOINT = "a1f8xc5wo59rp8-ats.iot.ap-southeast-1.amazonaws.com"
MQTT_PORT = 8883
MQTT_KEEPALIVE = 30  # Keep-Alive 时间（秒）
MQTT_QOS_TELEMETRY = 0  # 遥测数据 QoS
MQTT_QOS_COMMAND = 0    # 命令响应 QoS
```

### 2.3 设备标识

每个设备需要正确配置以下标识：

```python
# config.py 设备标识配置

GATEWAY_THING = "IoT-Gateway-000011"  # AWS IoT Thing 名称
GATEWAY_DEVICE_ID = "435204e6-21c9-447d-ab6f-888c99b91926"  # Supabase UUID

VIRTUAL_DEVICE = {
    'device_id': '09aa8ad8-f23e-4e75-bcbe-332efeb431ce',  # 子设备 UUID
    'shadow_name': 'vibration-sensor-001',  # Named Shadow 名称
    'type': 'vibration_sensor'
}
```

**重要**：
- `thing_name` 必须与 AWS IoT 中注册的 Thing 名称一致
- `device_id` 必须是 Supabase `devices` 表中的 UUID
- `shadow_name` 用于区分同一网关下的不同子设备

### 2.4 心跳要求

为保持连接活跃，设备必须：

1. **MQTT Keep-Alive**：设置为 30 秒或更短
2. **定期上报**：至少每 60 秒发送一次遥测数据
3. **Shadow 更新**：即使状态无变化也要定期更新

```python
# 虚拟传感器心跳逻辑
def every_second(self):
    """每秒执行的逻辑"""
    now = time.time()

    # 定时发送遥测数据（10秒间隔）
    if now - self.last_telemetry_time >= self.telemetry_interval:
        self.generate_and_send_telemetry()
        self.last_telemetry_time = now
```

## 3. 完整通信流程

### 3.1 工厂生产阶段

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        工厂生产设备                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Admin Portal         Edge Function          AWS IoT Core    Database       │
│      │                   │                       │              │            │
│      │ POST              │                       │              │            │
│      │ /manufacturing-   │                       │              │            │
│      │ create-devices    │                       │              │            │
│      │ {                 │                       │              │            │
│      │   model: "RT-Pro",│                       │              │            │
│      │   count: 10       │                       │              │            │
│      │ }                 │                       │              │            │
│      │──────────────────►│                       │              │            │
│      │                   │                       │              │            │
│      │                   │ 1. CreateThing       │              │            │
│      │                   │─────────────────────►│              │            │
│      │                   │   Thing Created      │              │            │
│      │                   │◄─────────────────────│              │            │
│      │                   │                       │              │            │
│      │                   │ 2. CreateCertificate │              │            │
│      │                   │─────────────────────►│              │            │
│      │                   │   Cert + Key         │              │            │
│      │                   │◄─────────────────────│              │            │
│      │                   │                       │              │            │
│      │                   │ 3. AttachPolicy      │              │            │
│      │                   │─────────────────────►│              │            │
│      │                   │                       │              │            │
│      │                   │ 4. Insert to DB      │              │            │
│      │                   │─────────────────────────────────────►│            │
│      │                   │                       │              │            │
│      │   {               │                       │              │            │
│      │     "thing_name": │                       │              │            │
│      │       "IoT-Gateway-000011",              │              │            │
│      │     "activation_code":                   │              │            │
│      │       "RT4G-A3F2B1C9",                  │              │            │
│      │     "certificate_pem": "...",            │              │            │
│      │     "private_key": "..."  ⚠️ 仅此一次   │              │            │
│      │   }             │                       │              │            │
│      │◄──────────────────│                       │              │            │
│      │                   │                       │              │            │
└─────────────────────────────────────────────────────────────────────────────┘

⚠️ 重要：private_key 只在创建时返回，必须安全保存！
```

### 3.2 用户绑定阶段

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        用户绑定设备                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  User App           Edge Function          Database                        │
│      │                   │                       │                          │
│      │ POST              │                       │                          │
│      │ /user-device-bind │                       │                          │
│      │ {                 │                       │                          │
│      │   "activation_code":                    │                          │
│      │     "RT4G-A3F2B1C9"                    │                          │
│      │ }                │                       │                          │
│      │──────────────────►│                       │                          │
│      │                   │                       │                          │
│      │                   │ 1. Query code        │                          │
│      │                   │─────────────────────►│                          │
│      │                   │   Code details       │                          │
│      │                   │◄─────────────────────│                          │
│      │                   │                       │                          │
│      │                   │ 2. Check not used    │                          │
│      │                   │─────────────────────►│                          │
│      │                   │                       │                          │
│      │                   │ 3. Get user tenant   │                          │
│      │                   │─────────────────────►│                          │
│      │                   │                       │                          │
│      │                   │ 4. Create ownership  │                          │
│      │                   │─────────────────────►│                          │
│      │                   │                       │                          │
│      │                   │ 5. Mark code used    │                          │
│      │                   │─────────────────────►│                          │
│      │                   │                       │                          │
│      │                   │ 6. Update device     │                          │
│      │                   │    status = 'pending'│                          │
│      │                   │─────────────────────►│                          │
│      │                   │                       │                          │
│      │   {               │                       │                          │
│      │     "device_id": "xxx",                 │                          │
│      │     "status": "pending"                 │                          │
│      │   }             │                       │                          │
│      │◄──────────────────│                       │                          │
│      │                   │                       │                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 设备通信阶段

#### 3.3.1 设备启动流程

```
Python Simulator                    AWS IoT Core
      │                                   │
      │ 1. 使用证书连接                   │
      │─────────────────────────────────►│
      │                                   │
      │    连接成功                        │
      │◄─────────────────────────────────│
      │                                   │
      │ 2. 订阅 Shadow Delta              │
      │   $aws/things/.../update/delta   │
      │─────────────────────────────────►│
      │                                   │
      │ 3. 发送 Shadow GET                │
      │   获取当前状态（上线补偿）          │
      │─────────────────────────────────►│
      │                                   │
      │    返回当前 Shadow 状态            │
      │◄─────────────────────────────────│
      │                                   │
      │ 4. 检查是否有待执行命令            │
      │   (desired.reqId != reported.     │
      │    lastAckedReqId)                │
      │                                   │
      │ 5. 开始定期上报遥测数据            │
      │   (10秒间隔)                       │
      │─────────────────────────────────►│
      │                                   │
```

#### 3.3.2 命令下发流程

```
User App         Supabase          AWS IoT Core      Python Simulator
  │                 │                    │                   │
  │ POST            │                    │                   │
  │ /user-device-   │                    │                   │
  │ control         │                    │                   │
  │────────────────►│                    │                   │
  │                 │                    │                   │
  │                 │ Update Shadow      │                   │
  │                 │ desired            │                   │
  │                 │───────────────────►│                   │
  │                 │                    │                   │
  │                 │                    │ Publish Delta     │
  │                 │                    │───────────────────►│
  │                 │                    │                   │
  │                 │                    │         ┌─────────┐│
  │                 │                    │         │ 接收    ││
  │                 │                    │         │ Delta  ││
  │                 │                    │         └─────────┘│
  │                 │                    │                   │
  │                 │                    │    执行命令        │
  │                 │                    │                   │
  │                 │                    │    Update Shadow   │
  │                 │                    │    reported (ACK)  │
  │                 │                    │◄──────────────────│
  │                 │                    │                   │
  │                 │  IoT Rule          │                   │
  │                 │───────────────────►│                   │
  │                 │  (Lambda)          │                   │
  │                 │                    │                   │
  │                 │  Update DB         │                   │
  │                 │◄───────────────────│                   │
  │                 │                    │                   │
  │  实时更新        │                    │                   │
  │◄────────────────│                    │                   │
  │  (MQTT/WebSocket)                    │                   │
```

#### 3.3.3 遥测上报流程

```
Python Simulator      AWS IoT Core      IoT Rule          Projector Lambda    Supabase
      │                    │                  │                      │                 │
      │ Update Shadow      │                  │                      │                 │
      │ reported           │                  │                      │                 │
      │───────────────────►│                  │                      │                 │
      │                    │                  │                      │                 │
      │                    │ Shadow Update    │                      │                 │
      │                    │ documents        │                      │                 │
      │                    │─────────────────►│                      │                 │
      │                    │                  │                      │                 │
      │                    │                  │ Trigger              │                 │
      │                    │                  │─────────────────────►│                 │
      │                    │                  │                      │                 │
      │                    │                  │                      │ 1. Parse topic  │
      │                    │                  │                      │ 2. Archive to S3 │
      │                    │                  │                      │ 3. Update DB    │
      │                    │                  │                      │─────────────────►│
      │                    │                  │                      │                 │
      │                    │                  │                      │   telemetry_last │
      │                    │                  │                      │   device_status  │
      │                    │                  │                      │                 │
```

## 4. Python 模拟器配置

### 4.1 目录结构

```
PythonDeviceSim/
├── config.py                      # 配置文件
├── aws_iot_client.py              # AWS IoT MQTT 客户端
├── virtual_vibration_sensor.py    # 虚拟传感器实现
├── gui_main.py                    # GUI 界面
├── main.py                        # 启动入口
├── IoT-Gateway-000011.cert.pem    # 设备证书
├── IoT-Gateway-000011.private.key # 设备私钥
└── AmazonRootCA1.pem              # 根 CA
```

### 4.2 核心配置 (config.py)

```python
# AWS IoT 配置
GATEWAY_THING = "IoT-Gateway-000011"
MQTT_ENDPOINT = "a1f8xc5wo59rp8-ats.iot.ap-southeast-1.amazonaws.com"
GATEWAY_DEVICE_ID = "435204e6-21c9-447d-ab6f-888c99b91926"

# 虚拟设备配置
VIRTUAL_DEVICE = {
    'device_id': '09aa8ad8-f23e-4e75-bcbe-332efeb431ce',
    'shadow_name': 'vibration-sensor-001',
    'type': 'vibration_sensor'
}

# MQTT 配置
MQTT_PORT = 8883
MQTT_KEEPALIVE = 30
MQTT_QOS_TELEMETRY = 0  # QoS 0 = AT_MOST_ONCE
MQTT_QOS_COMMAND = 0

# 遥测配置
TELEMETRY_INTERVAL = 10  # 秒
```

### 4.3 启动模拟器

```bash
cd PythonDeviceSim

# GUI 模式
python main.py

# 命令行模式
python -c "from aws_iot_client import AWSIoTClient; from virtual_vibration_sensor import VirtualVibrationSensor; import time; client = AWSIoTClient(); sensor = VirtualVibrationSensor(client); client.connect(); sensor.mqtt_connected(); [sensor.every_second() for _ in range(600) if time.sleep(1) is None]"
```

## 5. 常见问题

### 5.1 连接失败

**问题**：MQTT 连接无法建立

**检查项**：
1. 证书文件路径是否正确
2. Thing Name 是否与 AWS IoT 中注册的一致
3. 网络是否可以访问 IoT Endpoint
4. 证书是否已激活（Active 状态）

```python
# 检查证书
cert_path = "./IoT-Gateway-000011.cert.pem"
key_path = "./IoT-Gateway-000011.private.key"
ca_path = "./AmazonRootCA1.pem"

import os
assert os.path.exists(cert_path), f"证书不存在: {cert_path}"
assert os.path.exists(key_path), f"私钥不存在: {key_path}"
assert os.path.exists(ca_path), f"根CA不存在: {ca_path}"
```

### 5.2 Shadow 更新未生效

**问题**：设备上报状态但前端看不到更新

**检查项**：
1. 是否订阅了正确的 Shadow 主题
2. topic 格式是否正确（Named Shadow 需要 `/shadow/name/{shadowName}/`）
3. payload 格式是否正确（需要 `{"state": {"reported": {...}}}`）

```python
# 正确的 Shadow 更新格式
payload = {
    "state": {
        "reported": {
            "battery": 100,
            "vibration_detected": False,
            "timestamp": int(time.time())
        }
    }
}

topic = f"$aws/things/{thing_name}/shadow/name/{shadow_name}/update"
mqtt_client.publish(topic, json.dumps(payload), qos=0)
```

### 5.3 命令未收到

**问题**：前端发送命令但设备无响应

**检查项**：
1. 是否订阅了 `update/delta` 主题
2. Shadow 的 desired 状态是否正确更新
3. 设备是否在线（检查 last_telemetry_time）

```python
# 检查订阅
delta_topic = f"$aws/things/{thing_name}/shadow/name/{shadow_name}/update/delta"
print(f"Subscribed to: {delta_topic}")

# 在回调中打印收到的命令
def _on_shadow_delta(self, topic, payload):
    delta = json.loads(payload.decode('utf-8'))
    print(f"Received delta: {delta}")
    command = delta.get('state', {})
    req_id = command.get('_reqId')
    print(f"Command: {command}, reqId: {req_id}")
```

### 5.4 ACK 机制

**问题**：命令执行后前端未确认

**解决方案**：
设备在执行命令后必须更新 Shadow，包含 `lastAckedReqId`：

```python
# 执行命令后发送 ACK
def execute_command(self, req_id, command):
    # 执行实际命令逻辑
    if command.get('action') == 'set_threshold':
        self.vibration_threshold = command.get('vibration_threshold')

    # 发送 ACK
    ack_state = {
        'lastAckedReqId': req_id,  # ⚠️ 关键：包含 reqId
        'vibration_threshold': self.vibration_threshold,
        'timestamp': int(time.time())
    }
    self.update_shadow_reported(ack_state)
```

## 6. 数据格式参考

### 6.1 遥测数据格式

```json
{
  "state": {
    "reported": {
      "deviceId": "09aa8ad8-f23e-4e75-bcbe-332efeb431ce",
      "gatewayId": "435204e6-21c9-447d-ab6f-888c99b91926",
      "battery": 95,
      "status": "ok",
      "vibration_detected": false,
      "vibration_level": 2.3,
      "threshold": 5.0,
      "sensitivity": "high",
      "event_count": 3,
      "last_trigger_time": 1702900000,
      "timestamp": 1702900060
    }
  }
}
```

### 6.2 命令格式 (Delta)

```json
{
  "version": 42,
  "timestamp": 1702900100,
  "state": {
    "action": "set_threshold",
    "vibration_threshold": 3.0,
    "sensitivity": "medium",
    "_reqId": "cmd_1702900100_abc123",
    "_priority": "normal"
  }
}
```

### 6.3 ACK 响应格式

```json
{
  "state": {
    "reported": {
      "lastAckedReqId": "cmd_1702900100_abc123",
      "vibration_threshold": 3.0,
      "sensitivity": "medium",
      "timestamp": 1702900105
    }
  }
}
```

## 7. 参考资料

- [PestGG IoT 系统架构](/IOT_SYSTEM_ARCHITECTURE.md) - 完整系统设计文档
- [AWS IoT Device Shadow 文档](https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html)
- [MQTT QoS 说明](https://docs.aws.amazon.com/iot/latest/developerguide/mqtt.html)
